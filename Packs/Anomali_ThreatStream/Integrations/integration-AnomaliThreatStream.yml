category: Data Enrichment & Threat Intelligence
commonfields:
  id: Anomali ThreatStream
  version: -1
configuration:
- defaultvalue: https://api.threatstream.com
  display: Server URL (e.g. https://192.168.0.1)
  name: server
  required: true
  type: 0
- defaultvalue: ''
  display: Username
  name: username
  required: false
  type: 0
- defaultvalue: ''
  display: API Key
  name: apikey
  required: false
  type: 4
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Use Anomali ThreatStream to query and submit threats
display: Anomali ThreatStream
image: data:image/png;base64,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
name: Anomali ThreatStream
script:
  commands:
  - arguments:
    - defaultValue: '20'
      description: limit the amount of records in response
      name: limit
    - description: "Autonomous System (AS)\_number associated with the indicator"
      name: asn
    - description: Confidence value assigned to the indicator
      name: confidence
    - description: Country associated with the indicator
      name: country
    - description: When the indicator was first seen on the ThreatStream cloud platform.
        For example, 2014-10-02T20:44:35
      name: created_ts
    - description: Time stamp of when intelligence will expire on ThreatStream, in
        UTC time
      name: expiration_ts
    - description: Numeric ID of the threat feed that generated the indicator
      name: feed_id
    - description: Unique ID for the indicator
      name: id
    - description: "ID\_of import session in which the indicator was imported"
      name: import_session_ id
    - description: "The IP\_address associated with the indicator if the imported\
        \ indicator is a domain or a URL"
      name: ip
    - description: "Classification of the indicator\u2014public or private"
      name: is_public
    - description: Indicator type
      name: itype
    - description: Latitude associated with the Geo location of the IP
      name: latitude
    - description: Longitude associated with the Geo location of the IP
      name: longitude
    - description: A string that contains a tag associated with the indicator; the
        tag can be used to search for related indicators
      name: meta.detail
    - description: Additional details associated with state of an indicator. For example,
        details such as why is an indicator marked false positive
      name: meta.detail2
    - description: Tag that specifies the malware associated with an indicator
      name: meta.maltype
    - description: Severity assigned to the indicator through machine-learning algorithms
        ThreatStream deploys
      name: meta.severity
    - description: When the indicator was last updated on the ThreatStream cloud platform
      name: modified_ts
    - description: "Registered owner (organization)\_of the IP\_address associated\
        \ with the indicator"
      name: org
    - description: ID of the (ThreatStream)organization that brought in the indicator,
        either through a threat feed or through the import process
      name: owner_ organization_id
    - description: Domain name (obtained through reverse domain name lookup) associated
        with the IP address that is associated with the indicator
      name: rdns
    - description: A risk score from 0 to 100, provided by the source of the indicator
      name: source_reported_ confidence
    - description: Status assigned to the indicator
      name: status
    - description: Tag assigned to the indicator
      name: tags.name
    - description: Summarized threat type of the indicator. For example, malware,
        compromised, apt, c2, and so on
      name: threat_type
    - description: IDs of the trusted circles with which the indicator is shared
      name: trusted_circle_ids
    - description: "Type of indicator\u2014domain, email, ip, md5, string, url"
      name: type
    - description: An incrementing numeric identifier associated with each update
        to intelligence on ThreatStream
      name: update_id
    - description: Value of the indicator
      name: value
    description: To retrieve threat intelligence from the ThreatStream cloud
    name: threatstream-intelligence
    outputs:
    - contextPath: DBotScore.Indicator
      description: The tested indicator
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
  - arguments:
    - description: The domain name to check
      name: domain
      required: true
    - defaultValue: '3'
      description: If ThreatScore is greater or equal than the threshold, then domain
        will be considered malicious
      name: threshold
    description: Checks the reputation of the given IP or domain name
    name: domain
    outputs:
    - contextPath: DBotScore.Indicator
      description: The tested indicator
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: Domain.DNS
      description: Domain IP Address
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Score
      description: A value assigned to the indicator through machine-learning algorithms
        ThreatStream deploys. Higher the threatscore, higher the risk. Threatscore
        ranges from 0-100, in increasing order of risk.
    - contextPath: IP.Address
      description: Domain IP Address
    - contextPath: IP.Geo.Country
      description: Country associated with the indicator.
    - contextPath: IP.Geo.Location
      description: Longitude and Latitude of the IP address
    - contextPath: IP.Geo.Organization
      description: "Registered owner (organization)\_of the IP\_address associated\
        \ with the indicator."
    - contextPath: IP.Hostname
      description: Domain name (obtained through reverse domain name lookup) associated
        with the IP address that is associated with the indicator.
    - contextPath: IP.Malicious.Vendor
      description: Usually an obfuscated description of the source of the indicator;
        the description may not be obfuscated if the user belongs to your organization.
    - contextPath: IP.Score
      description: A value assigned to the indicator through machine-learning algorithms
        ThreatStream deploys. Higher the threatscore, higher the risk. Threatscore
        ranges from 0-100, in increasing order of risk.
  - arguments:
    - description: The checksum to check
      name: file
      required: true
    - defaultValue: '3'
      description: If ThreatScore is greater or equal than the threshold, then file
        will be considered malicious
      name: threshold
    description: Checks the reputation of the given checksum
    name: file
    outputs:
    - contextPath: DBotScore.Indicator
      description: The tested indicator
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: File.MD5
      description: File MD5
    - contextPath: File.Malicious.Vendor
      description: Usually an obfuscated description of the source of the indicator;
        the description may not be obfuscated if the user belongs to your organization.
    - contextPath: File.Score
      description: A value assigned to the indicator through machine-learning algorithms
        ThreatStream deploys. Higher the threatscore, higher the risk. Threatscore
        ranges from 0-100, in increasing order of risk.
  - arguments:
    - description: The email address to check
      name: email
      required: true
    - defaultValue: '3'
      description: If ThreatScore is greater or equal than the threshold, then email
        will be considered malicious
      name: threshold
    description: Checks the reputation of the given email
    name: threatstream-email-reputation
    outputs:
    - contextPath: DBotScore.Indicator
      description: The tested indicator
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: ThreatStream.EmailReputation.Itype
      description: The indicator type.
    - contextPath: ThreatStream.EmailReputation.Created
      description: When the indicator was first seen on the ThreatStream cloud platform.
        For example, 2014-10-02T20:44:35
    - contextPath: ThreatStream.EmailReputation.Modified
      description: When the indicator was last updated on the ThreatStream cloud platform
    - contextPath: ThreatStream.EmailReputation.Confidence
      description: Confidence value assigned to the indicator. Confidence score can
        range from 0-100, in increasing order of confidence.
    - contextPath: ThreatStream.EmailReputation.Details1
      description: A string that contains a tag associated with the indicator; the
        tag can be used to search for related indicators.
    - contextPath: ThreatStream.EmailReputation.Details2
      description: Additional details associated with state of an indicator. For example,
        details such as why is an indicator marked false positive.
    - contextPath: ThreatStream.EmailReputation.Status
      description: Status assigned to the indicator
    - contextPath: ThreatStream.EmailReputation.ThreatScore
      description: A value assigned to the indicator through machine-learning algorithms
        ThreatStream deploys. Higher the threatscore, higher the risk. Threatscore
        ranges from 0-100, in increasing order of risk.
    - contextPath: ThreatStream.EmailReputation.Email
      description: The email address
    - contextPath: ThreatStream.EmailReputation.Severity
      description: 'Severity assigned to the indicator through machine-learning algorithms
        ThreatStream deploys. Possible values: low, medium, high, very high'
  - arguments:
    - description: The IP to check
      name: ip
      required: true
    - defaultValue: '3'
      description: If ThreatScore is greater or equal than the threshold, then ip
        will be considered malicious
      name: threshold
    description: Checks the reputation of the given IP
    name: ip
    outputs:
    - contextPath: DBotScore.Indicator
      description: The tested indicator
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: IP.ASN
      description: Autonomous System (AS) number associated with the indicator
    - contextPath: IP.Address
      description: IP Address
    - contextPath: IP.Geo.Country
      description: Country associated with the indicator.
    - contextPath: IP.Geo.Organization
      description: "Registered owner (organization)\_of the IP\_address associated\
        \ with the indicator."
    - contextPath: IP.Geo.Location
      description: Longitude and Latitude of the IP address
    - contextPath: IP.Malicious.Vendor
      description: Usually an obfuscated description of the source of the indicator;
        the description may not be obfuscated if the user belongs to your organization.
    - contextPath: IP.Score
      description: A value assigned to the indicator through machine-learning algorithms
        ThreatStream deploys. Higher the threatscore, higher the risk. Threatscore
        ranges from 0-100, in increasing order of risk.
    - contextPath: IP.Hostname
      description: Domain name (obtained through reverse domain name lookup) associated
        with the IP address that is associated with the indicator.
  - arguments:
    - defaultValue: '100'
      description: To use your source's confidence entirely, set source_confidence_
        weight to 100.
      name: confidenceWeight
      required: true
    - description: indicator value (1.2.3.4/google.com etc)
      name: indicator
      required: true
    - auto: PREDEFINED
      description: type of indicator to insert
      name: indicatorType
      predefined:
      - srcip
      - domain
      - url
      - email
      - md5
      required: true
    - auto: PREDEFINED
      description: indicator type (internal by threat stream, complete list can be
        found in API docs)
      name: itype
      predefined:
      - bot_ip
      - mal_domain
      - mal_url
      - compromised_email
      - apt_md5
      required: true
    - auto: PREDEFINED
      defaultValue: private
      description: "Classification of the indicator\u2014public or private"
      name: classification
      predefined:
      - public
      - private
      required: true
    - defaultValue: '100'
      description: Level of certainty that an observable is of the reported indicator
        type. Confidence score can range from 0-100, in increasing order of confidence
      name: confidence
      required: true
    - defaultValue: '100'
      description: 'Severity you want to assign to the indicator when it is imported.
        Possible values: low, medium, high, very-high'
      name: severity
      required: true
    description: Push indicator into ThreatStream
    name: threatstream-push-indicator
  runonce: false
  script: "var BASE_URL = params.server.replace(/[\\/]+$/, '') + '/api/';\nvar USERNAME\
    \ = params.username;\nvar API_KEY = params.apikey;\n\nvar commandDict = {\n  \
    \  'test-module': {\n        method: 'GET',\n        url: 'intelligence/',\n \
    \       version: 'v2',\n    },\n    'threatstream-intelligence': {\n        method:\
    \ 'GET',\n        url: 'intelligence/',\n        version: 'v2',\n    },\n    'threatstream-import':\
    \ {\n        method: 'PATCH',\n        url: 'intelligence/',\n        version:\
    \ 'v1',\n        headers: { 'Content-Type': ['application/json'] }\n    }\n};\n\
    \n\nfunction sendRequest (method, url, version, args, headers, multipart) {\n\
    \    var fullurl = BASE_URL + version + '/' + url;\n    if (method === 'GET')\
    \ {\n        args.username = USERNAME;\n        args.api_key = API_KEY;\n    \
    \    fullurl += encodeToURLQuery(args);\n    } else {\n        var cred = {\n\
    \            username: USERNAME,\n            api_key: API_KEY\n        };\n \
    \       fullurl += encodeToURLQuery(cred);\n    }\n    var res = !multipart ?\n\
    \        http(\n            fullurl,\n            {\n                Method: method,\n\
    \                Headers: headers,\n                Body: method !== 'GET' ? JSON.stringify(args)\
    \ : '',\n            },\n            params.insecure,\n            params.proxy\n\
    \        ) :\n        httpMultipart(\n            fullurl,\n            args.file_id,\n\
    \            {\n                Method: method,\n                Headers: headers,\n\
    \            },\n            args,\n            params.insecure,\n           \
    \ params.proxy\n        );\n\n    if (res.StatusCode < 200 || res.StatusCode >=\
    \ 300) {\n        if (res.StatusCode === 404) {\n            return undefined;\n\
    \        }\n        if (res.StatusCode === -1) {\n            throw res.Status;\n\
    \        }\n        var urlWithoutApiKey = fullurl.replace(API_KEY, '*******');\n\
    \        throw 'Failed to reach ' + urlWithoutApiKey + ' , request status code:\
    \ ' + res.StatusCode + ' and Body: ' + res.Body + '.';\n    }\n\n    if (res.Body)\
    \ {\n        return JSON.parse(res.Body);\n    } else {\n        return JSON.parse(JSON.stringify(res));\n\
    \    }\n}\n\n\nfunction buildEmptyEntryContext() {\n    return {Type: entryTypes.note,\
    \ Contents: null, ContentsFormat: formats.json, EntryContext: {}};\n}\n\n\nfunction\
    \ isStandardCommand(command) {\n    return (command == 'ip' || command == 'file'\
    \ || command == 'domain');\n}\n\n\nfunction fillReputationOutput(command, object)\
    \ {\n    var output = {};\n    output['Confidence'] = object.confidence;\n   \
    \ output['Severity'] = object.meta.severity;\n    output['Created'] = object.created_ts;\n\
    \    output['Modified'] = object.modified_ts;\n    output['itype'] = object.itype;\n\
    \    output['Source'] = object.source;\n    output['Status'] = object.status;\n\
    \    output['Threat Score'] = object.threatscore;\n    if (command == 'ip' ||\
    \ command == 'domain') {\n        if (object.asn) {\n            output['ASN']\
    \ = object.asn;\n        }\n        output['Country'] = object.country;\n    \
    \    output['Latitude'] = object.latitude;\n        output['Longitude'] = object.longitude;\n\
    \        output['Organization'] = object.org;\n        output['IP Address'] =\
    \ object.ip;\n        if (command == 'ip') {\n            output['Hostname'] =\
    \ object.rdns;\n        }\n    }\n    output['Details'] = '';\n    if (object.meta.detail\
    \ !== undefined) {\n        output['Details'] += object.meta.detail;\n       \
    \ if (object.meta.detail2 !== undefined) {\n            output['Details'] += '<br>'\
    \ + object.meta.detail;\n        }\n    } else {\n        if (object.meta.detail2\
    \ !== undefined) {\n            output['Details'] += object.meta.detail2;\n  \
    \      }\n    }\n    return output;\n}\n\n\nfunction createMapEntry(output) {\n\
    \    var mapEntry;\n    var lat = parseFloat(output.Latitude);\n    var lng =\
    \ parseFloat(output.Longitude);\n    if (!isNaN(lat) && !isNaN(lng)) {\n     \
    \   var location = {lat: parseFloat(output.Latitude), lng: parseFloat(output.Longitude)};\n\
    \        mapEntry = {Type: entryTypes.map, Contents: location, ContentsFormat:\
    \ formats.json};\n    }\n    return mapEntry;\n}\n\n\nfunction parseReputationResult(command,\
    \ result) {\n    var outputs = [];\n    var output = {};\n    var contexts = [];\n\
    \    var context = {};\n\n    var objects = dq(result, 'objects');\n    objects.sort(function(x,\
    \ y) {return x.created_ts < y.created_ts;});\n\n    for (var i = 0; i < objects.length;\
    \ i++) {\n        output = fillReputationOutput(command, objects[i]);\n      \
    \  if (!isStandardCommand(command)) {\n            context = convertKeysToPascalCase(output);\n\
    \            delete context.Details;\n            context.Details1 = objects[i].meta.detail;\n\
    \            context.Details2 = objects[i].meta.detail2;\n            context.Id\
    \ = objects[i].id;\n            context['Malware Type'] = objects[i].maltype;\n\
    \            if (command == 'threatstream-email-reputation') {\n             \
    \   context.Email = args.value;\n            }\n            contexts.push(context);\n\
    \        }\n        outputs.push(output);\n    }\n\n    // create human readable\n\
    \    var entry = buildEmptyEntryContext();\n    entry.Contents = result;\n   \
    \ entry.ContentsFormat = formats.json;\n    var commandTitle = isStandardCommand(command)\
    \ ? command : (command.slice(command.indexOf('-', 0) + 1, command.indexOf('-',\
    \ 'threatstream'.length + 1)));\n    commandTitle = commandTitle[0].toUpperCase()\
    \ + commandTitle.slice(1);\n    entry.HumanReadable = tblToMd('Anomali ThreatStream\
    \ ' + commandTitle + ' Reputation: ' + args.value, outputs);\n\n    // set the\
    \ context according to the newest data\n    output = outputs[0];\n    var contextKey;\n\
    \    if (isStandardCommand(command) && output && typeof output === 'object' &&\
    \ !isObjectEmpty(output)) {\n        if (command == 'ip' || command == 'domain')\
    \ {\n            var ipContext = {};\n            if (output.ASN !== undefined)\
    \ {\n                ipContext.ASN = output.ASN;\n            }\n            ipContext.Geo\
    \ = {};\n            ipContext.Geo.Country = output['Country'];\n            ipContext.Geo.Organization\
    \ = output['Organization'];\n            ipContext.Geo.Location = output['Latitude']\
    \ + ', ' + output['Longitude'];\n            ipContext.Hostname = output['Hostname'];\n\
    \            if (output['Threat Score'] >= args.threshold && output['Status']\
    \ !== 'falsepos') {\n                ipContext.Malicious = {};\n             \
    \   ipContext.Malicious.Vendor = output['Source'];\n            }\n          \
    \  ipContext.Address = output['IP Address'];\n            ipContext.Score = output['Threat\
    \ Score'];\n            if (command == 'domain') {\n                context.Name\
    \ = args.value;\n                context.DNS = output['IP Address'];\n       \
    \         context.Score = output['Threat Score']\n                entry.EntryContext['Domain']\
    \ = context;\n            }\n            entry.EntryContext['IP'] = ipContext;\n\
    \n        } else if (command == 'file' && output['Status'] !== 'falsepos') {\n\
    \            context.MD5 = args.value;\n            if (output['Threat Score']\
    \ >= args.threshold) {\n                context.Malicious = {};\n            \
    \    context.Malicious.Vendor = output['Source'];\n            }\n           \
    \ context.Score = output['Threat Score']\n            entry.EntryContext['File']\
    \ = context;\n        }\n        if (command == 'ip' || command == 'domain') {\n\
    \            var mapEntry = createMapEntry(output);\n        }\n    } else {\n\
    \        contextKey = 'ThreatStream.' + commandTitle + 'Reputation';\n       \
    \ entry.EntryContext[contextKey] = contexts;\n    }\n    var dbotScore = 1;\n\
    \    if (output['Threat Score'] >= args.threshold && output['Status'] !== 'falsepos')\
    \ {\n        dbotScore = 3;\n    } else if (output['Threat Score'] > 0 && output['Status']\
    \ !== 'falsepos') {\n        dbotScore = 2;\n    }\n    entry.EntryContext.DBotScore\
    \ = {\n        Indicator: args.value,\n        Type: args.type,\n        Vendor:\
    \ 'ThreatStream',\n        Score: dbotScore\n    };\n    var entries = [entry];\n\
    \    if (mapEntry) {\n        entries.push(mapEntry);\n    }\n    return entries;\n\
    }\n\n\nfunction isObjectEmpty (obj) {\n    return Object.keys(obj).length ===\
    \ 0;\n}\n\n\nfunction parseResult(command, result) {\n    if(result && !(isObjectEmpty(result))\
    \ && !(result['objects'] instanceof Array)){\n        result['objects'] = [result['objects']];\n\
    \    }\n    if (dq(result, 'objects').length === 0) {\n        return 'Anomali\
    \ ThreatStream - No records found.';\n    }\n    var entry;\n    switch (command)\
    \ {\n        case 'ip':\n        case 'file':\n        case 'domain':\n      \
    \  case 'threatstream-email-reputation':\n        case 'threatstream-checksum-reputation':\n\
    \            entry = parseReputationResult(command, result);\n            break;\n\
    \        case 'threatstream-push-indicator':\n            entry = result;\n  \
    \          break;\n        default:\n            entry = result;\n    }\n    return\
    \ entry;\n}\n\n\nvar apiCommand = command;\nswitch (command) {\n    case 'ip':\n\
    \        apiCommand = 'threatstream-intelligence';\n        args.type = 'ip';\n\
    \        args.value = args.ip;\n        delete args.ip;\n        break;\n    case\
    \ 'file':\n        apiCommand = 'threatstream-intelligence';\n        args.type\
    \ = 'md5';\n        args.value = args.file;\n        delete args.checksum;\n \
    \       break;\n    case 'domain':\n        apiCommand = 'threatstream-intelligence';\n\
    \        args.type = 'domain';\n        args.value = args.domain;\n        delete\
    \ args.domain;\n        break;\n    case 'threatstream-email-reputation':\n  \
    \      apiCommand = 'threatstream-intelligence';\n        args.type = 'email';\n\
    \        args.value = args.email;\n        delete args.email;\n        break;\n\
    \    case 'threatstream-file-reputation':\n        apiCommand = 'threatstream-intelligence';\n\
    \        args.type = 'md5';\n        args.value = args.file_md5;\n        delete\
    \ args.md5;\n        break;\n    case 'threatstream-push-indicator':\n       \
    \ apiCommand = 'threatstream-import';\n        args = { \"meta\": { \"source_confidence_weight\"\
    : args.confidenceWeight }, \"objects\": [ {\n            \"args.indicatorType\"\
    : args.indicator,\n            \"classification\": args.classification,\n    \
    \        \"itype\": args.itype,\n            \"confidence\": args.confidence,\n\
    \            \"severity\": args.severity } ] };\n        break;\n}\n\nvar commandData\
    \ = commandDict[apiCommand];\nvar result = sendRequest(\n    commandData.method,\n\
    \    replaceInTemplatesAndRemove(commandData.url, args),\n    commandData.version,\n\
    \    args,\n    commandData.headers,\n    commandData.multipart\n);\n\nif (command\
    \ === 'test-module') {\n    return 'ok';\n}\n\nif (result && result.meta && result.meta.next)\
    \ {\n    // hide the api key\n    result.meta.next = result.meta.next.replace(API_KEY,\
    \ '*******');\n}\n\nreturn parseResult(command, result);"
  type: javascript
tests:
- Anomali_ThreatStream_Test
toversion: 4.1.9
