category: Data Enrichment & Threat Intelligence
commonfields:
  id: MISP
  version: -1
configuration:
- defaultvalue: ''
  display: Server URL (e.g. https://192.168.0.1)
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: API Key
  name: api_key
  required: true
  type: 4
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
deprecated: true
description: Malware Information Sharing Platform and Threat Sharing (This integration
  is deprecated, use MISP V2 instead)
display: MISP (Deprecated)
fromversion: 4.1.0
image: data:image/png;base64,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
name: MISP
script:
  commands:
  - arguments:
    - description: File name
      name: filename
      required: true
    - description: File Content in Base64
      name: fileContent
      required: true
    - description: The Event's ID is optional. It can be either supplied via the URL
        or the POSTed object, but the URL has priority if both are provided. Not supplying
        an event ID will cause MISP to create a single new event for all of the POSTed
        malware samples. You can define the default settings for the event, otherwise
        a set of default settings will be used.
      name: event_id
    - description: The distribution setting used for the attributes and for the newly
        created event, if relevant. [0-3]
      name: distribution
    - description: You can flag all attributes created during the transaction to be
        marked as "to_ids" or not.
      name: to_ids
    - description: 'The category that will be assigned to the uploaded samples. Valid
        options are: Payload delivery, Artifacts dropped, Payload Installation, External
        Analysis.'
      name: category
    - description: Used to populate the event info field if no event ID supplied.
        Alternatively, if not set, MISP will simply generate a message showing that
        it's a malware sample collection generated on the given day.
      name: info
    - description: 'The analysis level of the newly created event, if applicable.
        [0-2] threat_level_id: The threat level ID of the newly created event, if
        applicatble. [0-3]'
      name: analysis
    - description: This will populate the comment field of any attribute created using
        this API.
      name: comment
    deprecated: true
    description: Upload file sample to MISP
    execution: true
    name: internal-misp-upload-sample
  - arguments:
    - description: The attribute type, any valid MISP attribute type is accepted
      name: type
    - description: Search for the given value in the attributes' value field.
      name: value
    - description: The attribute category, any valid MISP attribute category is accepted.
      name: category
    - description: Search by the creator organisation by supplying the organisation
        identifier.
      name: org
    - description: To include a tag in the results just write its names into this
        parameter. To exclude a tag prepend it with a '!'. You can also chain several
        tag commands together with the '&&' operator. Please be aware the colons (:)
        cannot be used in the tag search. Use semicolons instead (the search will
        automatically search for colons instead).
      name: tags
    - description: 'Events with the date set to a date after the one specified in
        the from field (format: 2015-02-15). This filter will use the date of the
        event.'
      name: from
    - description: 'Events with the date set to a date before the one specified in
        the to field (format: 2015-02-15). This filter will use the date of the event.'
      name: to
    - description: Events published within the last x amount of time, where x can
        be defined in days, hours, minutes (for example 5d or 12h or 30m). This filter
        will use the published timestamp of the event.
      name: last
    - description: The events that should be included / excluded from the search.
      name: eventid
    - description: The returned events must include an attribute with the given UUID,
        or alternatively the event's UUID must match the value(s) passed.
      name: uuid
    deprecated: true
    description: Search for events in misp
    name: misp-search
    outputs:
    - contextPath: MISP.Event.ID
      description: Event ID
    - contextPath: MISP.Event.Date
      description: Date
    - contextPath: MISP.Event.ThreatLevelID
      description: Threat Level ID
    - contextPath: MISP.Event.info
      description: info
    - contextPath: MISP.Event.Published
      description: Published
    - contextPath: MISP.Event.UUID
      description: UUID
    - contextPath: MISP.Event.Analysis
      description: Analysis
    - contextPath: MISP.Event.Timestamp
      description: Timestamp
    - contextPath: MISP.Event.Distribution
      description: Distribution
    - contextPath: MISP.Event.ProposalEmailLock
      description: Proposal Email Lock
    - contextPath: MISP.Event.Locked
      description: Locked
    - contextPath: MISP.Event.PublishTimestamp
      description: Publish Timestamp
    - contextPath: MISP.Event.SharingGroupID
      description: Sharing Group ID
    - contextPath: MISP.Event.DisableCorrelation
      description: Disable Correlation
    - contextPath: MISP.Event.EventCreatorEmail
      description: Event Creator Email
    - contextPath: MISP.Event.Organisation.ID
      description: Organisation ID
    - contextPath: MISP.Event.Organisation.Name
      description: Organisation Name
    - contextPath: MISP.Event.Organisation.UUID
      description: Organisation UUID
    - contextPath: MISP.Event.OwnerOrganisation.ID
      description: Owner Organisation ID
    - contextPath: MISP.Event.OwnerOrganisation.Name
      description: Owner Organisation Name
    - contextPath: MISP.Event.OwnerOrganisation.UUID
      description: Owner Organisation UUID
    - contextPath: MISP.Event.Attribute
      description: Attribute
    - contextPath: MISP.Event.ShadowAttribute
      description: ShadowAttribute
    - contextPath: MISP.Event.RelatedEvent
      description: RelatedEvent
  - arguments:
    - description: Hash of the file to query. Supports MD5, SHA1 and SHA256. Notice         that
        you can pass comma-separated multiple values to efficiently retrieve multiple
        responses.
      name: file
      required: true
    deprecated: true
    description: Check file reputation of the given hash
    name: file
    outputs:
    - contextPath: File.MD5
      description: Bad hash found
    - contextPath: File.SHA1
      description: Bad hash SHA1
    - contextPath: File.SHA256
      description: Bad hash SHA256
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
  - arguments:
    - description: URL to be checked
      name: url
      required: true
    deprecated: true
    description: Check if url is in MISP events
    name: url
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
  - arguments:
    - description: IP address to check
      name: ip
      required: true
    deprecated: true
    description: Check IP Reputation
    name: ip
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
  - arguments:
    - description: 'A hash in MD5 format. If allSamples is set, this can be any one
        of the following: md5, sha1, sha256.'
      name: hash
      required: true
    - description: If set, it will only fetch data from the given event ID.
      name: eventID
    - auto: PREDEFINED
      description: If set, it will return all samples from events that have a match
        for the hash provided above.
      name: allSamples
      predefined:
      - '1'
      - '0'
    deprecated: true
    description: Download malware sample by hash
    name: internal-misp-download-sample
  - arguments:
    - description: Type of the event
      name: type
    - defaultValue: External analysis
      description: Category of the event
      name: category
    - auto: PREDEFINED
      defaultValue: 'false'
      description: Do it to ids
      name: to_ids
      predefined:
      - 'true'
      - 'false'
    - defaultValue: '0'
      description: To where distribute
      name: distribution
    - description: Comment
      name: comment
    - description: Value to add
      name: value
      required: true
    - default: true
      description: Event name
      name: info
      required: true
    - auto: PREDEFINED
      defaultValue: 'false'
      description: Publish the event
      name: published
      predefined:
      - 'false'
      - 'true'
    - defaultValue: '1'
      description: MISP Threat level id
      name: threat_level_id
    deprecated: true
    description: Create new MISP event
    name: internal-misp-create-event
    outputs:
    - contextPath: MISP.ID
      description: MISP event ID
  - arguments:
    - description: MISP event id
      name: id
      required: true
    - description: Type of the attribute
      name: type
      required: true
    - description: Category of the attribute
      name: category
      required: true
    - auto: PREDEFINED
      defaultValue: '1'
      description: Add attribute to ids
      name: to_ids
      predefined:
      - '1'
      - '0'
    - description: ' To where distribute'
      name: distribution
    - description: Name of the attribute
      name: comment
      required: true
    - description: Value of the attribute
      name: value
      required: true
    deprecated: true
    description: Add attribute to existing MISP event
    name: internal-misp-add-attribute
  script: "var entitiesDict = {\n    event: [\n            {to: 'ID', from: 'id'},\n\
    \            {to: 'Date', from: 'date'},\n            {to: 'ThreatLevelID', from:\
    \ 'threat_level_id'},\n            {to: 'info', from: 'info'},\n            {to:\
    \ 'Published', from: 'published'},\n            {to: 'UUID', from: 'uuid'},\n\
    \            {to: 'Analysis', from: 'analysis'},\n            {to: 'Timestamp',\
    \ from: 'timestamp'},\n            {to: 'Distribution', from: 'distribution'},\n\
    \            {to: 'ProposalEmailLock', from: 'proposal_email_lock'},\n       \
    \     {to: 'Locked', from: 'locked'},\n            {to: 'PublishTimestamp', from:\
    \ 'publish_timestamp'},\n            {to: 'SharingGroupID', from: 'sharing_group_id'},\n\
    \            {to: 'DisableCorrelation', from: 'disable_correlation'},\n      \
    \      {to: 'EventCreatorEmail', from: 'event_creator_email'},\n            {to:\
    \ 'Organisation.ID', from: 'Org.id'},\n            {to: 'Organisation.Name', from:\
    \ 'Org.name'},\n            {to: 'Organisation.UUID', from: 'Org.uuid'},\n   \
    \         {to: 'OwnerOrganisation.ID', from: 'Orgc.id'},\n            {to: 'OwnerOrganisation.Name',\
    \ from: 'Orgc.name'},\n            {to: 'OwnerOrganisation.UUID', from: 'Orgc.uuid'},\n\
    \            {to: 'Attribute', from: 'Attribute'},\n            {to: 'ShadowAttribute',\
    \ from: 'ShadowAttribute'},\n            {to: 'RelatedEvent', from: 'RelatedEvent'},\n\
    \        ],\n        attribute:\n        [\n            {to: 'ID', from: 'id'},\n\
    \            {to: 'Type', from: 'type'},\n            {to: 'Category', from: 'category'},\n\
    \            {to: 'ToIDs', from: 'to_ids'},\n            {to: 'UUID', from: 'uuid'},\n\
    \            {to: 'EventID', from: 'event_id'},\n            {to: 'Distribution',\
    \ from: 'distribution'},\n            {to: 'Timestamp', from: 'timestamp'},\n\
    \            {to: 'Comment', from: 'comment'},\n            {to: 'SharingGroupID',\
    \ from: 'sharing_group_id'},\n            {to: 'Deleted', from: 'deleted'},\n\
    \            {to: 'DisableCorrelation', from: 'disable_correlation'},\n      \
    \      {to: 'Value', from: 'value'},\n            {to: 'ShadowAttribute', from:\
    \ 'ShadowAttribute'},\n            ],\n        shadowAttribute: [\n          \
    \  {to: 'ID', from: 'id'},\n            {to: 'Type', from: 'type'},\n        \
    \    {to: 'Category', from: 'category'},\n            {to: 'ToIDs', from: 'to_ids'},\n\
    \            {to: 'UUID', from: 'uuid'},\n            {to: 'EventUUID', from:\
    \ 'event_uuid'},\n            {to: 'EventID', from: 'event_id'},\n           \
    \ {to: 'OldID', from: 'old_id'},\n            {to: 'Distribution', from: 'distribution'},\n\
    \            {to: 'Timestamp', from: 'timestamp'},\n            {to: 'Comment',\
    \ from: 'comment'},\n            {to: 'OrganisationID', from: 'org_id'},\n   \
    \         {to: 'SharingGroupID', from: 'sharing_group_id'},\n            {to:\
    \ 'ProposalToDelete', from: 'proposal_to_delete'},\n            {to: 'DisableCorrelation',\
    \ from: 'disable_correlation'},\n            {to: 'Value', from: 'value'},\n \
    \           {to: 'OwnerOrganisation.ID', from: 'Orgc.id'},\n            {to: 'OwnerOrganisation.Name',\
    \ from: 'Orgc.name'},\n            {to: 'OwnerOrganisation.UUID', from: 'Orgc.uuid'},\n\
    \            ],\n        relatedEvent: [\n            {to: 'ID', from: 'id'},\n\
    \            ]\n};\n\nvar commands = {\n        'misp-download-sample': {\n  \
    \          url: '/attributes/downloadSample/',\n            title: '',\n     \
    \       args: ['hash','allSamples','eventID', 'filename'],\n            contextKey:\
    \ '',\n        },\n        'internal-misp-upload-sample': {\n            url:\
    \ '/events/upload_sample/',\n            title: 'MISP upload sample',\n      \
    \      args: ['distribution','to_ids','category','info','analysis','comment'],\n\
    \            contextKey: '',\n        },\n        'internal-misp-create-event':\
    \ {\n            url: '/events',\n            title: 'MISP create event',\n  \
    \          args: ['type','category','to_ids','distribution','comment','value'],\n\
    \            contextKey: '',\n        },\n        'internal-misp-download-sample':\
    \ {\n            url: '/attributes/downloadSample',\n            title: '',\n\
    \            args: ['hash','eventID','allSamples'],\n            contextKey: '',\n\
    \        },\n        'misp-search': {\n            url: '/events/restSearch/download/',\n\
    \            title: 'Misp events search result:',\n            args: ['value','type','category','org','tags','from','to','last','eventid','uuid'],\n\
    \            ContentPath: 'response.Event',\n            contextKey: 'MISP.Event(val.UUID==obj.UUID)',\n\
    \        },\n        'file': '',\n        'url': '',\n        'ip':''\n};\n\n\
    function mapObjFunction(mapFields) {\n            var transformSingleObj= function(obj)\
    \ {\n                var res = {};\n                var fieldValue = '';\n   \
    \             mapFields.forEach(function(f) {\n                    fieldValue\
    \ = dq(obj, f.from);\n                    if (fieldValue){\n                 \
    \       var keys = f.to.split('.');\n                        switch (keys.length){\n\
    \                            case 1:\n                                res[keys[0]]\
    \ = fieldValue;\n                                break;\n                    \
    \        case 2:\n                                 if (!res[keys[0]]){\n     \
    \                               res[keys[0]] = {};\n                         \
    \       }\n                                res[keys[0]][keys[1]] = fieldValue;\n\
    \                                break;\n                            default:\n\
    \                            throw \"context target field [\" + f.to + \"] must\
    \ have 1-3 levels but have \" + keys.length;\n                        }\n    \
    \                }\n                });\n                return res;\n       \
    \     };\n            return function(obj) {\n                if (obj instanceof\
    \ Array) {\n                    var res = [];\n                    for (var j=0;\
    \ j < obj.length; j++) {\n                        res.push(transformSingleObj(obj[j]));\n\
    \                    }\n                    return res;\n                }\n \
    \               return transformSingleObj(obj);\n            };\n        }\n\n\
    \nfunction translateEvents(rawResponse, contextPath, title){\n    var ec = {};\n\
    \    if (rawResponse.response.length === 0) {\n        return {\n            Type:\
    \ entryTypes.note,\n            ContentsFormat: formats.json,\n            Contents:\
    \ rawResponse,\n            ReadableContentsFormat: formats.markdown,\n      \
    \      HumanReadable: '## ' + title + '\\n* No events found',\n            EntryContext:\
    \ ec\n        };\n    }\n\n    var returnObject = mapObjFunction(entitiesDict.event)(dq(rawResponse,'response.Event'));\n\
    \    if (Array.isArray(returnObject)) {\n            events = returnObject;\n\
    \        } else {\n            events = [returnObject];\n        }\n        for\
    \ (var i=0; i<events.length; i++) {\n            if(events[i].Attribute.length\
    \ > 0) {\n                events[i].Attribute = mapObjFunction(entitiesDict.attribute)(dq(events[i],'Attribute'));\n\
    \            }\n            if(events[i].ShadowAttribute.length > 0) {\n     \
    \           events[i].ShadowAttribute = mapObjFunction(entitiesDict.shadowAttribute)(dq(events[i],'ShadowAttribute'));\n\
    \            }\n            if(events[i].RelatedEvent.length > 0) {\n        \
    \        events[i].RelatedEvent = mapObjFunction(entitiesDict.relatedEvent)(dq(events[i],'RelatedEvent.Event'));\n\
    \            }\n        }\n        if (contextPath) {\n            ec[contextPath]\
    \ = events;\n        }\n        return {\n            Type: entryTypes.note,\n\
    \            ContentsFormat: formats.json,\n            Contents: rawResponse,\n\
    \            ReadableContentsFormat: formats.markdown,\n            HumanReadable:\
    \ tableToMarkdown(title, returnObject),\n            EntryContext: ec\n      \
    \  };\n}\n\nfunction getProvidedArgsForCommand(command, passedArgs) {\n    var\
    \ currentArgs = {};\n    var allArgs = commands[command].args;\n        for (var\
    \ j = 0; j < allArgs.length; j++){\n            if (passedArgs[allArgs[j]]){\n\
    \              currentArgs[allArgs[j]] = passedArgs[allArgs[j]];\n           \
    \ }\n        }\n    return currentArgs;\n}\n\nfunction getHashFormat(hash) {\n\
    \    switch(hash.length){\n        case 32:\n            return 'md5';\n     \
    \   case 40:\n            return 'sha1';\n        case 64:\n            return\
    \ 'sha256';\n        default:\n            throw \"invalid hash length, please\
    \ enter file hash of format md5, sha1 or sha256\";\n    }\n}\n\nfunction getMISPThreatLevelStr(threat_level_id)\
    \ {\n    switch(threat_level_id){\n        case '1':\n            return 'HIGH';\n\
    \        case '2':\n            return 'MEDIUM';\n        case '3':\n        \
    \    return 'LOW';\n        case '4':\n            return 'UNDEFINED';\n     \
    \   default:\n            return 'Invalid MISP Threat Level with threat_level_id:\
    \ ' + threat_level_id;\n    }\n}\n\n\nfunction doJSONPost(requestUrl, body) {\n\
    \    var res = http(\n        requestUrl,\n        {\n            Method: 'POST',\n\
    \            Headers: {\n                'Authorization': [params.api_key],\n\
    \                'Accept': ['application/json'],\n                'Content-Type':\
    \ ['application/json']\n            },\n            Body: JSON.stringify(body)\n\
    \        },\n        params.insecure,\n        params.proxy\n    );\n    if (res.StatusCode\
    \ < 200 || res.StatusCode >= 300) {\n        throw 'Request Failed.\\nStatus code:\
    \ ' + res.StatusCode + '.\\nBody: ' + JSON.stringify(res) + '.';\n    }\n    if\
    \ (res.Headers && res.Headers['Content-Type'] == 'application/json; charset=UTF-8')\
    \ {\n        return JSON.parse(res.Body);\n    }\n    throw 'Response content\
    \ type is not \\\"application/json; charset=UTF-8\\\" as expected.\\n response:\
    \ +' + JSON.stringify(res);\n}\n\nfunction doGeneralPost(command, passedArgs){\n\
    \    var currentArgs = getProvidedArgsForCommand(command, passedArgs);\n    var\
    \ requestUrl = params.url + commands[command].url;\n    var body = {'request':\
    \ currentArgs };\n    return doJSONPost(requestUrl, body);\n}\n\nfunction doFile(hash)\
    \ {\n        var hashFormat = getHashFormat(hash);\n        var res = doGeneralPost('misp-search',\
    \ {'value': hash});\n        if (res.response.length === 0) {\n            return\
    \ {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,\n\
    \                HumanReadable: 'No events found in MISP for hash: ' + hash +\
    \ '\\n'};\n        }\n        var events = dq(res,'response.Event');\n       \
    \ var r = [];\n        if (Array.isArray(events)) { // Got multiple hashes so\
    \ need to nicely iterate\n            r = events;\n        } else {\n        \
    \    r = [events];\n        }\n        var md = '## MISP Reputation for File'\
    \ + ': ' + hash + '\\n';\n        var ec = {};\n        ec.DBotScore = [];\n \
    \       ec[outputPaths.file] = [];\n        for (var i=0; i<r.length; i++) {\n\
    \            var mispOrganisation = 'MISP.' + r[i].Orgc.name;\n            var\
    \ dbotScore = 0;\n            if (r[i].threat_level_id <= 3) {\n             \
    \   dbotScore = 3;\n                var malFile = {};\n                var MaliciousFileObj\
    \ = {};\n                MaliciousFileObj[hashFormat.toUpperCase()] = hash;\n\
    \                MaliciousFileObj.Malicious = {Vendor: mispOrganisation, Description:\
    \ 'file hash found in MISP event with ID ' + r[i].id};\n                addMalicious(malFile,\
    \ outputPaths.file, MaliciousFileObj);\n                ec[outputPaths.file].push(malFile[outputPaths.file]);\n\
    \                ec.DBotScore.push({Indicator: hash, Type: 'hash', Vendor: mispOrganisation\
    \ , Score: dbotScore });\n            }\n            md += '* Found file hash\
    \ in MISP event: ' +  r[i].id + ' with MISP Threat Level: '+ getMISPThreatLevelStr(r[i].threat_level_id),\
    \ + 'from: '+  mispOrganisation + '\\n';\n            md += '\\n';\n        }\n\
    \        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,\
    \ HumanReadable: md, EntryContext: ec};\n    }\n\n\n\nfunction doURL(url) {\n\
    \        var res = doGeneralPost('misp-search', {'type': 'url', 'value': url});\n\
    \        if (res.response.length === 0) {\n            return {Type: entryTypes.note,\
    \ Contents: res.body, ContentsFormat: formats.json,\n                HumanReadable:\
    \ 'No events found in MISP for url: ' + url + '\\n'};\n        }\n        var\
    \ events = dq(res,'response.Event');\n        var r = [];\n        if (Array.isArray(events))\
    \ { // Got multiple hashes so need to nicely iterate\n            r = events;\n\
    \        } else {\n            r = [events];\n        }\n\n        var md = '##\
    \ MISP Reputation for URL' + ': ' + url + '\\n';\n        var ec = {};\n     \
    \   ec.DBotScore = [];\n        for (var i=0; i<r.length; i++) {\n           \
    \ var dbotScore = 0;\n            if (r[i].threat_level_id <= 3) {\n         \
    \       dbotScore = 3;\n               var mispOrganisation = 'MISP.' + r[i].Orgc.name;\n\
    \                addMalicious(ec, outputPaths.url, {\n                    Data:\
    \ url,\n                    Malicious: {Vendor: mispOrganisation, Description:\
    \ 'URL Found in MISP event: ' + r[i].id}\n                });\n              \
    \  ec.DBotScore.push({Indicator: url, Type: 'url', Vendor: mispOrganisation ,\
    \ Score: 3});\n            }\n            md += '* Found URL in MISP event: '\
    \ +  r[i].id + ' with MISP Threat Level: '+ getMISPThreatLevelStr(r[i].threat_level_id),\
    \ + 'from: '+  mispOrganisation + '\\n';\n            md += '\\n';\n        }\n\
    \        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,\
    \ HumanReadable: md, EntryContext: ec}\n    };\n\nfunction doIP(ip) {\n      \
    \  var res = doGeneralPost('misp-search', {'type': 'ip', 'value': ip});\n    \
    \    if (res.response.length === 0) {\n            return {Type: entryTypes.note,\
    \ Contents: res.body, ContentsFormat: formats.json,\n                HumanReadable:\
    \ 'No events found in MISP for IP: ' + ip + '\\n'};\n        }\n        var events\
    \ = dq(res,'response.Event');\n        var r = [];\n        if (Array.isArray(events))\
    \ { // Got multiple hashes so need to nicely iterate\n            r = events;\n\
    \        } else {\n            r = [events];\n        }\n\n        var md = '##\
    \ MISP Reputation for IP' + ': ' + ip + '\\n';\n        var ec = {};\n       \
    \ ec.DBotScore = [];\n        for (var i=0; i<r.length; i++) {\n            var\
    \ dbotScore = 0;\n            if (r[i].threat_level_id <= 3) {\n             \
    \   dbotScore = 3;\n               var mispOrganisation = 'MISP.' + r[i].Orgc.name;\n\
    \                addMalicious(ec, outputPaths.ip, {\n                    Address:\
    \ ip,\n                    Malicious: {Vendor: mispOrganisation, Description:\
    \ 'IP Found in MISP event: ' + r[i].id}\n                });\n               \
    \ ec.DBotScore.push({Indicator: ip, Type: 'ip', Vendor: mispOrganisation , Score:\
    \ 3});\n            }\n            md += '* Found IP in MISP event: ' +  r[i].id\
    \ + ' with MISP Threat Level: '+ getMISPThreatLevelStr(r[i].threat_level_id),\
    \ + 'from: '+  mispOrganisation + '\\n';\n            md += '\\n';\n        }\n\
    \        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,\
    \ HumanReadable: md, EntryContext: ec}\n    };\n\nfunction doUploadSample(command)\
    \ {\n    var fileContent = args['fileContent'];\n    var filename = args['filename'];\n\
    \    if (!fileContent) {\n        throw 'file \\\"'+ filename + '\\\" is empty\
    \ or missing';\n    }\n\n    var currentArgs = getProvidedArgsForCommand(command,\
    \ args)\n    currentArgs['data'] =  fileContent;\n    currentArgs['filename']\
    \ = filename;\n\n\n    var requestUrl = params.url + commands[command].url;\n\
    \    requestUrl = (args['event_id'])  ? requestUrl + args['event_id'] : requestUrl;\n\
    \n    var body = { 'request': { 'files': [currentArgs] } };\n    var res = doJSONPost(requestUrl,\
    \ body)\n    return {\n            Type: entryTypes.note,\n            ContentsFormat:\
    \ formats.json,\n            Contents: res,\n            ReadableContentsFormat:\
    \ formats.markdown,\n            HumanReadable: '## ' + commands[command].title\
    \ + '\\n* message: ' + res.message + '\\n* event id: ' + res.id + '\\n* file name:\
    \ ' + filename,\n            EntryContext: {}\n        };\n}\n\n\nvar addMinutes\
    \ = function(date, minutes) {\n            return new Date(date.getTime() + minutes*60000);\n\
    };\n\n\nvar getNowTime = function() {\n    var time = new Date();\n    time =\
    \ addMinutes(time,time.getTimezoneOffset());\n    var month = \"0\" + (time.getMonth()+1);\n\
    \    var day = \"0\" + time.getDate();\n    var dateOld = time.getFullYear()+'-'+month.substr(-2)+'-'+day.substr(-2);\n\
    \    return dateOld;\n};\n\n\nfunction createEvent(command) {\n    var currentArgs\
    \ = getProvidedArgsForCommand(command, args);\n    var ec = {};\n\n    if (currentArgs.to_ids\
    \ === 'true') {\n        currentArgs.to_ids = true;\n    } else {\n        currentArgs.to_ids\
    \ = false;\n    }\n\n    if (args.published === 'true') {\n        args.published\
    \ = true;\n    } else {\n        args.published = false;\n    }\n\n    var requestUrl\
    \ = params.url + commands[command].url;\n\n    var body = { 'Event': {\n     \
    \   'date': getNowTime(),\n        'threat_level_id': args.threat_level_id,\n\
    \        'published': args.published,\n        'info': args.info,\n        'analysis':\
    \ '0',\n        'distribution': '0',\n        'Attribute': [currentArgs] } };\n\
    \n    var res = doJSONPost(requestUrl, body);\n\n    var md = '## ' + commands[command].title\
    \ + '\\nNew event with id ' + res.Event.id + ' has been successfully created.\\\
    n';\n    ec = {'MISP.ID': res.Event.id};\n\n    return {\n            Type: entryTypes.note,\n\
    \            ContentsFormat: formats.json,\n            Contents: res,\n     \
    \       ReadableContentsFormat: formats.markdown,\n            HumanReadable:\
    \ md,\n            EntryContext: ec\n        };\n}\n\n\nfunction addAtribute(command)\
    \ {\n    var requestUrl = params.url + '/attributes/add/' + args.id;\n\n    var\
    \ body = { 'Attribute': {\n        'type': args.type,\n        'category': args.category,\n\
    \        'to_ids': args.to_ids,\n        'distribution': args.distribution,\n\
    \        'comment': args.comment,\n        'value': args.value} };\n\n    var\
    \ res = doJSONPost(requestUrl, body);\n\n    var md = '## ' + 'MISP add attribute'\
    \ + '\\nNew attribute: ' + args.value + ' was added to event id ' + res.Attribute.event_id\
    \ + '.\\n';\n\n    return {\n            Type: entryTypes.note,\n            ContentsFormat:\
    \ formats.json,\n            Contents: res,\n            ReadableContentsFormat:\
    \ formats.markdown,\n            HumanReadable: md,\n            EntryContext:\
    \ {}\n        };\n}\n\n\n\n// The command input arg holds the command sent from\
    \ the user.\nswitch (command) {\n    // This is the call made when pressing the\
    \ integration test button.\n    case 'test-module':\n        doIP('1.3.4.5');\n\
    \        return 'ok';\n    case 'internal-misp-upload-sample':\n        return\
    \ doUploadSample(command);\n    case 'internal-misp-download-sample':\n      \
    \  return doGeneralPost(command, args);\n    case 'internal-misp-create-event':\n\
    \        return createEvent(command);\n    case 'internal-misp-add-attribute':\n\
    \        return addAtribute(command)\n    case 'misp-search':\n        return\
    \ translateEvents(doGeneralPost(command, args), commands[command].contextKey,\
    \ commands[command].title);\n    case 'file':\n        return doFile(args.file)\n\
    \    case 'url':\n        return doURL(args.url)\n    case 'ip':\n        return\
    \ doIP(args.ip)\n    default:\n}\n\n"
  type: javascript
tests:
- No tests
toversion: 4.1.9
