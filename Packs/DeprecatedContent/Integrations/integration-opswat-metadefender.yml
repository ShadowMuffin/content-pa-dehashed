category: Data Enrichment & Threat Intelligence
commonfields:
  id: OPSWAT-Metadefender
  version: -1
configuration:
- defaultvalue: http://localhost:8008/metascan_rest/
  display: Server URL (e.g. http://localhost:8008/metascan_rest/)
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: API Key
  name: api
  required: false
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: '34'
  display: 'The low threshold '
  name: lowPercnt
  required: true
  type: 0
- defaultvalue: '66'
  display: 'The high threshold '
  name: highPercnt
  required: true
  type: 0
- defaultvalue: 'false'
  display: Cloud based
  name: cloud
  required: false
  type: 8
deprecated: true
description: At the heart of the solution, the Metadefender multi-scanning engine
  uses 30+ anti-malware engines to scan files for threats, significantly increasing
  malware detection.
display: OPSWAT-Metadefender (Deprecated)
image: data:image/png;base64,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
name: OPSWAT-Metadefender
script:
  commands:
  - arguments:
    - default: true
      description: File hash (Can be any hash type)
      name: hash
      required: true
    deprecated: true
    description: Check file hash on OPSWAT
    name: opswat-hash
  - arguments:
    - default: true
      description: Entry id of a file in Demisto
      name: fileId
      required: true
    deprecated: true
    description: Scan file in OPSWAT
    name: opswat-scan-file
    outputs:
    - contextPath: OPSWAT.FileName
      description: OPSWAT file name to scan
    - contextPath: OPSWAT.ScanId
      description: OPSWAT scan id of the scan
  - arguments:
    - default: true
      description: OPSWAT scan id
      name: id
      required: true
    deprecated: true
    description: Get OPSWAT result
    name: opswat-scan-result
  runonce: false
  script: "var sendRequest = function(url,param, fileId) {\n    if (params.url[params.url.length\
    \ - 1] !== '/') {\n        params.url += '/';\n    }\n    var requestUrl = params.url\
    \ + url + param;\n    var res;\n    if (params.cloud) {\n        if (fileId) {\n\
    \            var fileName = dq(invContext, 'File(val.EntryID == \\'' + fileId\
    \ + '\\').Name');\n            res = httpMultipart(\n                requestUrl,\n\
    \                fileId,\n                {\n                    Method: 'POST',\n\
    \                    Headers: {\n                        Accept: ['application/json'],\n\
    \                        filename: fileName,\n                        apikey:\
    \ [params.api]\n                    }\n                },\n                {},\n\
    \                params.insecure,\n                params.proxy,\n           \
    \     undefined,\n                'file',\n                fileName);\n      \
    \  } else {\n            res = http(\n                requestUrl,\n          \
    \      {\n                    Method: 'GET',\n                    Headers: {\n\
    \                        Accept: ['application/json'],\n                     \
    \   apikey: [params.api]\n                    }\n                }\n         \
    \       );\n            return res;\n        }\n    } else {\n        if (fileId)\
    \ {\n            var fileName = dq(invContext, 'File(val.EntryID == \\'' + fileId\
    \ + '\\').Name');\n            res = httpMultipart(\n                requestUrl,\n\
    \                fileId,\n                {\n                    Method: 'POST',\n\
    \                    Headers: {\n                        Accept: ['application/json'],\n\
    \                        filename: fileName\n                    }\n         \
    \       },\n                {},\n                params.insecure,\n          \
    \      params.proxy,\n                undefined,\n                'file',\n  \
    \              fileName);\n        } else {\n            res = http(\n       \
    \         requestUrl,\n                {\n                    Method: 'GET',\n\
    \                    Headers: {\n                        Accept: ['application/json']\n\
    \                    }\n                }\n                );\n        }\n   \
    \ }\n\n    if (res.StatusCode < 200 || res.StatusCode >= 300) {\n        throw\
    \ 'Request Failed.\\nStatus code: ' + res.StatusCode + '.\\nBody: ' + JSON.stringify(res)\
    \ + '.';\n    }\n\n    return res;\n};\n\n\nvar searchHash = function() {\n  \
    \  var res;\n    try {\n        res = JSON.parse(sendRequest('hash/', args.hash).Body);\n\
    \    } catch (err) {\n        throw 'Error in JSON parsing\\n';\n    }\n    var\
    \ md = '# OPSWAT-Metadefender\\n';\n    var ec = {};\n    var dbotScore = 0;\n\
    \n    md += '### Results for Hash ' + args.hash + '\\n';\n\n    if (res.file_info)\
    \ {\n        md += 'File name: ' + res.file_info.display_name + '\\n';\n     \
    \   md += 'File description: ' + res.file_info.file_type_description + '\\n';\n\
    \        md += 'Scan result: ' + res.scan_results.scan_all_result_a + '\\n';\n\
    \        md += 'Detected AV: ' + res.scan_results.total_detected_avs + '/' + res.scan_results.total_avs\
    \ + '\\n';\n\n        md += 'AV Name|Def Time|Threat Name Found\\n';\n       \
    \ md += '---|---|---\\n';\n\n        var avRes = res.scan_results.scan_details;\n\
    \n        Object.keys(avRes).forEach(function(key) {\n          md += key + '|';\n\
    \          md += avRes[key].def_time + '|';\n          md += avRes[key].threat_found\
    \ + '\\n';\n        });\n\n        var percntBad = (res.scan_results.total_detected_avs\
    \ / res.scan_results.total_avs) * 100;\n\n        if (percntBad >= parseInt(params.highPercnt))\
    \ {\n            dbotScore = 3;\n            addMalicious(ec, outputPaths.file,{\n\
    \                Hash: args.hash,\n                Malicious: {Vendor: 'OPSWAT',\
    \ Description: 'Result from OPSWAT-Metadefender'}\n            });\n        }\
    \ else if (percntBad >= parseInt(params.lowPercnt)) {\n            dbotScore =\
    \ 2;\n        } else {\n            dbotScore = 1;\n        }\n        ec.DBotScore\
    \ = {Indicator: args.hash, Type: 'hash', Vendor: 'OPSWAT', Score: dbotScore};\n\
    \n\n        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json,\
    \ HumanReadable: md, EntryContext: ec};\n    } else {\n        md += 'No results\
    \ for this hash\\n';\n\n        return {Type: entryTypes.note, Contents: res,\
    \ ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};\n    }\n\
    };\n\n\nvar scanFile = function() {\n    var res;\n    var fileName = dq(invContext,\
    \ 'File(val.EntryID == \\'' + args.fileId + '\\').Name');\n\n    if (!fileName)\
    \ {\n        throw 'Wrong FileID\\n';\n    }\n\n    try {\n        res = JSON.parse(sendRequest('file',\
    \ '' , args.fileId).Body);\n    } catch (err) {\n        throw 'Error in JSON\
    \ parsing\\n';\n    }\n    var md = '# OPSWAT-Metadefender\\n';\n    var ec =\
    \ {};\n\n    md += 'The file has been successfully submitted to scan.\\n';\n \
    \   md += 'Scan id: ' + res.data_id + '\\n';\n\n    ec.OPSWAT = {\n        FileName:\
    \ fileName[0],\n        ScanId: res.data_id\n    };\n\n    return {Type: entryTypes.note,\
    \ Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext:\
    \ ec};\n};\n\n\nvar getScanResult = function() {\n    var res;\n    try {\n  \
    \      res = JSON.parse(sendRequest('file/' + args.id, '').Body);\n    } catch\
    \ (err) {\n        throw 'Error in JSON parsing\\n';\n    }\n\n    var md = '#\
    \ OPSWAT-Metadefender\\n';\n    var ec = {};\n    var dbotScore = 0;\n\n    md\
    \ += '### Results for scan id ' + args.id + '\\n';\n\n    if (res.file_info &&\n\
    \        res.process_info) {\n        if (res.process_info.progress_percentage\
    \ < 100) {\n            md += '### The scan proccess is in progrees (done: ' +\
    \ res.process_info.progress_percentage + '%) \\n'\n        }\n        md += 'File\
    \ name: ' + res.file_info.display_name + '\\n';\n        md += 'File description:\
    \ ' + res.file_info.file_type_description + '\\n';\n        if (res.scan_results)\
    \ {\n            md += 'Scan result: ' + res.scan_results.scan_all_result_a +\
    \ '\\n';\n            md += 'Detected AV: ' + res.scan_results.scan_all_result_i\
    \ + '/' + res.scan_results.total_avs + '\\n';\n        }\n\n        md += 'Scan\
    \ progress percentage ' + res.process_info.progress_percentage + '\\n';\n\n  \
    \      var percntBad = (res.scan_results.scan_all_result_i / res.scan_results.total_avs)\
    \ * 100;\n\n        ec['OPSWAT(val.ScanId == ' + args.id + ').ScanProgress'] =\
    \ res.process_info.progress_percentage;\n        ec['OPSWAT(val.ScanId == ' +\
    \ args.id + ').PercentageBad'] = percntBad;\n        ec['OPSWAT(val.ScanId ==\
    \ ' + args.id + ').Result'] = res.scan_results.scan_all_result_a;\n\n\n      \
    \  md += 'AV Name|Def Time|Threat Name Found\\n';\n        md += '---|---|---\\\
    n';\n\n        var avRes = res.scan_results.scan_details;\n\n        Object.keys(avRes).forEach(function(key)\
    \ {\n          md += key + '|';\n          md += avRes[key].def_time + '|';\n\
    \          md += avRes[key].threat_found + '\\n';\n        });\n\n\n\n       \
    \ if (percntBad >= parseInt(params.highPercnt)) {\n            dbotScore = 3;\n\
    \            addMalicious(ec, outputPaths.file,{\n                Hash: res.file_info.md5,\n\
    \                Malicious: {Vendor: 'OPSWAT', Description: 'Result from OPSWAT-Metadefender'}\n\
    \            });\n        } else if (percntBad >= parseInt(params.lowPercnt))\
    \ {\n            dbotScore = 2;\n        } else {\n            dbotScore = 1;\n\
    \        }\n        ec.DBotScore = {Indicator: res.file_info.md5, Type: 'hash',\
    \ Vendor: 'OPSWAT', Score: dbotScore};\n\n\n        return {Type: entryTypes.note,\
    \ Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext:\
    \ ec};\n    } else {\n        md += 'No results for this id\\n';\n\n        return\
    \ {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable:\
    \ md, EntryContext: ec};\n    }\n};\n\n\nswitch (command) {\n    // This is the\
    \ call made when pressing the integration test button.\n    case 'test-module':\n\
    \        var res = sendRequest('hash/', '66DA1A91E1ED5D59BECFAD85F53C05F9');\n\
    \        if (res.StatusCode !== 200) {\n            return res\n        }\n  \
    \      return 'ok';\n    case 'opswat-hash':\n        return searchHash();\n \
    \   case 'opswat-scan-file':\n        return scanFile();\n    case 'opswat-scan-result':\n\
    \        return getScanResult();\n    default:\n        throw 'Unknown command\
    \ - ' + command;\n}\n"
  type: javascript
tests:
- No tests - no instance
toversion: 4.1.9
