category: Endpoint
commonfields:
  id: Trend Micro
  version: -1
configuration:
- display: Credentials
  name: credentials
  required: true
  type: 9
- display: Server URL and port (e.g. https://192.168.0.1:4119)
  name: server
  required: true
  type: 0
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
description: Uses Trend Micro Deep Security
detaileddescription: 'To enable API access, configure the following using the Web
  UI of the Trend Micro Deep Security Manager:

  - Enable the SOAP API:

  Administration -> System Settings -> Advanced -> SOAP Web Service API -> Enable

  -  Connecting user must have the role "Allow Access to web services API" checked.


  '
display: Trend Micro
image: data:image/png;base64,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
name: Trend Micro
script:
  commands:
  - arguments: []
    description: Get all hosts info
    name: trendmicro-host-retrieve-all
  - arguments:
    - description: Time interval start
      name: rangeFrom
    - description: Time interval end
      name: rangeTo
    - description: Specific time
      name: specificTime
    - auto: PREDEFINED
      description: Define time filter mode. mandatory if filtering by time.
      name: timeFilterType
      predefined:
      - LAST_HOUR
      - LAST_24_HOURS
      - LAST_7_DAYS
      - CUSTOM_RANGE
      - SPECIFIC_TIME
    - description: Filter by host group ID
      name: hostGroupID
    - description: Filter by host ID
      name: hostID
    - description: Filter by host security profile ID
      name: securityProfileID
    - auto: PREDEFINED
      description: Define host filter mode. mandatory if filtering by host/s.
      name: hostFilterType
      predefined:
      - ALL_HOSTS
      - HOSTS_IN_GROUP
      - HOSTS_USING_SECURITY_PROFILE
      - HOSTS_IN_GROUP_AND_ALL_SUBGROUPS
      - SPECIFIC_HOST
      - MY_HOSTS
    - description: filter by event ID
      name: eventID
    - auto: PREDEFINED
      description: event ID operator
      name: eventFilterOperator
      predefined:
      - GREATER_THAN
      - LESS_THAN
      - EQUAL
    - auto: PREDEFINED
      description: Include non-host hevents in filter
      name: includeNonHostEvents
      predefined:
      - 'false'
      - 'true'
      required: true
    description: Get system events
    name: trendmicro-system-event-retrieve
  - arguments:
    - description: list of host ids to scan, separated by commas
      name: hostIDs
      required: true
    description: scan computers by host ID list
    execution: true
    name: trendmicro-host-antimalware-scan
  - arguments:
    - description: Number of alerts to fetch
      name: count
      required: true
    description: Get last alerts
    name: trendmicro-alert-status
  - arguments: []
    description: Get all security profiles
    name: trendmicro-security-profile-retrieve-all
  - arguments:
    - description: security profile ID that will be assigned to the hosts
      name: securityProfileID
      required: true
    - description: list of host IDs, separated by commas
      name: hostIDs
      required: true
    description: Assign security profile to host
    execution: true
    name: trendmicro-security-profile-assign-to-host
  - arguments:
    - description: Time interval start
      name: rangeFrom
    - description: Time interval end
      name: rangeTo
    - description: Specific Time
      name: specificTime
    - auto: PREDEFINED
      description: Define time filter mode. mandatory if filtering by time.
      name: timeFilterType
      predefined:
      - LAST_HOUR
      - LAST_24_HOURS
      - LAST_7_DAYS
      - CUSTOM_RANGE
      - SPECIFIC_TIME
    - description: Filter by host group ID
      name: hostGroupID
    - description: Filter by host ID
      name: hostID
    - description: Filter by host security profile ID
      name: securityProfileID
    - auto: PREDEFINED
      description: Define host filter mode. mandatory if filtering by host/s.
      name: hostFilterType
      predefined:
      - ALL_HOSTS
      - HOSTS_IN_GROUP
      - HOSTS_USING_SECURITY_PROFILE
      - HOSTS_IN_GROUP_AND_ALL_SUBGROUPS
      - SPECIFIC_HOST
      - MY_HOSTS
    - description: filter by event ID
      name: eventID
    - auto: PREDEFINED
      description: event ID operator
      name: eventFilterOperator
      predefined:
      - GREATER_THAN
      - LESS_THAN
      - EQUAL
    description: Get anti malware events
    name: trendmicro-anti-malware-event-retrieve
  isfetch: true
  script: "\nvar username = params.credentials.identifier;\nvar password = params.credentials.password;\n\
    var server = params.server.replace(/[\\/]+$/, '');\nvar insecure = params.insecure;\n\
    var proxy = params.proxy;\nvar url = server + '/webservice/Manager';\n\n\nvar\
    \ responseDict = {\n    'authenticate': /<authenticateReturn>(.*)<\\/authenticateReturn/,\n\
    \    'hostRetrieveAll': /<soapenv:Body>((.|\\n)*)<\\/soapenv:Body>/,\n    'endSession':\
    \ /<soapenv:Body><endSessionResponse xmlns=(.*)\\/><\\/soapenv:Body>/,\n    'systemEventRetrieve':\
    \ /<systemEventRetrieveResponse xmlns=\"urn:Manager\">((.|\\n)*)<\\/systemEventRetrieveResponse>/,\n\
    \    'antiMalwareEventRetrieve':/<antiMalwareEventRetrieveResponse xmlns=\"urn:Manager\"\
    >((.|\\n)*)<\\/antiMalwareEventRetrieveResponse>/,\n    'hostAntiMalwareScan':/<soapenv:Body>((.|\\\
    n)*)<\\/soapenv:Body>/,\n    'alertStatusRetrieve':/<soapenv:Body>((.|\\n)*)<\\\
    /soapenv:Body>/,\n    'securityProfileRetrieveAll': /<soapenv:Body>((.|\\n)*)<\\\
    /soapenv:Body>/,\n    'securityProfileAssignToHost': /<soapenv:Body>((.|\\n)*)<\\\
    /soapenv:Body>/\n};\n\n\n\nvar commandToMethod = {\n    'trendmicro-host-antimalware-scan':\
    \ 'hostAntiMalwareScan',\n    'trendmicro-host-retrieve-all': 'hostRetrieveAll',\n\
    \    'trendmicro-system-event-retrieve': 'systemEventRetrieve',\n    'trendmicro-anti-malware-event-retrieve':\
    \ 'antiMalwareEventRetrieve',\n    'trendmicro-alert-status': 'alertStatusRetrieve',\n\
    \    'trendmicro-security-profile-retrieve-all': 'securityProfileRetrieveAll',\n\
    \    'trendmicro-security-profile-assign-to-host': 'securityProfileAssignToHost'\n\
    };\n\nvar sessionData = '<urn:sID>%sessionId%</urn:sID>';\n\nvar methodDict =\
    \ {\n        'authenticate': '<urn:authenticate><urn:username>%username%</urn:username><urn:password>%password%</urn:password></urn:authenticate>',\n\
    \        'endSession': '<urn:endSession>' + sessionData + '</urn:endSession>',\n\
    \        'hostRetrieveAll': '<urn:hostRetrieveAll>' + sessionData + '</urn:hostRetrieveAll>',\n\
    \        'systemEventRetrieve': '<urn:systemEventRetrieve>%timeFilter%%hostFilter%%eventIdFilter%<urn:includeNonHostEvents>%includeNonHostEvents%</urn:includeNonHostEvents>'+\
    \ sessionData +'</urn:systemEventRetrieve>',\n        'antiMalwareEventRetrieve':\
    \ '<urn:antiMalwareEventRetrieve>%timeFilter%%hostFilter%%eventIdFilter%'+ sessionData\
    \ +'</urn:antiMalwareEventRetrieve>',\n        'hostAntiMalwareScan': '<urn:hostAntiMalwareScan>%hostIDs%'\
    \ + sessionData + '</urn:hostAntiMalwareScan>',\n        'alertStatusRetrieve':\
    \ '<urn:alertStatusRetrieve><urn:count>%count%</urn:count>' + sessionData + '</urn:alertStatusRetrieve>',\n\
    \        'securityProfileRetrieveAll': '<urn:securityProfileRetrieveAll>' + sessionData\
    \ + '</urn:securityProfileRetrieveAll>',\n        'securityProfileAssignToHost':'<urn:securityProfileAssignToHost><urn:securityProfileID>%securityProfileID%</urn:securityProfileID>%hostIDs%'\
    \ + sessionData + '</urn:securityProfileAssignToHost>'\n};\n\nvar filterDict =\
    \ {\n    'timeFilter': '<urn:timeFilter>%timeFilter%</urn:timeFilter>',\n    'hostFilter':\
    \ '<urn:hostFilter>%hostFilter%</urn:hostFilter>',\n    'eventIdFilter': '<urn:eventIdFilter>%eventIdFilter%</urn:eventIdFilter>'\n\
    \n};\n\n\n\nvar hostFilterDict = {\n    'hostGroupID': '<urn:hostGroupID>%hostGroupID%</urn:hostGroupID>',\n\
    \    'hostID': '<urn:hostID>%hostID%</urn:hostID>',\n    'securityProfileID':\
    \ '<urn:securityProfileID>%securityProfileID%</urn:securityProfileID>',\n    'hostFilterType':\
    \ '<urn:type>%hostFilterType%</urn:type>'\n\n};\n\nvar timeFilterDict = {\n  'rangeFrom':\
    \ '<urn:rangeFrom>%rangeFrom%</urn:rangeFrom>',\n  'rangeTo': '<urn:rangeTo>%rangeTo%</urn:rangeTo>',\n\
    \  'specificTime': '<urn:specificTime>%specificTime%</urn:specificTime>',\n  'timeFilterType':\
    \ '<urn:type>%timeFilterType%</urn:type>'\n};\n\nvar eventIdFilterDict = {\n \
    \ 'eventID': '<urn:id>%eventID%</urn:id>',\n  'eventFilterOperator': '<urn:operator>%eventFilterOperator%</urn:operator>'\n\
    };\n\nvar filterContentDict = {\n    'hostFilter': hostFilterDict,\n    'timeFilter':\
    \ timeFilterDict,\n    'eventIdFilter': eventIdFilterDict\n};\n\n// Wrap host\
    \ IDs array if exists\nif ('hostIDs' in args) {\n        args.hostIDs = '<urn:hostIDs>'\
    \ + args.hostIDs.split(',').join('</urn:hostIDs><urn:hostIDs>') + '</urn:hostIDs>';\n\
    }\n\nfunction getFilterContent(filterName, args) {\n    var filterContent = '';\n\
    \    filterArgsDict = filterContentDict[filterName];\n    var argNames = Object.keys(args);\n\
    \    for (var i = 0; i < argNames.length; i++) {\n        if (argNames[i] in filterArgsDict){\n\
    \        filterContent += filterArgsDict[argNames[i]];\n        }\n    }\n   \
    \ if (!filterContent) {\n        return '';\n    }\n\n    var  filterContents\
    \ = {};\n    filterContents[filterName] = filterContent;\n    return replaceInTemplates(filterDict[filterName],\
    \ filterContents);\n}\n\n// In requests with optional filters, the command arguemnts\
    \ will determine which filters to add\nfunction AddFiltersIfNeeded(reqTemplate,\
    \ args) {\n    var filtersForRequest = {};\n    var filterNames = Object.keys(filterDict);\n\
    \    for (var i = 0; i < filterNames.length; i++) {\n        var patt = new RegExp(filterNames[i]);\n\
    \        if (patt.exec(reqTemplate)) {\n            var filterContent = getFilterContent(filterNames[i],\
    \ args);\n            filtersForRequest[filterNames[i]] = filterContent;\n   \
    \     }\n    }\n    return  replaceInTemplates(reqTemplate, filtersForRequest);\n\
    }\n\nfunction createSOAPRequest(methodName, args) {\n    var request = '<soapenv:Envelope\
    \ xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:urn=\"urn:Manager\"\
    ><soapenv:Header/><soapenv:Body>%content%</soapenv:Body></soapenv:Envelope>';\n\
    \    var bodyWithFilters = AddFiltersIfNeeded(methodDict[methodName], args);\n\
    \    request = replaceInTemplates(request, {'content': bodyWithFilters}); // add\
    \ body to request\n    request = replaceInTemplates(request, args); // fill arguemnts\n\
    \    return request;\n}\n\nfunction sendSOAPRequest(methodName, args) {\n    var\
    \ req = createSOAPRequest(methodName, args);\n    var res = http(\n        url,\n\
    \        {\n            Method: 'POST',\n            Headers: {\n            SOAPAction:\
    \ [\"\"]\n            },\n            Body: req\n        },\n        insecure,\n\
    \        proxy\n    );\n    if (res.StatusCode < 200 || res.StatusCode >= 300)\
    \ {\n            throw 'Failed to ' + methodName + ', request status code: ' +\
    \ res.StatusCode + ' and Body: ' + res.Body + '.';\n        }\n    return res.Body;\n\
    }\n\nfunction sendAndParse(method, args) {\n    var responseXML = sendSOAPRequest(method,\
    \ args);\n    var match = responseDict[method].exec(responseXML);\n    if (match\
    \ && match[1]) {\n        return match[1];\n    }\n    throw method +' failed';\n\
    }\n\n\nfunction createIncidentFromAlert(singleAlert) {\n    var keys = Object.keys(singleAlert);\n\
    \    var labels = [];\n    for (var i = 0; i < keys.length; i++) {\n        labels.push({'type':\
    \ keys[i], 'value': String(singleAlert[keys[i]])});\n    }\n    var alertTime\
    \ = new Date(singleAlert.alertDate);\n    return {\n            \"name\": singleAlert.alertType,\n\
    \            \"occurred\": alertTime,\n            \"labels\": labels,\n     \
    \       \"rawJSON\": JSON.stringify(singleAlert)\n        }\n}\n\nfunction fetchIncidents()\
    \ {\n    var lastRun = getLastRun();\n    var startTime = lastRun && lastRun.startTime\
    \ ? lastRun.startTime : 0;\n    var maxTime = startTime;\n    args.sessionId =\
    \ sendAndParse('authenticate', {username: username, password: password});\n  \
    \  args.count = 1000;\n    var res = JSON.parse(x2j(sendAndParse('alertStatusRetrieve',\
    \ args)));\n    sendAndParse('endSession',args);\n    var incidents = [];\n  \
    \  if (res && res.alertStatusRetrieveResponse){\n        var alertsDict = res.alertStatusRetrieveResponse.alertStatusRetrieveReturn;\n\
    \        for (var i in alertsDict) {\n            var alertTime = new Date(alertsDict[i].alertDate);\n\
    \            if (alertTime > startTime) {\n                incidents.push(createIncidentFromAlert(alertsDict[i]));\n\
    \                maxTime = Math.max(alertTime, maxTime);\n            }\n    \
    \    }\n    }\n    setLastRun({startTime: maxTime});\n    return JSON.stringify(incidents);\n\
    }\n\nswitch (command) {\n    case 'test-module':\n        if (sendAndParse('authenticate',\
    \ {username: username, password: password})) {\n            return 'ok';\n   \
    \     }\n        return 'something is wrong';\n    case 'fetch-incidents':\n \
    \       return fetchIncidents();\n    default:\n        args.sessionId = sendAndParse('authenticate',\
    \ {username: username, password: password});\n        var res = JSON.parse(x2j(sendAndParse(commandToMethod[command],\
    \ args)));\n        sendAndParse('endSession',args);\n        return res;\n}\n\
    \n"
  type: javascript
system: true
tests:
- No test
toversion: 4.1.9
