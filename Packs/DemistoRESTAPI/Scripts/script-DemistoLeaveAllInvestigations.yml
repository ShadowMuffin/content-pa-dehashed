comment: Leaves all investigations that the user is part of (clears out the incidents
  in the left pane). Incidents that the user owns will remain in the left pane. Requires
  Demisto REST API integration to be configured for the server.
commonfields:
  id: DemistoLeaveAllInvestigations
  version: -1
dependson:
  must:
  - demisto-api-post
enabled: true
name: DemistoLeaveAllInvestigations
runas: DBotWeakRole
runonce: false
script: "function addEntry(text) {\n    entry =  [{ContentsFormat: formats.markdown,\
  \ Type: entryTypes.note, Contents: text}];\n    executeCommand(\"addEntries\", {\"\
  entries\":JSON.stringify(entry)});\n}\n\nvar account = incidents[0].account ?  'acc_'\
  \ + incidents[0].account : \"\";\n\nvar res = executeCommand(\"getUsers\", {current:\
  \ true});\nif (isError(res[0])) {\n    return { ContentsFormat: formats.text, Type:\
  \ entryTypes.error, Contents: 'Cannot get current user.\\nThis script cannot be\
  \ executed within a playbook.' };\n}\n\nvar username = res[0].Contents[0].username;\n\
  \nres = executeCommand(\"getIncidents\", {query: 'investigation.users:\"'+username+'\"\
  \ and status:Active and -owner:\"'+username+'\"', size: 10000});\nif (isError(res[0]))\
  \ {\n    return res;\n}\n\nvar ids = dq(res[0].Contents.data,'id');\nvar errors\
  \ = [];\n\nif (ids && ids.length > 0) {\n    ids.forEach(function(id) {\n      \
  \  var uri = account + '/investigation/' + id + '/deleteuser/' + username;\n   \
  \     addEntry('Leaving investigation ' + id + '...');\n        var res = executeCommand('demisto-api-post',\
  \ {uri: uri, body: {}});\n        if (isError(res[0])) {\n            errors.push(res[0]);\n\
  \        }\n    });\n}\nreturn (errors.length === 0) ? 'Done' : errors;\n"
scripttarget: 0
tags:
- DemistoAPI
tests:
- No test
toversion: 4.1.9
type: javascript
