category: Data Enrichment & Threat Intelligence
commonfields:
  id: Threat Crowd
  version: -1
configuration:
- defaultvalue: https://www.threatcrowd.org
  display: Server URL (e.g. https://192.168.0.1)
  name: server
  required: true
  type: 0
- defaultvalue: v2
  display: Version
  name: version
  required: true
  type: 0
- defaultvalue: 'false'
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: 'false'
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
defaultEnabled: false
description: Query threat crowd for reports.
display: Threat Crowd
hidden: false
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAEWklEQVR4AeyZA5ArSxSG82zbtm3btm3btp1kbdu2bdv2ZtT9vzmZvUZucXuq7l911ugvh33GslJB6iWWYCnWEuQY1A2C2yCd1XnmNRQkf6h/g4sPsLZJjM6+0hPGF4xvmhKGGJbCCaY2YjBJTrjOGfNDGLYZxPQgB0ZLOCdFxilJEnYKMyHIlZkyEgcZFjSsVNc8x5f1KvaJlMwB8kalCg5gUQOCezR8XqfipyYVpRMMpNopjuPiJbFB7shTQCocYzg+Yc3Dbh3swLOlChgHynSo3cIFBdkx1IH6aY7BRY5DYzb8ir9dpYL0fJkiJsj5qTJIn9aqG/0j5IkBHTZnlGELEUGeKTXC6qYc2eUfShpkGJU4do+QxAN5sdwAuSHbNQhVtDEdZA8RQS5Nd4YWVamN/hHqJz0LHPljgoYWHbBphjvj/+CNJPvrlc5kJw+KW37vyt9w+d0q2IEnihXIDJiUDVgRQFyWV+rqvl0aPqpR8UW96oQjjUscpJh+JkCyu7DrsmUkDzLIDCvVv8jxQ6OKw2MlfNNgwKYMMexJMKIPjdQYL0qTcWayjF3X6uQ0d5EyRxjNX+Ye46l5kqiC7RcliQ/iasgkFY8zHBQtmfti9fJSM62cZDgyTjL3DZGGSBINnsesNebvEOrAVZky3tS992+bhr9bNbxSoeDsFBlbBgt41X2yRIHGgbY5jhOX+tCDhYrzDrNCiwogqViprBFGkOLd2e8vUKAwwzP+3RpIHbMc7+n96e6kVjwenYFHo3PwcHo3fmzQMCWBRN4Sb/lwe56CRYMBNj2Mbg3NQ5jbHRi17Q1u3QKadSv0Wg/Gf27P4Ja4ZmQOMpAo14QCoVGHccCm58Oj3t6Yse8KeFkAu262JXPTzduCTvvhuCU0G/nDDA6V44xkWQwQSuzGGY4O3W4Jy8asfRfAnQ6/AfO0oNV6NG5P7oJDA4J6NDFALs+QQaKcCLfebnjC5sJ0z3zt8R4COzSa8agfLT/Iu9UqSPclt2DUujdgdw1CHiuxno2XS+ZAonXUsoP8p+eFQwUei8qgxHYJQUaww//ti2eyu0Gia/eyg/zZokHWgEeic6g6bTJIv/VAPJ3TB9ITxQKAvLDU4e9P60HffwcBbpsA4mFBlvVSvF1p5NcFaQKEFo0dpO/qVdjsTwHerkGoILzt9T1S+p3bGbrjLD8IbSRp5zUpAzfFNqDLdhjgufGKlWO9GA/nToD0e4smTkOkqqNxIG2A4ZaQLDTbjzU8427kgzPcPAxPZNovwy3xLeieNbach8RIYoCsXYZzhhluTerBN17voth2DlUnZ2Jn2S7FWz7f47HcKYJwNsMbc2QxH/S8VqFA0jhUBoR0MrxSOkclVrdevFMpIbmfgUQrqOuzZbGfWJ2lJ39gt9Gx1xYl9h8tGoWTeR690R6McoeaHfWJC9Nk/D8R4KDF6BzicMDDZsHAsFnCMXwW1YDBip/VIIGhvMxp2Cw8AwDuoS89K9EFJQAAAABJRU5ErkJggg==
name: Threat Crowd
script:
  commands:
  - arguments:
    - default: true
      description: Get a report of an email address.
      name: email
      required: true
    description: Get a report of an email address.
    name: threat-crowd-email
    outputs:
    - contextPath: Account.Email.Address
      description: The email address.
    - contextPath: Account.Type
      description: The type of the found email address.
    - contextPath: Account.ThreatCrowd.Domains
      description: The Threat Crowd domains linked to the account.
  - arguments:
    - description: Get a report of a domain.
      name: domain
      required: true
    description: Get a report of a domain.
    name: threat-crowd-domain
    outputs:
    - contextPath: Domain.Name
      description: The domain name.
    - contextPath: Domain.ThreatCrowd.Emails
      description: The Threat Crowd emails.
    - contextPath: Domain.ThreatCrowd.SubDomains
      description: The Threat Crowd subdomains.
    - contextPath: Domain.ThreatCrowd.References
      description: The Threat Crowd references.
    - contextPath: Domain.ThreatCrowd.Votes
      description: The Threat Crowd vote results.
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The type of the indicator.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score of the domain.
    - contextPath: DBotScore.Score
      description: The score of the domain.
  - arguments:
    - description: Get a report of an IP.
      name: ip
      required: true
    description: Get a report of an IP.
    name: threat-crowd-ip
    outputs:
    - contextPath: IP.Address
      description: The IP address.
    - contextPath: IP.ThreatCrowd.Hashes
      description: The Threat Crowd hashes.
    - contextPath: IP.ThreatCrowd.References
      description: The Threat Crowd references.
    - contextPath: IP.ThreatCrowd.Resolutions
      description: The Threat Crowd resolutions.
    - contextPath: IP.ThreatCrowd.Votes
      description: The vote results on Threat Crowd.
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The type of the indicator.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score of the IP.
    - contextPath: DBotScore.Score
      description: The score of the IP.
  - arguments:
    - description: Get a report of an antivirus.
      name: antivirus
      required: true
    description: Get a report of an antivirus.
    name: threat-crowd-antivirus
    outputs:
    - contextPath: ThreatCrowd.AntiVirus.Name
      description: The name of the antivirus.
    - contextPath: ThreatCrowd.AntiVirus.Hashes
      description: The hashes of the antivirus.
    - contextPath: ThreatCrowd.AntiVirus.References
      description: The references of the antivirus.
  - arguments:
    - description: Get a report of a hash.
      name: file
      required: true
    description: Get a report of a file.
    name: threat-crowd-file
    outputs:
    - contextPath: File.MD5
      description: The MD5 hash of the of the file.
    - contextPath: File.ThreatCrowd.IPs
      description: The Threat Crowd IPs of the file.
    - contextPath: File.ThreatCrowd.Domains
      description: The Threat Crowd domains of the file.
    - contextPath: File.ThreatCrowd.Resource
      description: The Threat Crowd resources of the file.
    - contextPath: File.ThreatCrowd.SHA1
      description: The SHA1 hash of the of the file.
    - contextPath: File.ThreatCrowd.References
      description: The Threat Crowd references of the file.
    - contextPath: File.ThreatCrowd.Scans
      description: The Threat Crowd scans of the file.
  script: "var server = params.server.replace(/[\\/]+$/, '') + '/searchApi/' + params.version\
    \ + '/';\n\nvar commands = {\n    'threat-crowd-email': {\n        url: 'email',\n\
    \        title: 'Threat crowd report for email %email%',\n        defaultFields:\
    \ {\n          'type': 'Email',\n        },\n        translator: [\n         \
    \   {to: 'ThreatCrowd-Domains', from: 'domains'},\n            {to: 'Address',\
    \ from: 'email'},\n            {to: 'Type', from: 'type'},\n        ],\n     \
    \   contextKey: 'Account.Email(val.Address==obj.Address)',\n    },\n    'threat-crowd-domain':\
    \ {\n        url: 'domain',\n        title: 'Threat crowd report for domain %domain%',\n\
    \        translator: [\n            {to: 'Name', from: 'domain'},\n          \
    \  {to: 'ThreatCrowd-Emails', from: 'emails'},\n            {to: 'ThreatCrowd-SubDomains',\
    \ from: 'subdomains'},\n            {to: 'ThreatCrowd-References', from: 'references'},\n\
    \            {to: 'ThreatCrowd-Votes', from: 'votes'},\n\n        ],\n       \
    \ contextKey: 'Domain(val.Name==obj.Name)',\n    },\n    'threat-crowd-ip': {\n\
    \        url: 'ip',\n        title: 'Threat crowd report for ip %ip%',\n     \
    \   translator: [\n            {to: 'Address', from: 'ip'},\n            {to:\
    \ 'ThreatCrowd-Hashes', from: 'hashes'},\n            {to: 'ThreatCrowd-References',\
    \ from: 'references'},\n            {to: 'ThreatCrowd-Resolutions', from: 'resolutions'},\n\
    \            {to: 'ThreatCrowd-Votes', from: 'votes'},\n        ],\n        contextKey:\
    \ 'IP(val.Address==obj.Address)',\n    },\n    'threat-crowd-antivirus': {\n \
    \       url: 'antivirus',\n        title: 'Threat crowd report for antivirus %antivirus%',\n\
    \        translator: [\n            {to: 'Name', from: 'antivirus'},\n       \
    \     {to: 'Hashes', from: 'hashes'},\n            {to: 'References', from: 'references'},\n\
    \        ],\n        contextKey: 'ThreatCrowd.AntiVirus(val.Name==obj.Name)',\n\
    \    },\n    'threat-crowd-file': {\n        url: 'file',\n        title: 'Threat\
    \ crowd report for file with hash %resource%',\n        translator: [\n      \
    \      {to: 'MD5', from: 'md5'},\n            {to: 'ThreatCrowd-IPs', from: 'ips'},\n\
    \            {to: 'ThreatCrowd-Domains', from: 'domains'},\n            {to: 'ThreatCrowd-Resource',\
    \ from: 'resource'},\n            {to: 'ThreatCrowd-SHA1', from: 'sha1'},\n  \
    \          {to: 'ThreatCrowd-References', from: 'references'},\n            {to:\
    \ 'ThreatCrowd-Scans', from: 'scans'},\n        ],\n        contextKey: 'File(val.MD5==obj.MD5)',\n\
    \    },\n    'test-module': {\n        url: 'email',\n        defaultArgs: {\n\
    \            email: 'william19770319@yahoo.com',\n        },\n    },\n};\n\nfunction\
    \ createContext(data, dbotScore) {\n    var createContextSingle = function(obj)\
    \ {\n        var res = {};\n        var keys = Object.keys(obj);\n        keys.forEach(function(k)\
    \ {\n            var values = k.split('-');\n            var current = res;\n\
    \            for (var j = 0; j<values.length - 1; j++) {\n                if (!current[values[j]])\
    \ {\n                    current[values[j]] = {};\n                }\n       \
    \         current = current[values[j]];\n            }\n            current[values[j]]\
    \ = obj[k];\n        });\n\n        if (dbotScore == 3) {\n            res.Malicious\
    \ = {\n               \"Vendor\": 'Threat Crowd',\n               \"Description\"\
    : 'Most users have voted this entity malicious'\n            };\n        }\n \
    \       return res;\n    };\n    if (data instanceof Array) {\n        var res\
    \ = [];\n        for (var j=0; j < data.length; j++) {\n            res.push(createContextSingle(data[j]));\n\
    \        }\n\n        if (dbotScore == 3) {\n            res.Malicious = {\n \
    \              \"Vendor\": 'Threat Crowd',\n               \"Description\": 'Most\
    \ users have voted this entity malicious1'\n            };\n        }\n      \
    \  return res;\n    }\n    return createContextSingle(data);\n}\n\nfunction mapObjFunction(mapFields)\
    \ {\n    var transformSingleObj= function(obj) {\n        var res = {};\n    \
    \    mapFields.forEach(function(f) {\n           res[f.to] = dq(obj, f.from);\n\
    \        });\n        return res;\n    };\n    return function(obj) {\n      \
    \  if (obj instanceof Array) {\n            var res = [];\n            for (var\
    \ j=0; j < obj.length; j++) {\n                res.push(transformSingleObj(obj[j]));\n\
    \            }\n            return res;\n        }\n        return transformSingleObj(obj);\n\
    \    };\n}\n\nfunction merge(obj1, obj2) {\n    if (!obj2) {\n        return obj1;\n\
    \    }\n    keys = Object.keys(obj2);\n    for (var k in keys) {\n        if (obj1[keys[k]]\
    \ === undefined) {\n            obj1[keys[k]] = obj2[keys[k]]\n        }\n   \
    \ }\n    return obj1;\n}\n\nif (args.file) {\n    args.resource = args.file;\n\
    \    delete(args.file);\n}\n\nfunction calculateDBotScore(res, args, commandData)\
    \ {\n    var dbotScore = 0;\n    if (res.response_code == 1){\n         if ('votes'\
    \ in res){\n            switch (res.votes) {\n                case -1: //malicious\n\
    \                    dbotScore = 3\n                    break;\n             \
    \   case 0: //suspicious\n                    dbotScore = 2;\n               \
    \     break;\n                case 1: //clean\n                    dbotScore =\
    \ 1;\n                    break;\n            }\n        }\n    }\n    return\
    \ dbotScore;\n}\n\nfunction createDbotEntry(commandData, dbotScore){\n    var\
    \ DbotEntry = {};\n        if (commandData.url == 'ip'){\n            DbotEntry\
    \ = {\n                \"Indicator\": args.ip,\n                 \"Type\": \"\
    IP\",\n                 \"Vendor\": \"Threat Crowd\",\n                 \"Score\"\
    : dbotScore\n            };\n        }\n\n        else {\n            DbotEntry\
    \ = {\n                \"Indicator\": args.domain,\n                 \"Type\"\
    : \"Domain\",\n                 \"Vendor\": \"Threat Crowd\",\n              \
    \   \"Score\": dbotScore\n            };\n        }\n        return DbotEntry;\n\
    }\n\nfunction sendRequestAndParse(commandData) {\n    res = http(\n        server\
    \ + commandData.url + '/report/' + encodeToURLQuery(args && Object.keys(args).length\
    \ ? args : commandData.defaultArgs),\n        {},\n        params.insecure,\n\
    \        params.proxy\n    );\n    if (res.StatusCode < 200 || res.StatusCode\
    \ >= 300) {\n        throw 'Failed to ' + commandData.url + ' , request status\
    \ code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';\n    }\n    entry\
    \ = {\n        Type: entryTypes.note,\n        Contents: JSON.parse(res.Body),\n\
    \        ContentsFormat: formats.json,\n    };\n    if (commandData.translator)\
    \ {\n        data = mapObjFunction(commandData.translator)(merge(merge(entry.Contents,\
    \ args), commandData.defaultFields));\n        entry.ReadableContentsFormat =\
    \ formats.markdown;\n        entry.HumanReadable = tableToMarkdown(replaceInTemplates(commandData.title,\
    \ args), data);\n        entry.EntryContext = {};\n        var dbotScore = -1;\n\
    \        if (commandData.url == 'domain' || commandData.url== 'ip') { // the only\
    \ commands with dbotScore\n            dbotScore = calculateDBotScore(JSON.parse(res.Body),\
    \ args, commandData);\n            entry.EntryContext = {};\n            entry.EntryContext['DBotScore']\
    \ = createDbotEntry(commandData, dbotScore);\n        }\n        entry.EntryContext[commandData.contextKey]\
    \ = createContext(data, dbotScore);\n    }\n    return entry;\n}\n\nres = sendRequestAndParse(commands[command]);\n\
    if (command === 'test-module') {\n    return 'ok';\n}\nreturn res;"
  type: javascript
tests:
- ThreatCrowd - Test
toversion: 4.1.9
