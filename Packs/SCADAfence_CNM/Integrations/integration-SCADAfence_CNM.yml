category: Network Security
commonfields:
  id: SCADAfence CNM
  version: -1
configuration:
- defaultvalue: ''
  display: API auth secret
  name: APISecret
  required: true
  type: 4
- defaultvalue: ''
  display: API auth key
  name: APIKey
  required: true
  type: 4
- defaultvalue: ''
  display: API url
  name: APIUrl
  required: true
  type: 0
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: Information,Warning,Threat,Severe,Critical
  display: 'Required severity levels for alerts separated by comma, from [Information,Warning,Threat,Severe,Critical].
    For ex.: Warning, Threat'
  name: AlertSeverity
  required: true
  type: 12
description: fetching data from CNM
display: SCADAfence CNM
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAAlCAYAAAAHgqbCAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjRCNzg0N0Q3NjYyMTFFNjg3NjM5QUVCQTAzMzY4NTkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NjRCNzg0N0U3NjYyMTFFNjg3NjM5QUVCQTAzMzY4NTkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo2NEI3ODQ3Qjc2NjIxMUU2ODc2MzlBRUJBMDMzNjg1OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo2NEI3ODQ3Qzc2NjIxMUU2ODc2MzlBRUJBMDMzNjg1OSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PpyArOsAAA3/SURBVHja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
name: SCADAfence CNM
script:
  commands:
  - arguments:
    - auto: PREDEFINED
      description: Required severity level of alert
      name: severity
      predefined:
      - Information
      - Warning
      - Threat
      - Critical
      - Severe
    - description: get alerts for specified IP
      name: ipAddress
    description: query alerts data from SCADAfence CNM
    name: scadafence-getAlerts
    outputs:
    - contextPath: SCADAfence.Alert.id
      description: alert ID
      type: string
    - contextPath: SCADAfence.Alert.ip
      description: asset IP
      type: string
    - contextPath: SCADAfence.Alert.severity
      description: alert severity level
      type: string
    - contextPath: SCADAfence.Alert.type
      description: short alert description
      type: string
    - contextPath: SCADAfence.Alert.details
      description: extended alert description
      type: string
  - arguments:
    - description: asset IP address
      name: ipAddress
    - description: Hostname
      name: hostName
    - auto: PREDEFINED
      description: type of the asset (one from list of options)
      name: assetType
      predefined:
      - server
      - dns
      - sql
      - print
      - domain
      - domain
      - workstation
      - plc
      - hmi
      - IO
      - terminal
      - ftp
      - Telnet
    description: fetch asset data from SCADAfence CNM
    name: scadafence-getAsset
    outputs:
    - contextPath: SCADAfence.Asset.ip
      description: IP address of the asset
      type: string
    - contextPath: SCADAfence.Asset.assetTypes
      description: types of the asset (if detected)
      type: string
    - contextPath: operatingSystem
      description: OS of the asset (if available)
      type: string
    - contextPath: vendor
      description: asset vendor
      type: string
  - arguments:
    - description: Alert ID
      name: alertId
      required: true
    - auto: PREDEFINED
      description: Alert status
      name: alertStatus
      predefined:
      - InProgress
      - Resolved
      required: true
    description: setting alert status
    name: scadafence-setAlertStatus
    outputs:
    - contextPath: SCADAfence.Alert.status
      description: new status for the alert
      type: string
  - arguments:
    - description: optional - ip address of the asset
      name: ipAddress
    - description: hostname  that corresponds to the asset of interest
      name: hostName
    - description: MAC address of the asset
      name: macAddress
    description: fetches asset connections data by one or more (combined) parameters
    name: scadafence-getAssetConnections
    outputs:
    - contextPath: SCADAfence.Asset.Conn.ip
      description: another endpoint's IP address
      type: string
    - contextPath: SCADAfence.Asset.Conn.port
      description: another endpoint's port
      type: number
    - contextPath: SCADAfence.Asset.Conn.proto
      description: L4 protocol used for the connection
      type: string
    - contextPath: SCADAfence.Asset.Conn.traffic
      description: total bytes sent (both directions)
      type: number
    - contextPath: SCADAfence.Asset.Conn.hostname
      description: another endpoint's hostname
      type: string
    - contextPath: SCADAfence.Asset.Conn.mac
      description: another endpoint's MAC address
      type: string
  - arguments:
    - description: optional - ip address of the asset
      name: ipAddress
    - description: optional - MAC address of the asset
      name: macAddress
    - description: optional - hostname of the asset
      name: hostName
    description: fetch asset network activity data  by one or more (combined) parameters
    name: scadafence-getAssetTraffic
    outputs:
    - contextPath: SCADAfence.AssetTraffic.TCP_tx_bytes
      description: bytes sent by the asset via TCP
      type: number
    - contextPath: SCADAfence.AssetTraffic.TCP_rx_bytes
      description: bytes received by the asset via TCP
      type: number
    - contextPath: SCADAfence.AssetTraffic.UDP_tx_bytes
      description: bytes sent by the asset via UDP
      type: number
    - contextPath: SCADAfence.AssetTraffic.UDP_rx_bytes
      description: bytes received by the asset via UDP
      type: number
  - arguments:
    - description: IP address of the asset that alert's related to
      name: ipAddress
      required: true
    - auto: PREDEFINED
      defaultValue: Information
      description: desired alert severity level
      name: severity
      predefined:
      - Information
      - Warning
      - Threat
      - Severe
      - Critical
      required: true
    - description: human readable alert description
      name: description
      required: true
    - defaultValue: not provided
      description: instructions on issue remediation
      name: remediationText
    - auto: PREDEFINED
      defaultValue: 'True'
      description: set active=True to make the alert appear on SCADAfence UI
      name: alertIsActive
      predefined:
      - 'True'
      - 'False'
      required: true
    description: create alert in SCADAfence CNM
    name: scadafence-createAlert
    outputs:
    - contextPath: SCADAfence.Alert.alertCreated
      description: flag defining alert creation status
      type: boolean
    - contextPath: SCADAfence.Alert.id
      description: unique ID set to a new alert
      type: string
  - arguments: []
    description: Fetches all connections from the CNM
    name: scadafence-getAllConnections
    outputs:
    - contextPath: SCADAfence.Connection.src_ip
      description: IP address of endpoint A
      type: string
    - contextPath: SCADAfence.Connection.dest_ip
      description: IP address of endpoint B
      type: string
    - contextPath: SCADAfence.Connection.src_port
      description: port of endpoint A
      type: number
    - contextPath: SCADAfence.Connection.dest_port
      description: port of endpoint B
      type: number
    - contextPath: SCADAfence.Connection.src_mac
      description: endpoint A MAC address
      type: string
    - contextPath: SCADAfence.Connection.dest_mac
      description: endpoint B MAC address
      type: string
    - contextPath: SCADAfence.Connection.src_cname
      description: endpoint A hostname
      type: string
    - contextPath: SCADAfence.Connection.dest_cname
      description: endpoint B hostname
      type: string
    - contextPath: SCADAfence.Connection.proto
      description: L4 protocol
      type: string
    - contextPath: SCADAfence.Connection.traffic
      description: total number of bytes sent in both directions
      type: number
  isfetch: true
  runonce: false
  script: "''' IMPORTS '''\nimport requests\nimport json\nimport sys\nfrom datetime\
    \ import datetime, timedelta\n# disable insecure warnings\nrequests.packages.urllib3.disable_warnings()\n\
    \n''' GLOBAL VARS '''\nAPI_URL= demisto.params()['APIUrl'].rstrip('/') + '/externalApi'\n\
    API_KEY=demisto.params()['APIKey']\nAPI_SECRET=demisto.params()['APISecret']\n\
    ALERT_SEVERITY = demisto.params()['AlertSeverity']\n\nUSE_SSL = not demisto.params().get('insecure',\
    \ False)\n\nif not demisto.params().get('proxy', False):\n    del os.environ['HTTP_PROXY']\n\
    \    del os.environ['HTTPS_PROXY']\n    del os.environ['http_proxy']\n    del\
    \ os.environ['https_proxy']\n\nDEFAULT_HEADERS = {\n    \"x-api-key\": API_KEY,\n\
    \    \"x-api-secret\": API_SECRET,\n    \"Accept\": \"application/json\",\n  \
    \  \"Content-Type\": \"application/x-www-form-urlencoded\"\n}\n\n\nSCADAFENCE_ALERT_SEVERITY_LEVEL\
    \ = {\n    'Information': 0,\n    'Warning': 1,\n    'Threat': 2,\n    'Severe':\
    \ 3,\n    'Critical': 4\n}\n\n''' HELPER FUNCTIONS '''\n\nINCIDENT_TYPES = {\n\
    \    \"IP conflict detected\": \"SCADAfence IP conlict\"\n}\n\ndef get_alert_severity():\n\
    \    \"\"\"\n    validate severity values provided as parameter\n    :return:\
    \ set: valid severity values\n    \"\"\"\n    s = ALERT_SEVERITY.replace(\" \"\
    ,\"\")\n    s_arr = s.split(\",\")\n    if sum(map(lambda x: x in ['Information','Warning','Threat','Severe','Critical'],\
    \ s_arr)) == len(s_arr):\n        return set(s_arr)\n    LOG(\"Invalid alert severity\
    \ values\")\n    raise Exception(\"Invalid alert severity values\")\n\ndef http_request(method,\
    \ url_suffix, params_dict, headers):\n    \"\"\"\n\n    :param method: string:\
    \ https method\n    :param url_suffix: string: API route\n    :param params_dict:\
    \ dict: request parameters\n    :param headers: dict: optional http headers\n\
    \    :return: dict: response data\n    \"\"\"\n    req_params = {\n    }\n   \
    \ if params_dict is not None:\n        req_params.update(params_dict)\n\n    url\
    \ = API_URL + url_suffix\n\n    LOG('running %s request with url=%s\\theaders=%s\\\
    nparams=%s' % (method, url, headers, json.dumps(req_params)))\n    res_msg = \"\
    \"\n    try:\n\n        if method in ['PATCH', 'POST']:\n            data = req_params\n\
    \            params = None\n        else:\n            params = req_params\n \
    \           data = None\n        res = requests.request(method,\n            url,\n\
    \            verify=USE_SSL,\n            data=data,\n            params=params,\n\
    \            headers=headers\n        )\n        if res.text:\n            res_msg\
    \ = res.text\n        res.raise_for_status()\n\n        if not res.text:\n   \
    \         return None\n        return json.loads(res.text)\n\n    except Exception,\
    \ e:\n        LOG(\"{}\\n{}\".format(e, res_msg))\n        raise Exception(\"\
    {}\\n{}\".format(e, res_msg))\n\n\ndef call_api(method, api_suffix, params):\n\
    \    \"\"\"\n    Call the requested API path and return its result\n    :param\
    \ api_path: A string beginning with '/' followed by the desired service\n    :rtype:\
    \ dict\n    :raises Exception: If the response code is not 200\n    :return the\
    \ response as a dict if possible, otherwise None\n    \"\"\"\n    return http_request(method,\
    \ api_suffix, params, DEFAULT_HEADERS)\n\ndef get_alerts(severity, ip, from_date):\n\
    \    \"\"\"\n    API caller\n    :param severity: string: required severity level\n\
    \    :param from_date: string: lower time limit\n    :return: call_api.http_request.data\n\
    \    \"\"\"\n    api_suffix = \"/alerts\"\n    return call_api('GET', api_suffix,\
    \ {'severity': severity, 'ip': ip, 'from': from_date})\n\ndef fetch_incidents():\n\
    \    \"\"\"\n    method for polling alerts from SCADAfence alerts API\n    :return:\
    \ list: demisto.incidents\n    \"\"\"\n    last_run = demisto.getLastRun()\n\n\
    \    last_updated = (datetime(1999, 1, 1, 0, 0, 0, 0), '1999-01-01T00:00:00.0Z')\n\
    \    if last_run and last_run.has_key('createdOn'):\n        ts_str = last_run.get('createdOn')\n\
    \        last_updated = (datetime.strptime(ts_str, '%Y-%m-%dT%H:%M:%S.%fZ'), ts_str)\n\
    \n    severities = get_alert_severity()\n\n    events = []\n    incidents = []\n\
    \    tmp_time = last_updated\n\n    for severity in severities:\n        events\
    \ = get_alerts(severity, None, last_updated[1])\n\n        for event in events:\n\
    \            event_ts = datetime.strptime(event['createdOn'], '%Y-%m-%dT%H:%M:%S.%fZ')\n\
    \            if event_ts > tmp_time[0]:\n                tmp_time = (event_ts,\
    \ event['createdOn'])\n\n            incident = {\n                'name': event['type'],\n\
    \                'occurred': event['createdOn'],\n                'severity':\
    \ SCADAFENCE_ALERT_SEVERITY_LEVEL[event['severity']],\n                'rawJSON':\
    \ json.dumps(event)\n            }\n            incidents.append(incident)\n \
    \   if tmp_time[0] > last_updated[0]:\n\n        demisto.setLastRun({\n      \
    \      'createdOn': tmp_time[1]\n        })\n\n    demisto.incidents(incidents)\n\
    \ndef map_optional_params(keys, api_keys):\n    \"\"\"\n    mapping Demisto parameters\
    \ to SCADAfence API parameters\n    :param keys: list: expected demisto parameters\n\
    \    :param api_keys: valid scadafence parameters\n    :return: dict: mapped current\
    \ function call parameters\n    \"\"\"\n    params = {}\n    param_keys = demisto.args().keys()\n\
    \    for i, key in enumerate(keys):\n        if key in param_keys:\n         \
    \   params[api_keys[i]] = demisto.args()[key]\n    return params\n\n\ndef get_assets(asset_data):\n\
    \    \"\"\"\n    getter for assets data by one or more parameters:\n    IP, hostame,\
    \ type (plc, hmi, IO, Telnel server etc)\n    :param asset_data: dict\n    :return:\
    \ call_api.http_request.res.text\n    \"\"\"\n    if asset_data:\n        api_suffix\
    \ = \"/assets\"\n        return call_api('GET', api_suffix, asset_data)\n    return_error(\"\
    Invalid call for assets data (missing parameters)\")\n\ndef get_asset_map(asset_details):\n\
    \    \"\"\"\n    fetches asset connection data by one or more (combined) parameters\n\
    \    :param asset_details: disct :{'ip': ip, 'host': hostname, 'mac': mac}\n \
    \   :return: call_api.http_request.res.text\n    \"\"\"\n    if asset_details:\n\
    \        api_suffix = \"/asset/map\"\n        return call_api('GET', api_suffix,\
    \ asset_details)\n    return_error(\"Invalid call for asset map (missing parameters)\"\
    )\n\ndef get_assets_map():\n    \"\"\"\n    fetches asset connection data by one\
    \ or more (combined) parameters\n    :param asset_details: disct :{'ip': ip, 'host':\
    \ hostname, 'mac': mac}\n    :return: call_api.http_request.res.text\n    \"\"\
    \"\n    api_suffix = \"/asset/map\"\n    return call_api('GET', api_suffix, None)\n\
    \ndef get_asset_traffic(asset_details):\n    \"\"\"\n    fetches asset connection\
    \ data by one or more (combined) parameters\n    :param asset_details: disct :{'ip':\
    \ ip, 'host': hostname, 'mac': mac}\n    :return: call_api.http_request.res.text\n\
    \    \"\"\"\n    if asset_details:\n        api_suffix = \"/asset/traffic\"\n\
    \        return call_api('GET', api_suffix, asset_details)\n    return_error(\"\
    Invalid call for asset traffic (missing parameters)\")\n\ndef dest_endpoint(ep):\n\
    \    return {\n            'ip': ep['dest_ip'],\n            'mac': ep['dest_mac'],\n\
    \            'hostname': ep['dest_hostname'],\n            'port': ep['dest_port'],\n\
    \            'proto': ep['proto'],\n            'traffic': ep['traffic']\n   \
    \     }\n\ndef src_endpoint(ep):\n    return {\n            'ip': ep['src_ip'],\n\
    \            'mac': ep['src_mac'],\n            'hostname': ep['src_hostname'],\n\
    \            'port': ep['src_port'],\n            'proto': ep['proto'],\n    \
    \        'traffic': ep['traffic']\n        }\n\ndef get_endpoint_data(data):\n\
    \    ret = []\n    for ep in data:\n        if 'ipAddress' in demisto.args().keys():\n\
    \            if demisto.args()['ipAddress'] == ep['src_ip']:\n               \
    \ ret.append(dest_endpoint(ep))\n            else:\n                ret.append(src_endpoint(ep))\n\
    \n        elif 'macAddress' in demisto.args().keys():\n            if demisto.args()['macAddress']\
    \ == ep['src_mac']:\n                ret.append(dest_endpoint(ep))\n         \
    \   else:\n                ret.append(src_endpoint(ep))\n\n        else:\n   \
    \         if demisto.args()['hostName'] == ep['src_hostname']:\n             \
    \   ret.append(dest_endpoint(ep))\n            else:\n                ret.append(src_endpoint(ep))\n\
    \    return ret\n\n# The command demisto.command() holds the command sent from\
    \ the user.\nif demisto.command() == 'test-module':\n    # This is the call made\
    \ when pressing the integration test button.\n    get_alerts('Critical', None,\
    \ None)\n    demisto.results('ok')\n    sys.exit(0)\n\nelif demisto.command()\
    \ == 'scadafence-createAlert':\n\n    ip = demisto.args()['ipAddress']\n    severity\
    \ = demisto.args()['severity']\n    description = demisto.args()['description']\n\
    \    active = demisto.args()['alertIsActive']\n    remediation = demisto.args()['remediationText']\n\
    \n    api_suffix = \"/alert\"\n    alert_data = {\n        'ip': ip,\n       \
    \ 'severity': severity,\n        'details': description,\n        'active': active,\n\
    \        'remediation': remediation\n    }\n    data = call_api('POST', api_suffix,\
    \ alert_data)\n    \n    demisto.results({\n        'Type': entryTypes['note'],\n\
    \        'Contents': data,\n        'ContentsFormat': formats['json'],\n     \
    \   'ReadableContentsFormat': formats['markdown'],\n        'HumanReadable': tableToMarkdown('Create\
    \ alert:', data),\n        'EntryContext': {\n            'SCADAfence.Alert':\
    \ data\n        }\n    })\n\nelif demisto.command() == 'scadafence-getAlerts':\n\
    \    ip = None\n    severity = None\n    if 'ipAddress' in demisto.args():\n \
    \       ip = demisto.args()['ipAddress']\n    if 'severity' in demisto.args():\n\
    \        severity = demisto.args()['severity']\n    data = get_alerts(severity,\
    \ ip, None)\n    output = []\n    for alert in data:\n        output.append({\n\
    \                    'status': alert['status'],\n                    'severity':\
    \ alert['severity'],\n                    'ip': alert['ip'],\n               \
    \     'details': alert['details'],\n                    'id': alert['id'],\n \
    \                   'remediation': alert['remediation']\n                })\n\
    \    md = tableToMarkdown('SCADAfence alerts', output)\n    demisto.results({\n\
    \        'Type': entryTypes['note'],\n        'Contents': data,\n        'ContentsFormat':\
    \ formats['json'],\n        'ReadableContentsFormat': formats['markdown'],\n \
    \       'HumanReadable': md,\n        'EntryContext': {\n            'SCADAfence.Alert(val.id==obj.id)':\
    \ output\n        }\n    })\n\nelif demisto.command() == 'scadafence-setAlertStatus':\n\
    \    api_suffix = \"/alerts/\" + demisto.args()['alertId']\n    alert_status =\
    \ demisto.args()['alertStatus']\n    call_api('PATCH', api_suffix, {'status':\
    \ alert_status})\n    md = tableToMarkdown(\"Setting status for alert \" + demisto.args()['alertId']\
    \ + \" to '\" + alert_status + \"':\",{\"success\": True})\n    demisto.results({\n\
    \        'Type': entryTypes['note'],\n        'Contents': {\"status\": alert_status},\n\
    \        'ContentsFormat': formats['json'],\n        'ReadableContentsFormat':\
    \ formats['markdown'],\n        'HumanReadable': md,\n        'EntryContext':\
    \ {\n            'SCADAfence.Alert.status': alert_status\n        }\n    })\n\n\
    \nelif demisto.command() == 'scadafence-getAsset':\n    params = map_optional_params(['ipAddress',\
    \ 'hostName', 'assetType'], ['ip', 'host', 'type'])\n    data = get_assets(params)\n\
    \    md = tableToMarkdown('Asset details: ', data)\n\n    demisto.results({\n\
    \        'Type': entryTypes['note'],\n        'Contents': data,\n        'ContentsFormat':\
    \ formats['json'],\n        'ReadableContentsFormat': formats['markdown'],\n \
    \       'HumanReadable': md,\n        'EntryContext': {\n            'SCADAfence.Asset(val.ip==obj.ip)':\
    \ data\n        }\n    })\n\nelif demisto.command() == 'scadafence-getAssetConnections':\n\
    \    params = map_optional_params(['ipAddress', 'macAddress', 'hostName'], ['ip',\
    \ 'mac', 'host'])\n    data = get_asset_map(params)\n    result = get_endpoint_data(data)\n\
    \    md = tableToMarkdown('Asset connections: ', result)\n    demisto.results({\n\
    \        'Type': entryTypes['note'],\n        'Contents': result,\n        'ContentsFormat':\
    \ formats['json'],\n        'ReadableContentsFormat': formats['markdown'],\n \
    \       'HumanReadable': md,\n        'EntryContext': {\n            'SCADAfence.Asset.Conn(val.ip==obj.ip)':result\n\
    \        }\n    })\n\nelif demisto.command() == 'scadafence-getAllConnections':\n\
    \    data = get_assets_map()\n    md = tableToMarkdown('Asset connections: ',\
    \ data)\n\n    demisto.results({\n        'Type': entryTypes['note'],\n      \
    \  'Contents': data,\n        'ContentsFormat': formats['json'],\n        'ReadableContentsFormat':\
    \ formats['markdown'],\n        'HumanReadable': md,\n        'EntryContext':\
    \ {\n            'SCADAfence.Connection': data\n        }\n    })\n\nelif demisto.command()\
    \ == 'scadafence-getAssetTraffic':\n\n    params = map_optional_params(['ipAddress',\
    \ 'macAddress', 'hostName'], ['ip', 'mac', 'host'])\n    data = get_asset_traffic(params)\n\
    \    data_x = {\n                'TCP_tx_bytes': data['TCP']['Bytes sent'],\n\
    \                'TCP_rx_bytes': data['TCP']['Bytes received'],\n            \
    \    'UDP_tx_bytes': data['UDP']['Bytes sent'],\n                'UDP_rx_bytes':\
    \ data['UDP']['Bytes received']\n            }\n    md = tableToMarkdown('Asset\
    \ network activity: ', data_x)\n    demisto.results({\n        'Type': entryTypes['note'],\n\
    \        'Contents': data,\n        'ContentsFormat': formats['json'],\n     \
    \   'ReadableContentsFormat': formats['markdown'],\n        'HumanReadable': md,\n\
    \        'EntryContext': {\n            'SCADAfence.AssetTraffic': data_x\n  \
    \      }\n    })\n\nelif demisto.command() == 'fetch-incidents':\n    demisto.incidents(fetch_incidents())\n\
    \n"
  subtype: python2
  type: python
tests:
- SCADAfence_test
toversion: 4.1.9
