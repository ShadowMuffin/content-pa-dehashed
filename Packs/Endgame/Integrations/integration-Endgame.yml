category: Endpoint
commonfields:
  id: Endgame
  version: -1
configuration:
- defaultvalue: https://localhost:2443
  display: 'Server URL (Example: https://me.endgame.com:2443)'
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: Username
  name: username
  required: true
  type: 9
- defaultvalue: 'false'
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: 'false'
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Endpoint protection built to stop advanced attacks before damage and
  loss occurs
display: Endgame
image: data:image/png;base64,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
name: Endgame
script:
  commands:
  - arguments:
    - description: Deployment domain
      name: domain
      required: true
    - description: Machine username
      name: username
      required: true
    - description: Machine password
      name: password
      required: true
    - description: API key
      name: api_key
      required: true
    - description: The ID of the sensor profile to be deployed. To get the ID, run
        the `!endgame-get-deployment-profiles` command.
      name: deployment_profile
      required: true
    - description: The ID of the last transaction. To get the ID, run the `!endgame-get-unmanaged-endpoints`
        command or the `endgame-get-endpoint-status` command. The value is available
        from the ${EndGame.TransactionID} context key.
      name: endpoints_transaction_id
    - description: The IDs of endpoints to be deployed. Must also provide IPs. To
        get the IDs, run the `!endgame-get-unmanaged-endpoints` command, and copy
        the ID (not to be confused with the machine ID).
      name: endpoint_ids
    - description: The IP addresses of endpoints to be deployed. Must also provide
        IDs.
      name: endpoint_ips
    description: 'Deploy sensor profile to unmanaged endpoints. '
    name: endgame-deploy
    outputs:
    - contextPath: EndGame.Deployment.DeploymentProfile
      description: The deployed sensor profile
    - contextPath: EndGame.Deployment.Domain
      description: The deployed domain
    - contextPath: EndGame.Deployment.Submitted.Id
      description: Deploy ID
  - arguments: []
    description: Get all deployment (sensor) profiles
    name: endgame-get-deployment-profiles
    outputs:
    - contextPath: EndGame.SensorProfiles.ApiKey
      description: API Key of sensor profile
    - contextPath: EndGame.SensorProfiles.Id
      description: ID of sensor profile
    - contextPath: EndGame.SensorProfiles.SensorDirectory
      description: DIrectory of the sensor profile
    - contextPath: EndGame.SensorProfiles.Name
      description: Name of sensor profile
    - contextPath: EndGame.SensorProfiles.UpdatedAt
      description: Last time sensor was updated
    - contextPath: EndGame.SensorProfiles.Receiver
      description: Receiver IP address
    - contextPath: EndGame.SensorProfiles.CreatedAt
      description: Date and time sensor was created
    - contextPath: EndGame.SensorProfiles.SensorVersion
      description: Version of sensor
    - contextPath: EndGame.SensorProfiles.Config
      description: Sensor profile configuration
  - arguments: []
    description: Get all unmanaged endpoint details
    name: endgame-get-unmanaged-endpoints
    outputs:
    - contextPath: EndGame.TransactionID
      description: ID of transaction to use when deploying
    - contextPath: EndGame.Endpoints.MachineId
      description: Endgame ID of the machine
    - contextPath: EndGame.Endpoints.CoreOs
      description: Core OS of the machine
    - contextPath: EndGame.Endpoints.Name
      description: Name of the machine
    - contextPath: EndGame.Endpoints.Status
      description: Status of hte machine
    - contextPath: EndGame.Endpoints.IpAddress
      description: IP address of the machine
    - contextPath: EndGame.Endpoints.UpdatedAt
      description: Last updates time
    - contextPath: EndGame.Endpoints.ID
      description: Endpoint ID
  - arguments:
    - description: IP address of machine
      name: ip_address
    - description: Name of machine
      name: name
    - description: EndGame machine ID
      name: machine_id
    description: Get specified endpoint status. Must provide at least one argument
    name: endgame-get-endpoint-status
    outputs:
    - contextPath: EndGame.TransactionID
      description: id of transaction to use when deploying
    - contextPath: EndGame.Endpoints.MachineId
      description: Endgame id of the machine
    - contextPath: EndGame.Endpoints.CoreOs
      description: Core OS of the machine
    - contextPath: EndGame.Endpoints.Name
      description: Name of the machine
    - contextPath: EndGame.Endpoints.Status
      description: Status of hte machine
    - contextPath: EndGame.Endpoints.IpAddress
      description: IP address of the machine
    - contextPath: EndGame.Endpoints.UpdatedAt
      description: Last updates time
  - arguments:
    - description: Name of sensor profile
      name: name
      required: true
    - description: Transceiver address of sensor profile
      name: transceiver
      required: true
    - description: Version of sensor profile
      name: sensor_version
      required: true
    - description: API key of sensor profile
      name: api_key
      required: true
    - description: Sensor profile directory
      name: sensor_directory
      required: true
    description: Create deployment (sensor) profile
    name: endgame-create-sensor-profile
    outputs:
    - contextPath: EndGame.SensorProfiles.Id
      description: EndGame ID of created sensor profile
    - contextPath: EndGame.SensorProfiles.Name
      description: Name of created sensor profile
  - arguments: []
    description: Get all endgame investigations
    name: endgame-get-investigations
    outputs:
    - contextPath: EndGame.Investigations.TaskCompletion
      description: Task completion status
    - contextPath: EndGame.Investigations.Name
      description: Name of investigation
    - contextPath: EndGame.Investigations.EndpointCount
      description: Number of endpoints for investigation
    - contextPath: EndGame.Investigations.CreatedAt
      description: Time created
    - contextPath: EndGame.Investigations.UpdatedAt
      description: Time last updated
    - contextPath: EndGame.Investigations.UserDisplayName
      description: Display name of user that created th investigation
    - contextPath: EndGame.Investigations.CoreOs
      description: Core OS of investigation
  - arguments:
    - description: Name of investigation
      name: investigation_name
      required: true
    - description: Sensor ID's of machines to investigate. Overrides endpoints argument
      name: sensors
    - description: Names of machines to investigate. Overridden by sensors argument
      name: endpoints
    - description: Default is the username given in the instance credentials
      name: assign_to
    - description: local ip address for network search
      name: network_local_ip
    - description: protocol for netwprk search
      name: network_protocol
    - description: remote ips (comma separated) for network search
      name: network_remote_ips
    - description: port for network search
      name: network_port
    - description: true for remote, false otherwise. Used for network search
      name: network_remote
    - description: name of process to search
      name: process
    - description: sha1s of process (comma separated)
      name: process_sha1s
    - description: md5s of process (comma separated)
      name: process_md5s
    - description: sha256s of process (comma separated)
      name: process_sha256s
    - defaultValue: 'C:'
      description: Directory of file to search
      name: file_dir
    - description: regexes of file to search
      name: file_regexes
    - description: sha256s of files to search (comma separated)
      name: file_sha256s
    - description: sha1s of files to search (comma separated)
      name: file_sha1s
    - description: md5s of files to search (comma separated)
      name: file_md5s
    - description: Registry Key or Value Name Containing
      name: registry_key
    - description: max size of registry to search
      name: registry_max_size
    - description: min size of registry to search
      name: registry_min_size
    - description: Domain to search
      name: user_search_domain
    - description: username to search
      name: user_search
    description: 'Create endgame IOC investigation. '
    name: endgame-create-investigation
    outputs:
    - contextPath: EndGame.Investigations.Id
      description: Id of created investigation
  - arguments:
    - description: ID of sensor profile
      name: sensor_id
      required: true
    description: Get sensor data by id
    name: endgame-get-sensor
    outputs:
    - contextPath: EndGame.SensorProfiles.Config
      description: Sensor profile configuration details
    - contextPath: EndGame.SensorProfiles.ApiKey
      description: API key of sesnor profile
    - contextPath: EndGame.SensorProfiles.AccountId
      description: Account ID
    - contextPath: EndGame.SensorProfiles.Name
      description: Name of sensor profile
    - contextPath: EndGame.SensorProfiles.UpdatedAt
      description: Date and time sensor was last changed
    - contextPath: EndGame.SensorProfiles.Receiver
      description: Receiver of sensor profile
    - contextPath: EndGame.SensorProfiles.SensorDirectory
      description: Directory of sensor profile
    - contextPath: EndGame.SensorProfiles.Deleted
      description: Is sensor profile deleted
    - contextPath: EndGame.SensorProfiles.CreatedAt
      description: Date and time sensor profile was created
    - contextPath: EndGame.SensorProfiles.Id
      description: Id of sensor
    - contextPath: EndGame.SensorProfiles.SensorVersion
      description: Version of given sensor
  - arguments:
    - description: Id of investigation
      name: investigation_id
    description: Get investigation results by id
    name: endgame-investigation-results
    outputs:
    - contextPath: EndGame.InvestigationResults.Files
      description: File investigation results
    - contextPath: EndGame.InvestigationResults.Usernames
      description: Username investigation results
    - contextPath: EndGame.InvestigationResults.Processes
      description: Processes investigation results
    - contextPath: EndGame.InvestigationResults.Registries
      description: Registries investigation results
    - contextPath: EndGame.InvestigationResults.Networks
      description: Networks investigation results
  - arguments:
    - description: Id of investigation
      name: investigation_id
      required: true
    description: Returns the current investigation status
    name: endgame-investigation-status
    outputs:
    - contextPath: EndGame.Investigations.Id
      description: Endgame ID of investigation
    - contextPath: EndGame.Investigations.Status
      description: Endgame investigation status
  script: "var host = params.url;\nvar insecure = params.insecure;\nvar proxy = params.proxy;\n\
    var username = params.username.identifier;\nvar password = params.username.password;\n\
    var loginArgs = { username : username, password : password };\nvar headers = {\
    \ 'Content-Type': ['application/json'] };\nvar token = params.token;\n\nvar makeArray\
    \ = function(obj){\n    if(obj && !Array.isArray(obj))\n     return [obj];\n \
    \   else return obj;\n};\n\nvar headerTransform = function(dict){\n    return\
    \ function(obj){\n        return dict[obj];\n    };\n};\n\n//returns single object\
    \ withing entity (i.e. File[0])\nvar jsonToEntityObject = function(origObj, keyTransform){\n\
    \    var ret = {};\n    for(var key in origObj){\n        if(keyTransform(key)){\n\
    \            ret[keyTransform(key)] = dq(origObj, key);\n        }\n    }\n  \
    \  return ret;\n};\n\n//returns entire entity array (i.e. File)\nvar jsonToEntity\
    \ = function(origObj, keyTransform){\n    var j;\n    if(!Array.isArray(origObj)){\n\
    \        return jsonToEntityObject(origObj, keyTransform);\n    }\n    else if(origObj.length\
    \ > 0){ //makes sure no empty arrays are pushed\n        var ret = [];\n     \
    \   for(j=0; j<origObj.length; j++){\n            ret.push(jsonToEntityObject(origObj[j],\
    \ keyTransform));\n        }\n        return ret;\n    }\n};\n\nvar commandToResult\
    \ = {\n    'endgame-deploy' : [{\n        contextPath : 'EndGame.Deployment(val.Key==obj.Key)',\n\
    \        title: 'Deployment Status',\n        MDdata:{\n            'deployment_profile':\
    \ 'Sensor ID',\n            'domain': 'Domain',\n            'id': 'Deploy ID'\n\
    \        }\n    }],\n    'endgame-get-deployment-profiles' : [{\n        contextPath\
    \ : 'EndGame.SensorProfiles(val.Id==obj.Id)',\n        title: 'Deployment Profiles',\n\
    \        MDdata:{\n            'api_key': 'API Key',\n            'created_at':'Created\
    \ At',\n            'id':'ID',\n            'name':'Name',\n            'receiver':'Receiver',\n\
    \            'sensor_directory':'Sensor Directory',\n            'sensor_version':'Sensor\
    \ Version',\n            'updated_at':'Updated At'\n        }\n    }],\n    'endgame-get-unmanaged-endpoints'\
    \ : [{\n        contextPath : 'EndGame.Endpoints(val.Id==obj.Id)',\n        title:\
    \ 'Unmanagaed Endpoints',\n        MDdata:{\n            'core_os': 'Core OS',\n\
    \            'created_at': 'Created At',\n            'id': 'ID',\n          \
    \  'name': 'Name',\n            'display_operating_system': 'Display Operating\
    \ System',\n            'domain': 'Domain',\n            'machine_id': 'Machine\
    \ ID',\n            'status': 'Status',\n            'mac_address' : 'MAC Address',\n\
    \            'operating_system' : 'Operating System',\n            'ip_address'\
    \ : 'IP Address'\n        }\n    }],\n    'endgame-get-endpoint-status' : [{\n\
    \        contextPath : 'EndGame.Endpoints(val.MachineId==obj.MachineId)',\n  \
    \      title: 'Endpoint Status',\n        MDdata:{\n            'status': 'Status',\n\
    \            'machine_id':'Machine ID',\n            'ip_address' : 'Machine IP',\n\
    \            'hostname' : 'Name'\n        }\n    }],\n    'endgame-create-sensor-profile'\
    \ : [{\n        contextPath : 'EndGame.SensorProfiles(val.Id==obj.Id)',\n    \
    \    title: 'Sensor Profile',\n        MDdata:{\n            'id':'ID',\n    \
    \        'name':'Name'\n        }\n    }],\n    'endgame-get-sensor' : [{\n  \
    \      contextPath : 'EndGame.SensorProfiles(val.Id==obj.Id)',\n        title:\
    \ 'Deployment Profile',\n        MDdata:{\n            'api_key': 'API Key',\n\
    \            'created_at':'Created At',\n            'id':'ID',\n            'name':'Name',\n\
    \            'receiver':'Receiver',\n            'sensor_directory':'Sensor Directory',\n\
    \            'sensor_version':'Sensor Version',\n            'updated_at':'Updated\
    \ At'\n        }\n    }],\n    'endgame-create-investigation' : [{\n        contextPath\
    \ : 'EndGame.Investigations(val.Id==obj.Id)',\n        title: 'Investigation',\n\
    \        MDdata:{\n            'id' : 'ID'\n        }\n    }],\n    'endgame-get-investigations'\
    \ : [{\n        contextPath : 'EndGame.Investigations(val.Id==obj.Id)',\n    \
    \    title: 'Investigations',\n        MDdata:{\n            'id':'ID',\n    \
    \        'core_os' : 'Core OS',\n            'created_by_user_display_name' :\
    \ 'Created By',\n            'hunt_count' : 'Hunt Count',\n            'name'\
    \ : 'Name',\n            'updated_at' : 'Updated At',\n            'user_display_name'\
    \ : 'User'\n        }\n    }]\n};\n\nvar sendRequest = function(url, method, queryParams,\
    \ data, isLogout) {\n    if (url[url.length - 1] === '/') {\n        url = url.substring(0,\
    \ url.length - 1);\n    }\n\n    var requestUrl = host + url;\n    if (queryParams)\
    \ {\n        requestUrl += encodeToURLQuery(queryParams);\n    }\n\n    var res\
    \ = http(\n        requestUrl,\n        {\n            Method: method,\n     \
    \       Headers: headers,\n            Body: data? JSON.stringify(data) : undefined\n\
    \        },\n        insecure,\n        proxy\n    );\n\n    if (res.StatusCode\
    \ >= 300 || res.StatusCode < 200) {\n        if(token && !isLogout){\n       \
    \       logout();\n        }\n        throw 'Request Failed.\\nStatus code: '\
    \ + res.StatusCode + '.\\nResponse Body: ' + res.Body;\n    }\n    try {\n   \
    \     return JSON.parse(res.Body);\n    } catch (err) {\n        return res.Body;\n\
    \    }\n\n};\n\nvar get = function(url, queryParams, isLogout){\n    return sendRequest(url,\
    \ 'GET', queryParams, undefined, isLogout);\n};\n\nvar post = function(url, queryParams,\
    \ data){\n    return sendRequest(url, 'POST', queryParams, data);\n};\n\nvar login\
    \ = function(){\n    if (!token) {\n        try {\n            resp = post('/api/v1/auth/login',\
    \ undefined, loginArgs);\n            token = resp.metadata.token;\n         \
    \   headers = { 'Content-Type': ['application/json'], 'Authorization': ['JWT '\
    \ + token] };\n        } catch (err) {\n            throw 'ERROR: failure while\
    \ authenticating to platform: ' + err;\n        }\n    }\n};\n\nvar logout = function(){\n\
    \    return get('/api/v1/auth/logout/', undefined, true);\n};\n\n/**** Get Commands\
    \ ****/\nvar getDeploymentProfiles = function(){\n    return get('/api/v1/deployment-profiles/').data;\n\
    };\n\nvar getUnmanagedEndpoints = function(){\n    return get('/api/v1/endpoints/',\
    \ {'core_os' : 'windows', 'status':'not-installed'});\n};\n\nvar getUsers = function(){\n\
    \    return get('/api/v1/users');\n};\n\nvar getInvestigations = function(){\n\
    \    return get('/api/v1/investigations?archived=false').data;\n};\n\nvar getSensor\
    \ = function(sensor_id){\n    return get('/api/v1/deployment-profiles/'+sensor_id).data;\n\
    };\n\nvar getUserID = function(name){\n    res = getUsers().data;\n        for(var\
    \ i=0; i<res.length; i++){\n            if(res[i].username === name){\n      \
    \          return res[i].id;\n            }\n        }\n    return -1;\n};\n\n\
    var getSensorIDs = function(endpoints){\n    var ret= [];\n        var res = get('/api/v1/sensors').results;\n\
    \        if(!Array.isArray(endpoints)){\n            endpoints = [endpoints];\n\
    \        }\n        for(var i=0; i<endpoints.length; i++){\n            for(var\
    \ j=0; j<res.length; j++){\n                if(endpoints[i] === res[j].endpoint.name){\n\
    \                    ret.push(res[j].id);\n                }\n            }\n\
    \        }\n    return ret;\n};\n\nvar getEndpointStatus = function(args){\n \
    \   if(!args.ip_address && !args.name && !args.machine_id)\n        throw 'Missing\
    \ arguments. Must have one of the following: ip, name, uuid';\n    var res = get('/api/v1/endpoints',\
    \ args);\n    return res.data[0];\n};\n\nvar getInvestigationStatus = function(inv_id){\n\
    \    var task_completion = get('/api/v1/investigations/'+inv_id+'/').data.task_completion;\n\
    \    var completed = task_completion.completed_tasks;\n    var total = task_completion.total_tasks;\n\
    \    var context = {};\n    var md = '';\n    if(total === completed){\n     \
    \   md = 'Investigation Completed';\n        context['EndGame.Investigations(val.Id=='+inv_id+')']\
    \ = {'Status' : 'completed', 'Id':inv_id};\n    }\n    else{\n        md = 'Investigation\
    \ not completed';\n        context['EndGame.Investigations(val.Id==obj.Id)'] =\
    \ {'Status' : completed+'/'+total, 'Id' : inv_id};\n    }\n    return {\n    \
    \    Type: entryTypes.note,\n        Contents: task_completion,\n        ContentsFormat:\
    \ formats.json,\n        ReadableContentsFormat : formats.notes,\n        EntryContext\
    \ : context,\n        HumanReadable: md\n    };\n};\n\nvar getInvestigationResults\
    \ = function(inv_id){\n    var task_types = {'user_sessions':'Usernames', 'file_list':'Files',\
    \ 'processes':'Processes', 'connections':'Networks', 'values':'Registries'};\n\
    \    var task_type_keys = Object.keys(task_types);\n    var contents = [];\n \
    \   var tasks = makeArray(get('/api/v1/investigations/'+inv_id+'/').data.tasks);\n\
    \    var context = {};\n    var md = '';\n    for(var i=0; i<tasks.length; i++){\n\
    \        var collection_id = get('/api/v1/tasks/'+tasks[i]).data.tasks[0].metadata.collection_id;\n\
    \        for(var j=0; j<task_type_keys.length;j++){\n            var results =\
    \ get('/api/v1/collections/'+collection_id+'/?scope='+task_type_keys[j]).data.data.results;\n\
    \            if(results && Array.isArray(results) && results.length > 0){\n  \
    \              context[task_types[task_type_keys[j]]] = results;\n           \
    \     md += tableToMarkdown('Investigation '+task_types[task_type_keys[j]]+' Results',\
    \ results);\n                contents.push(results);\n            }\n        }\n\
    \    }\n    return {\n        Type: entryTypes.note,\n        Contents: contents,\n\
    \        ContentsFormat: formats.json,\n        ReadableContentsFormat : formats.markdown,\n\
    \        EntryContext : {'EndGame.InvestigationResults' : context},\n        HumanReadable:\
    \ md\n    };\n}\n\n/**** Create / Set Commands ****/\nvar createSensorProfile\
    \ = function(name, receiver, sensor_version, sensor_directory, api_key){\n   \
    \ reqBody = {\n        'name' : name,\n        'receiver' : receiver,\n      \
    \  'sensor_version' : sensor_version,\n        'sensor_directory' : sensor_directory,\n\
    \        'api_key' : api_key,\n        'config':{\n            'Mitigation':{\n\
    \                'dbi_dll_name':'esensordbi.dll',\n                'popup_exe_name':'useralert.exe'\n\
    \            },\n            'Kernel':{\n                'sys_name':'esensor.sys',\n\
    \                'service_name':'esensordrv',\n                'service_display_name':'esensordrv'\n\
    \            },\n            'Installation':{\n                'dll_path':'%SYSTEMROOT%\\\
    \\System32\\\\esensor.exe',\n                'service_name':'esensor',\n     \
    \           'service_display_name':'EndpointSensor'\n            }\n        }\n\
    \    };\n    res =  post('/api/v1/deployment-profiles/', undefined, reqBody).data;\n\
    \    res.id = res.success? res.success : 'Sensor profile creation failed';\n \
    \   res.success = undefined;\n    res.name = name;\n    return res;\n}\n\nvar\
    \ createInvestigation = function(name, assignee, sensors, endpoints, args){\n\
    \        var taskDescriptions = get('/api/v1/task-descriptions/').data;\n    \
    \    var iocTaskId = '35b6f686-dece-545f-8314-56936abec6ba';\n        for(var\
    \ i=0; i<taskDescriptions.length; i++){\n            if(taskDescriptions[i]['name']\
    \ === 'iocSearchRequest' && taskDescriptions[i]['sensor_type'] === 'windows'){\n\
    \                log('found it!');\n                iocTaskId = taskDescriptions[i]['id'];\n\
    \                break;\n            }\n        }\n        url = '/api/v1/investigations';\n\
    \        reqBody = {\n            'name' : name,\n            'assign_to' : assignee,\n\
    \            'sensor_ids' : sensors ? (makeArray(sensors)) : getSensorIDs(endpoints),\n\
    \            'tasks': {},\n            'assign_to': getUserID(assignee? assignee\
    \ : params.username),\n            'core_os' : 'windows'\n        };\n       \
    \ reqBody.tasks[iocTaskId] = {'task_list' : createTask(args)}\n        return\
    \ post(url, undefined, reqBody).data;\n};\n\nvar deploy = function(domain, username,\
    \ password, api_key, endpoint_transaction, deployment_order, endpoint_ips, endpoint_ids){\n\
    \    url = '/api/v1/deploy';\n    requestBody = {\n        'username' : username,\n\
    \        'password' : password,\n        'domain' : domain,\n        'api_key'\
    \ : api_key,\n        'deployment_order' : deployment_order\n    };\n\n    if(endpoint_transaction){\n\
    \      requestBody['endpoint_transaction'] = endpoint_transaction;\n    }\n\n\
    \    else if(endpoint_ips && endpoint_ids){\n        if(endpoint_ips.length !==\
    \ endpoint_ids.length){\n            throw 'IP addresses don\\'t match Endpoint\
    \ IDs'\n        }\n        var targets = [];\n        for(var i=0; i<endpoint_ips.length;\
    \ i++){\n            targets.push({'ip_address' : endpoint_ips[i], 'endpoint_uuid'\
    \ : endpoint_ids[i]});\n        }\n        requestBody['targets'] = targets;\n\
    \    }\n    res = post(url, undefined, requestBody);\n    return res.data;\n};\n\
    \nvar createTask = function(args){\n    task = [];\n    if(args.network_local_ip\
    \ || args.network_remote_ips || args.network_port){\n        task.push({\n   \
    \        'network_search':{\n              'with_state':'ANY',\n             \
    \ 'find_local_ip_address': args.network_local_ip,\n              'protocol': args.network_protocol,\n\
    \              'find_remote_ip_address':makeArray(args.network_remote_ips),\n\
    \              'port':{\n                    'port':args.network_port,\n     \
    \               'key': args.network_remote === 'false' ? 'local' : 'remote'\n\
    \                }\n            }\n        });\n    }\n    if(args.process_md5s\
    \ || args.process_sha256s || args.process_sha1s || args.process){\n        task.push({\n\
    \           \"process_search\":{\n              \"with_md5_hash\":makeArray(args.process_md5s),\n\
    \              \"with_sha256_hash\":makeArray(args.process_sha256s),\n       \
    \       \"with_sha1_hash\":makeArray(args.process_sha1s),\n              \"find_process\"\
    :args.process\n           }\n        });\n    }\n    if(args.file_md5s || args.file_sha256s\
    \ || args.file_sha1s){\n        task.push({\n           'file_search':{\n    \
    \            'with_md5_hash':makeArray(args.file_md5s),\n                'with_sha1_hash':makeArray(args.file_sha1s),\n\
    \                'with_sha256_hash':makeArray(args.file_sha256s),\n          \
    \      'regexes':makeArray(args.file_regexes),\n                'directory': args.file_dir\n\
    \            }\n        });\n    }\n    if(args.registry_key){\n        task.push({\n\
    \            'registry_search':{\n                'hive':'ALL',\n            \
    \    'min_size':args.registry_min_size,\n                'max_size':args.registry_max_size,\n\
    \                'key': makeAray(args.registry_key)\n            }\n        });\n\
    \    }\n    if(args.user_search || args.user_search_domain){\n        task.push({\n\
    \           'username_search':{\n                'find_username': makeArray(args.user_search),\n\
    \                'domain': args.user_search_domain\n            }\n        });\n\
    \    }\n    return task;\n};\n\nvar resToEntry = function(results){\n    currentCommand\
    \ = commandToResult[command];\n    var entries = [];\n    for (var j in currentCommand)\
    \ {\n        var current = currentCommand[j];\n        var entry = {\n       \
    \     Type: entryTypes.note,\n            Contents: results,\n            ContentsFormat:\
    \ formats.json,\n            ReadableContentsFormat : formats.markdown,\n    \
    \        EntryContext : {}\n        };\n        entry.HumanReadable = tableToMarkdown(current.title,\
    \ results, Object.keys(current.MDdata), undefined, headerTransform(current.MDdata));\n\
    \        entry.EntryContext[current.contextPath] = jsonToEntity(results, underscoreToCamelCase);\n\
    \        entries.push(entry);\n    }\n    return entries;\n}\n\nvar results;\n\
    login();\nswitch (command) {\n    case 'test-module':\n        return 'ok';\n\
    \    case 'endgame-investigation-results':\n        results = getInvestigationResults(args.investigation_id);\n\
    \        logout();\n        return results;\n    case 'endgame-investigation-status':\n\
    \        return getInvestigationStatus(args.investigation_id)\n    case 'endgame-get-unmanaged-endpoints':\n\
    \        results = getUnmanagedEndpoints();\n        res = resToEntry(results.data);\n\
    \        res[0].EntryContext['EndGame(true)'] = {'TransactionID' : results.metadata.transaction_id};\n\
    \        logout();\n        return res;\n    case 'endgame-get-deployment-profiles':\n\
    \        results = getDeploymentProfiles();\n        break;\n    case 'endgame-get-endpoint-status':\n\
    \        results = getEndpointStatus(args);\n        break;\n    case 'endgame-create-sensor-profile':\n\
    \        results = createSensorProfile(args.name, args.transceiver, args.sensor_version,\
    \ args.sensor_directory, args.api_key);\n        break;\n    case 'endgame-create-investigation':\n\
    \        results = createInvestigation(args.investigation_name, args.assign_to\
    \ ? args.assign_to : params.username.identifier, args.sensors, args.endpoints,\
    \ args);\n        break;\n    case 'endgame-get-investigations':\n        results\
    \ = getInvestigations();\n        break;\n    case 'endgame-get-sensor':\n   \
    \     results = getSensor(args.sensor_id);\n        break;\n    case 'endgame-deploy':\n\
    \        results = deploy(args.domain, args.username, args.password, args.api_key,\
    \ args.endpoints_transaction_id, args.deployment_profile, makeArray(args.endpoint_ips),\
    \ makeArray(args.endpoint_ids));\n        if(results.submitted){\n           \
    \ results.deployment_profile = args.deployment_profile;\n            results.id\
    \ = results.submitted;\n            results.domain = args.domain;\n          \
    \  results.submitted = undefined;\n        }\n        break;\n}\nlogout();\nreturn\
    \ resToEntry(results);"
  type: javascript
tests:
- No test - no instance
toversion: 4.1.9
