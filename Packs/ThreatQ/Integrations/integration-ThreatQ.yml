beta: true
category: Data Enrichment & Threat Intelligence
commonfields:
  id: ThreatQ_Beta
  version: -1
configuration:
- defaultvalue: ''
  display: TQ API URL E.g. https://192.168.1.136/api
  name: apiUrl
  required: true
  type: 0
- defaultvalue: ''
  display: TQ Client ID
  name: client_id
  required: true
  type: 0
- defaultvalue: ''
  display: Email
  name: credentials
  required: true
  type: 9
- defaultvalue: 'false'
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: 'false'
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: ThreatQ Integration
detaileddescription: "You must have a ThreatQ user account to retrieve an api token.\
  \ The api token is required for all api requests. \nThreatQ provides indicator scoring\
  \ weighting for indicators and their contextual information, such as sources, attributes,\
  \ and indicator types, as they are added to ThreatQ.\nFor detailed information on\
  \ ThreatQ scoring please refer to https://helpcenter.threatq.com/\n\nNote: This\
  \ is a beta Integration, which lets you implement and test pre-release software.\
  \ Since the integration is beta, it might contain bugs. Updates to the integration\
  \ during the beta phase might include non-backward compatible features. We appreciate\
  \ your feedback on the quality and usability of the integration to help us identify\
  \ issues, fix them, and continually improve."
display: ThreatQ_Beta
fromversion: 4.1.0
image: data:image/png;base64,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
name: ThreatQ_Beta
script:
  commands:
  - arguments:
    - default: true
      defaultValue: Naid
      description: keyword
      name: keyword
      required: true
    description: Search ThreatQ repository by keywords
    name: tq-search-by-name
    outputs:
    - contextPath: ThreatQ.description
      description: Description
  - arguments:
    - default: true
      defaultValue: 8.8.8.8
      description: IP address
      isArray: true
      name: ip
      required: true
    description: 'Run ip check against ThreatQ '
    name: ip
    outputs:
    - contextPath: ThreatQ.score
      description: ThreatQ score
    - contextPath: ThreatQ.name
      description: ThreatQ name
    - contextPath: DBotScore.Vendor
      description: DBotScore Vendor
    - contextPath: DBotScore.Malicious
      description: DBotScore Malicious status
  - arguments:
    - default: true
      defaultValue: www.google.com
      description: URL or FQDN
      isArray: true
      name: url
      required: true
    description: Run url check against ThreatQ
    name: url
    outputs:
    - contextPath: ThreatQ.score
      description: ThreatQ score
    - contextPath: ThreatQ.name
      description: ThreatQ name
    - contextPath: DBotScore.Vendor
      description: DBotScore Vendor
    - contextPath: DBotScore.Malicious
      description: DBotScore Malicious status
  - arguments:
    - default: true
      defaultValue: google.exe
      description: File name, MD5 or SHA
      isArray: true
      name: file
      required: true
    description: Run file check against ThreatQ
    name: file
    outputs:
    - contextPath: ThreatQ.score
      description: ThreatQ score
    - contextPath: ThreatQ.name
      description: ThreatQ name
    - contextPath: DBotScore.Vendor
      description: DBotScore Vendor
    - contextPath: DBotScore.Malicious
      description: DBotScore Malicious status
  runonce: false
  script: "''' IMPORTS '''\nimport os\nimport datetime\nimport requests\nimport json\n\
    \n# disable insecure warnings\nrequests.packages.urllib3.disable_warnings()\n\n\
    ''' GLOBAL VARS '''\n\nAPI_URL = demisto.params()['apiUrl']\nAPI_TOKEN_URL = API_URL\
    \ + \"/token\"\nCLIENT_ID = demisto.params()['client_id']\nEMAIL = demisto.getParam('credentials').get('identifier')\n\
    PASSWORD = demisto.getParam('credentials').get('password')\nUSE_SSL = not demisto.params().get('insecure',\
    \ False)\n\n\n''' HELPER FUNCTIONS '''\n\ndef load_proxy():\n    # Load the system\
    \ configured proxy if enabled in configuration\n    proxy = {}\n    if 'proxy'\
    \ in demisto.params():\n        proxy[\"http\"] = os.environ[\"http_proxy\"]\n\
    \        proxy[\"https\"] = os.environ[\"https_proxy\"]\n    return proxy\n\n\
    PROXY = load_proxy()\n\ndef get_errors_string_from_bad_request(bad_request_results):\n\
    \    errors_list = bad_request_results.json().get(\"errors\", [])\n    errors_string\
    \ = \"\"\n    error_num = 1\n    if errors_list:\n        errors_string = \"Errors\
    \ from server: \\n\"\n        for error in errors_list:\n            errors_string\
    \ += \"Error #{0}: {1}\\n\".format(error_num, error)\n            error_num +=\
    \ 1\n    return errors_string\n\n# ThreatQ auth based on OAuth 2.0 credential\
    \ grand method\ndef tq_access():\n    data = {'grant_type': 'password','email':\
    \ EMAIL, 'password': PASSWORD, 'client_id': CLIENT_ID}\n    access_token_response\
    \ = requests.post(API_TOKEN_URL, data=data, verify=False, allow_redirects=False)\n\
    \n    tokens = json.loads(access_token_response.text)\n    if int(access_token_response.status_code)\
    \ >= 400:\n        errors_string = get_errors_string_from_bad_request(access_token_response)\n\
    \        error_message = \"Authentication failed, unable to retrieve an access\
    \ token.\\n {}\".format(errors_string)\n        return_error(error_message)\n\n\
    \    new_integration_context = {\n        \"access_token\": tokens['access_token'],\n\
    \        \"access_token_creation_time\": int(time.time()) -1, # decrementing one\
    \ second to be on the safe side\n        \"access_token_expires_in\": tokens['expires_in']\n\
    \    }\n    demisto.setIntegrationContext(new_integration_context)\n    token\
    \ = tokens['access_token']\n    return token\n\n\ndef access_token_not_expired():\n\
    \        epoch_time_now = time.time()\n        epoch_time_when_token_granted =\
    \ demisto.getIntegrationContext().get(\"access_token_creation_time\")\n      \
    \  token_time_until_expiration = demisto.getIntegrationContext().get(\"access_token_expires_in\"\
    )\n        return int(epoch_time_now) - int(epoch_time_when_token_granted) < int(token_time_until_expiration)\n\
    \n\ndef get_access_token():\n    existing_access_token = demisto.getIntegrationContext().get(\"\
    access_token\")\n    if existing_access_token and access_token_not_expired():\n\
    \        return existing_access_token\n    else:\n        new_access_token = tq_access()\n\
    \        return new_access_token\n\n\n# remove html tags from ThreatQ description\
    \ field\ndef cleanhtml(raw_html):\n  cleanr = re.compile('<.*?>')\n  cleantext\
    \ = re.sub(cleanr, '', raw_html)\n  return cleantext\n\n\n''' Catch-all function\
    \ for all command '''\ndef query_tq(keyword):\n    '''\n    This function handles\
    \ all the querying of threatq\n    '''\n    tq_url = API_URL + \"/search?query=\"\
    \ + keyword\n    access_token = get_access_token()\n    api_call_headers = {'Authorization':\
    \ 'Bearer ' + access_token}\n    api_call_response = requests.get(tq_url, headers=api_call_headers,\
    \ verify=False)\n\n    response = json.loads(api_call_response.text)\n\n    #\
    \ Find ThreatQ object type and object id based on keyword search results\n\n \
    \   try:\n        object_type = str(response['data'][0]['object'])\n        object_id\
    \ = str(response['data'][0]['id']) # get the object id from the query results\n\
    \    except Exception, e:\n        results = {'ContentsFormat': formats['markdown'],\
    \ 'Type': entryTypes['note'], 'Contents': \"No results from ThreatQ\"}\n     \
    \   return results\n    results = describe_by_id(object_type,object_id)\n    return\
    \ results\n\n\n''' FUNCTIONS '''\n\n''' Get ThreatQ object details '''\ndef describe_by_id(tq_obj_type,tq_obj_id):\n\
    \    md = ''\n\n    # build the ThreatQ query url\n    if tq_obj_type == \"indicator\"\
    :\n        tq_url = API_URL + \"/indicators\" + \"/\" + tq_obj_id\n    elif tq_obj_type\
    \ == \"adversary\":\n        tq_url = API_URL + \"/adversaries\" + \"/\" + tq_obj_id\n\
    \    elif tq_obj_type == \"event\":\n        tq_url = API_URL + \"/events\" +\
    \ \"/\" + tq_obj_id\n    else:\n        tq_url = API_URL + \"/\" + tq_obj_type\
    \ + \"/\" + tq_obj_id\n\n    # get ThreatQ response\n    access_token = get_access_token()\n\
    \    api_call_headers = {'Authorization': 'Bearer ' + access_token}\n    api_call_response\
    \ = requests.get(tq_url, headers=api_call_headers, verify=False)\n    response\
    \ = json.loads(api_call_response.text)\n\n    if not response or len(response['data'])\
    \ == 0:\n        return \"Found in ThreatQ, but no context\"\n\n    description\
    \ = response['data']['description']\n    name = response['data']['value']\n\n\
    \    tq_attributes = None\n    dbot_score = None\n\n    if tq_obj_type == \"indicator\"\
    :\n        result = tq_indicator(name)\n        tq_attributes = result['attributes']\n\
    \        dbot_score = result['dbotscore']\n\n\n    # Description in clear text\
    \ will be sent to War Room\n    if description:\n        clean_desc = cleanhtml(description)\n\
    \    else:\n        clean_desc = \"No description found in ThreatQ\"\n\n    last_update\
    \ = str(response['data']['updated_at'])\n\n    tq_desc = {\n        'name': name,\n\
    \        'last_update' : last_update,\n        'description' : clean_desc,\n \
    \       'is_indicator': str(tq_obj_type == \"indicator\")\n    }\n\n\n    md +=\
    \ \"## TQ Object: \" + tq_obj_type + \" ID: \" + tq_obj_id + \"\\n\"\n    # Build\
    \ a ThreatQ Response table\n    md += tableToMarkdown('ThreatQ Response',tq_desc)\n\
    \n    if tq_obj_type == \"indicator\":\n        if not tq_attributes or len(tq_attributes)\
    \ == 0:\n            md += \"Found no attributs\"\n        else:\n           \
    \ md += tableToMarkdown(\"Attributes\", tq_attributes)\n            tq_desc.update(tq_attributes)\n\
    \n    entry2 = {\n        'Type': entryTypes['note'],\n        'Contents': tq_desc,\n\
    \        'ContentsFormat': formats['json'],\n        'ReadableContentsFormat':\
    \ formats['markdown'],\n        'HumanReadable': md,\n        'EntryContext':\
    \ {'ThreatQ(val.name && val.name == obj.name)': createContext(tq_desc, removeNull=True)},\n\
    \        }\n\n    if dbot_score:\n        entry2['EntryContext']['DBotScore(val.Vendor\
    \ && val.Indicator && val.Vendor == obj.Vendor && val.Indicator == obj.Indicator)']\
    \ = createContext(dbot_score, removeNull=True)\n\n    return entry2\n\ndef create_dbot_score(ind_name,\
    \ ind_score):\n\n    return dbot_score\n''' Get ThreatQ indicator's score and\
    \ attributes '''\n\ndef tq_indicator(indicator):\n    '''\n    This function parse\
    \ all the attributes of an indicator\n    '''\n    tq_url = API_URL + \"/indicators/?value=\"\
    \ + indicator + \"&with=score,attributes,sources\"\n\n    # get ThreatQ response\
    \ on indicators attributes\n    access_token = get_access_token()\n    api_call_headers\
    \ = {'Authorization': 'Bearer ' + access_token}\n    api_call_response = requests.get(tq_url,\
    \ headers=api_call_headers, verify=False)\n    try:\n        response = json.loads(api_call_response.text)\n\
    \    except requests.exceptions.RequestException as e:\n        md += '## TQ cound\
    \ not FIND this indicator\\n'\n        exit(1)\n    # check if any attributes\n\
    \    attributes = response[\"data\"][0][\"attributes\"]\n    score = response[\"\
    data\"][0][\"score\"]\n    sources = response[\"data\"][0][\"sources\"][0]\n \
    \   gen_score = score[\"generated_score\"]\n    manual_score = score[\"manual_score\"\
    ]\n    source = sources[\"name\"]\n\n    if not manual_score:\n        manual_score\
    \ = 0\n\n    ind_score = max(float(gen_score),float(manual_score))\n\n    '''\
    \ TBD - ThreatQ score to dbot_score conversion '''\n    if ind_score >= 8 :\n\
    \        dbot_score = 3\n        malicious = {\n            'Vendor' : 'ThreatQ',\n\
    \            'Detections' : 'high risk',\n        }\n    elif 4 < ind_score <\
    \ 8:\n        dbot_score = 2\n        malicious = {\n            'Vendor' : 'ThreatQ',\n\
    \            'Detections' : 'mid risk',\n        }\n    elif ind_score <= 2:\n\
    \        dbot_score = 1\n        malicious = {\n            'Vendor' : 'ThreatQ',\n\
    \            'Detections' : 'low risk',\n        }\n\n    dbot_score = {\n   \
    \             'Vendor' : 'ThreatQ',\n                'Indicator' : indicator,\n\
    \                'Type' : 'ip',\n                'Score' : dbot_score,\n     \
    \           'Malicious' : malicious,\n            }\n\n\n    md = ''\n\n    try:\n\
    \        length = len(attributes)\n        if length > 0:\n            md += \"\
    ## TQ found \" + str(length) + \" attributes\\n\"\n        else:\n           \
    \ md += \"## TQ found no attributes\\n\"\n        tq_attr = {\n            'name'\
    \ : indicator,\n            'score' : ind_score\n        }\n\n        for x in\
    \ range(length):\n            name = str(attributes[x][\"name\"])\n          \
    \  value = str(attributes[x][\"value\"])\n            tq_attr[name] = value\n\
    \            md += \"Attribute \" + name + \" is \" + value + \"\\n\"\n      \
    \  tq_attr_context = dict(tq_attr)\n    except:\n        md += '## TQ could not\
    \ EXTRACT attributes\\n'\n        pass\n\n    entry3 = {\n        'Type': entryTypes['note'],\n\
    \        'Contents': tq_attr_context,\n        'ContentsFormat': formats['json'],\n\
    \        'ReadableContentsFormat': formats['markdown'],\n        'HumanReadable':\
    \ md,\n        'EntryContext': {'ThreatQ(val.name && val.name == obj.name)': createContext(tq_attr_context,\
    \ removeNull=True),\n                    'DBotScore(val.Vendor && val.Indicator\
    \ && val.Vendor == obj.Vendor && val.Indicator == obj.Indicator)' :\n        \
    \        createContext(dbot_score, removeNull=True),\n        }\n    }\n    #\
    \ demisto.results(entry3)\n    return {'attributes': tq_attr_context,\n      \
    \      'dbotscore': dbot_score }\n\n\n''' EXECUTION CODE '''\nLOG('command is\
    \ %s' % (demisto.command(), ))\ntry:\n    if demisto.command() == 'test-module':\n\
    \        token = tq_access()\n        if token:\n            demisto.results('ok')\n\
    \        else:\n            demisto.results('test failed')\n    elif demisto.command()\
    \ == 'tq-search-by-name':\n        args = demisto.args()\n        keyword = demisto.get(args,\
    \ 'keyword')\n        results = query_tq(keyword)\n        demisto.results(results)\n\
    \    elif demisto.command() == 'ip':\n        args = demisto.args()\n        ip\
    \ = demisto.get(args, 'ip')\n        results = query_tq(ip)\n        demisto.results(results)\n\
    \    elif demisto.command() == 'url':\n        args = demisto.args()\n       \
    \ url = demisto.get(args, 'url')\n        results = query_tq(url)\n        demisto.results(results)\n\
    \    elif demisto.command() == 'file':\n        args = demisto.args()\n      \
    \  file = demisto.get(args, 'file')\n        results = query_tq(file)\n      \
    \  demisto.results(results)\n\n    elif demisto.command() == 'fetch-incidents':\n\
    \        fetch_incidents()\n\nexcept Exception, e:\n    raise\n    return_error(e)\n\
    \n\n# Params are of the type given in the integration page creation."
  subtype: python2
  type: python
tests:
- No test
toversion: 4.1.9
