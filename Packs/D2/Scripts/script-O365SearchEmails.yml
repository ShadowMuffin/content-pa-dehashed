args:
- default: true
  description: Admin user to use for compliance search
  name: username
  required: true
- description: Password for the specified user
  name: password
  required: true
  secret: true
- description: in seconds. Default is 5 mins. Max is 2 hours.
  name: timeout
- description: Query to use for finding mails
  name: query
  required: true
- description: Windows system to run the powershell script
  name: system
  required: true
- description: if set to "true" (case insensitive) - the script will also delete found
    emails. Default is false.
  name: delete
comment: Search mails in office-365
commonfields:
  id: O365SearchEmails
  version: -1
dependson: {}
name: O365SearchEmails
script: "res = []\ndArgs = demisto.args()\ndArgs['using'] = dArgs['system']\nimport\
  \ re\nREGEX_RESULTS = r\"Search results\\: \\{([^}]*)\\}\"\n\ndelArg = demisto.get(dArgs,\
  \ 'delete')\nif type(delArg) in [str, unicode] and delArg.lower()  == 'true':\n\
  \    demisto.log('[*] Script set to also delete found emails.')\n    resCmdName\
  \ = demisto.executeCommand(\"D2O365SearchAndDelete\", dArgs)\nelse:\n    resCmdName\
  \ = demisto.executeCommand(\"D2O365ComplianceSearch\", dArgs)\ntry:\n    for entry\
  \ in resCmdName:\n        if isError(entry):\n            res = resCmdName\n   \
  \         break\n        else:\n            myData = demisto.get(entry, 'Contents')\n\
  \            match = re.search(REGEX_RESULTS, myData)\n            if match and\
  \ match.groups():\n                searchResults = match.groups()[0]\n         \
  \       res.append({\"Type\": entryTypes[\"note\"], \"ContentsFormat\": formats[\"\
  text\"], \"Contents\": searchResults})\nexcept Exception as ex:\n    res.append({\"\
  Type\": entryTypes[\"error\"], \"ContentsFormat\": formats[\"text\"],\n        \
  \        \"Contents\": \"Error occurred while parsing output from command. Exception\
  \ info:\\n\" + str(ex) + \"\\n\\nInvalid output:\\n\" + str(resCmdName)})\ndemisto.results(res)\n"
scripttarget: 0
subtype: python2
system: true
tags:
- office365
- email
- response
timeout: 0s
toversion: 4.1.9
type: python
