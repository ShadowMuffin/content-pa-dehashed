category: Database
commonfields:
  id: McAfeeDAM
  version: -1
configuration:
- defaultvalue: ''
  display: URL
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: Credentials
  name: credentials
  required: true
  type: 9
- defaultvalue: '10'
  display: Batch size for incident fetch
  name: batchSize
  required: false
  type: 0
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: 'false'
  display: Validate ceritifacte
  name: secure
  required: false
  type: 8
- defaultvalue: ''
  display: Rule Name, If fetch incident is checked, this field is mandatory and will
    be used to get DAM alerts only triggered by this rule
  name: ruleName
  required: false
  type: 0
description: McAfee Database Activity Monitoring
detaileddescription: '## McAfee DAM

  Make sure that the XML API interface is enabled on your McAfee DAM server (Settings
  > Interfaces > XML API), and that the configured user has read permissions to query
  DAM Alerts and Sensors (XML API).


  **Important:** The user configured in McAfee DAM must have the *Use XML API* permission
  as documented [here](https://docs.mcafee.com/bundle/database-security-4.6.5-product-guide/page/GUID-9018582C-321F-46A3-AB12-FABF16FCE12B.html).


  Instructions on how to configure and test the XML API for McAfee DAM are available
  [here](https://docs.mcafee.com/bundle/database-security-4.6.5-product-guide/page/GUID-E51275F4-B365-499B-879C-51FE6A6989BA.html).'
display: McAfee DAM
image: data:image/png;base64,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
name: McAfeeDAM
script:
  commands:
  - arguments:
    - default: true
      description: The alert ID.
      name: id
      required: true
    description: Gets a DAM alert from McAfee Database Activity Monitoring by alert
      ID.
    name: dam-get-alert-by-id
    outputs:
    - contentPath: id
      contextPath: AlertId
      description: DAM alert ID.
    - contentPath: accessedObjects.object.name
      contextPath: alertAccessedObjects
      description: DAM accessed objects.
    - contentPath: execUser
      contextPath: dbUser
      description: DAM database user.
    - contentPath: osUser
      contextPath: Account.Username
      description: DAM OS user.
    - contentPath: database
      contextPath: database
      description: DAM database.
    - contentPath: identifyingSensor
      contextPath: sensor
      description: DAM sensor.
    - contentPath: rules
      contextPath: rules
      description: DAM rules.
  - arguments:
    - default: true
      description: Name of the rule that triggered the alert.
      name: ruleName
      required: true
    - description: Number of alerts to retrieve. The default is 10.
      name: count
    - description: Filter DAM alerts and import alerts that where created only in
        the last X minutes. The default is the last 10 minutes.
      name: timeBack
    description: Gets the latest DAM alerts by rule name.
    name: dam-get-latest-by-rule
    outputs:
    - contentPath: id
      contextPath: AlertId
      description: DAM alert ID.
    - contentPath: accessedObjects.object.name
      contextPath: alertAccessedObjects
      description: DAM accessed objects.
    - contentPath: execUser
      contextPath: dbUser
      description: DAM database user.
    - contentPath: osUser
      contextPath: Account.Username
      description: DAM OS user.
    - contentPath: database
      contextPath: database
      description: DAM database.
    - contentPath: identifyingSensor
      contextPath: sensor
      description: DAM sensor.
    - contentPath: rules
      contextPath: rules
      description: DAM Rules
  isfetch: true
  runonce: false
  script: "var mdAlertFields={\n  'Execution Time':'executionTime',\n  'Rule':'rules.rule.name',\n\
    \  'User':'execUser',\n  'Database':'database.name',\n  'Sensor':'identifyingSensor.name',\n\
    \  'Command Type':'cmdType'\n};\n\nvar fixUrl = function(base) {\n    res = base;\n\
    \    if (base && base[base.length - 1] != '/') {\n        res = res + '/';\n \
    \   }\n    return res;\n};\n\nvar sendRequest = function(url, service, param)\
    \ {\n\n    // handle '/' at the end of the url\n    if (url[url.length - 1] ===\
    \ '/') {\n        url = url.substring(0, url.length - 1);\n    }\n\n    // prepare\
    \ the request url (make sure to encode the query parameter value)\n    var requestUrl\
    \ = url + 'service=' + service;\n    if  (param) {\n        requestUrl += '&'\
    \ +  param;\n    }\n    var res = http(\n        requestUrl,\n        {\n    \
    \        Method: 'GET', // Can be POST, PUT, DELETE, HEAD, OPTIONS or CONNECT\n\
    \            Headers: {\n                Accept: ['application/json']\n      \
    \      },\n            Username:  params.credentials.identifier,\n           \
    \ Password:  params.credentials.password,\n\n        },\n        !params.insecure\n\
    \    );\n\n    if (res.StatusCode < 200 || res.StatusCode >= 300) {\n        throw\
    \ 'Request Failed.\\nStatus code: ' + res.StatusCode + '.\\nBody: ' + JSON.stringify(res)\
    \ + '.';\n    }\n\n    return JSON.parse(x2j(res.Body));\n};\n\nvar finalUrl =\
    \ fixUrl(params.url) + 'xmlapi.svc?';\n\nvar calculateNewLastRun = function(alerts)\
    \ {\n    var res = '';\n    var lastAlert = null;\n    if (alerts && alerts.length\
    \ && alerts.length > 0) {\n        // transalte yyyy-MM-dd HH:mm:ss.S +Z => yyyy-MM-ddTHH:mm:ss.S+Z\
    \ => time in millis\n        lastAlert = alerts[alerts.length -1];\n    } else\
    \ if (alerts){\n        //This is a single element\n        lastAlert = alerts;\n\
    \    }\n    if (lastAlert) {\n        var createDate = lastAlert.createDate;\n\
    \        var dateTime = createDate.split(' ');\n        var goTime = dateTime[0]+'T'+dateTime[1]+dateTime[2];\n\
    \        //hack needed, becuase platform problems\n        res = new Date(Date.parse(goTime)).getTime()\
    \ + 1;\n    }\n    return res;\n};\n\nvar alertToIncident = function(alert) {\n\
    \    labels = [];\n    var keys = Object.keys(alert);\n    for (j = 0 ; j < keys.length;\
    \ j++) {\n        if (keys[j] === 'accessedObjects') {\n            if (alert.accessedObjects.object\
    \ && alert.accessedObjects.object.length > 0) {\n                for (k = 0; k\
    \ < alert.accessedObjects.object.length; k++) {\n                    labels.push({type:\
    \ 'accessedObject', value: alert.accessedObjects.object[k].owner + '.' + alert.accessedObjects.object[k].name\
    \ + '('+ alert.accessedObjects.object[k].type +')'});\n                }\n   \
    \         }\n        } else if (keys[j] === 'database') {\n            labels.push({type:\
    \ 'database-host', value: alert.database.host});\n            labels.push({type:\
    \ 'database-ip', value: alert.database.ip});\n            labels.push({type: 'database-id',\
    \ value: alert.database.id});\n            labels.push({type: 'database-name',\
    \ value: alert.database.name});\n        } else if (keys[j] === 'identifyingSensor')\
    \ {\n            labels.push({type: 'sensor-host', value: alert.identifyingSensor.host});\n\
    \            labels.push({type: 'sensor-ip', value: alert.identifyingSensor.ip});\n\
    \            labels.push({type: 'sensor-id', value: alert.identifyingSensor.id});\n\
    \            labels.push({type: 'sensor-name', value: alert.identifyingSensor.name});\n\
    \            labels.push({type: 'sensor-version', value: alert.identifyingSensor.version});\n\
    \        } else if (keys[j] === 'rules') {\n            if (alert.rules.length\
    \ > 0) {\n                for (k = 0; k < alert.rules.length; k++) {\n       \
    \             labels.push({type: 'rule', value: alert.rules[i].name + '('+ alert.rules[i].sysid\
    \ +')'});\n                }\n            } else if (alert.rules) {\n        \
    \        labels.push({type: 'rule', value: alert.rules.name + '('+ alert.rules.sysid\
    \ +')'});\n            }\n        } else {\n            labels.push({type: keys[j],\
    \ value: alert[keys[j]]});\n        }\n    }\n    return {\n      name: 'DAM Event\
    \ - ' + alert.id,\n      labels: labels,\n      details: alert.operation,\n  \
    \    rawJSON: JSON.stringify(alert)\n    };\n};\nvar alertsToIncident = function(alerts)\
    \ {\n    var incidents = [];\n    for (i = 0; i < alerts.length; i++){\n     \
    \   incidents.push(alertToIncident(alerts[i]));\n    }\n    return incidents;\n\
    };\nfunction alertsToMd(alerts) {\n    var md=\"\";\n    if (Array.isArray(alerts))\
    \ {\n        for (var i in alerts) {\n            md += alertToMd(alerts[i]) +\
    \ \"\\n --- \\n\";\n        }\n    } else {\n        md += alertToMd(alerts);\n\
    \    }\n    return md;\n}\nfunction mdTableHead() {\n    var head='|';\n    var\
    \ line='|';\n    for (var key in mdAlertFields) {\n        head+=key + '|';\n\
    \        line+= '- |';\n    }\n    return head+'\\n'+line+'\\n';\n}\nfunction\
    \ mdTableData(alert) {\n    var data='|';\n    for (var key in mdAlertFields)\
    \ {\n        data+=resolve(alert,mdAlertFields[key]) + '|';\n    }\n    return\
    \ data + '\\n';\n}\nfunction alertToMd(alert) {\n    var md ='';\n    md +=\"\
    ### DAM Alert ID \" + alert.id + \"\\n\";\n    md += mdTableHead();\n    md +=\
    \ mdTableData(alert);\n    if (alert.operation) {\n        md += '#### Statement\\\
    n';\n        md += '```\\n' + alert.operation + '\\n```';\n    }\n    if (alert.accessedObjects\
    \ && alert.accessedObjects.object) {\n        var objects = Array.isArray(alert.accessedObjects.object)\
    \ ? alert.accessedObjects.object : new Array(alert.accessedObjects.object);\n\
    \        md += '\\n#### Accessed Objects \\n';\n        md += 'Type|Owner|Name\\\
    n-|-|-\\n';\n        for (var i in objects) {\n            md += objects[i].type\
    \ + '|' + objects[i].owner + '|' + objects[i].name + \"\\n\";\n        }\n   \
    \ }\n\n    return md;\n}\n\nfunction resolve(obj,path) {\n    if (Array.isArray(obj))\
    \ {\n        var ret = [];\n        for (var i in obj) {\n            ret.push(resolve(obj[i],path));\n\
    \        }\n        return ret;\n    } else {\n        var dot=path.indexOf(\"\
    .\");\n        if (dot == -1) {\n            return obj[path] ? obj[path] : 'N/A';\n\
    \        } else {\n            var curr = path.substring(0,dot);\n           \
    \ var rest = path.substring(dot+1);\n            return obj[curr] ? resolve(obj[curr],rest)\
    \ : 'N/A';\n        }\n    }\n}\n\nvar fetchIncidents = function() {\n    var\
    \ count = params.batchSize || 100;\n    //Default time back for first fetch is\
    \ 10 minutes\n    var timeBack = 1000 * 60 * 10;\n    var urlParams = 'HH$TimeBackPeriod='\
    \ + encodeURIComponent(timeBack +'');\n    var lastRun = getLastRun();\n    if\
    \ (lastRun && Object.keys(lastRun).length > 0) {\n        urlParams = 'HH$CreateDateFrom='\
    \ + encodeURIComponent(lastRun.createDate);\n    }\n    if (params.ruleName) {\n\
    \        urlParams +='&HH$RuleName=' + encodeURIComponent(params.ruleName);\n\
    \    }\n    urlParams += '&HH$pageSize='+encodeURIComponent(count);\n    var res\
    \ = sendRequest(finalUrl, 'alert',  urlParams).HedgehogXmlApi;\n    var incidents\
    \ = null;\n    var newLastRun = null;\n    if (res && res.alert && res.alert.length\
    \ > 0) {\n        //Create incidents\n        incidents = alertsToIncident(res.alert);\n\
    \        //Set last run\n        newLastRun = calculateNewLastRun(res.alert);\n\
    \    } else if (res && res.alert) {\n        //This is a sinlge alert\n      \
    \  //Create incidents\n        incidents = [alertToIncident(res.alert)];\n   \
    \     //Set last run\n        newLastRun = calculateNewLastRun(res.alert);\n \
    \   }\n    if (newLastRun) {\n        setLastRun({createDate: newLastRun});\n\
    \    }\n    return incidents;\n};\n\n// The command input arg holds the command\
    \ sent from the user.\nswitch (command) {\n    // This is the call made when pressing\
    \ the integration test button.\n    case 'test-module':\n        sendRequest(finalUrl,\
    \ 'sensor');\n        return 'ok';\n    case 'fetch-incidents':\n        return\
    \ JSON.stringify(fetchIncidents());\n    case 'dam-get-alert-by-id':\n       \
    \ var jsonRes=sendRequest(finalUrl, 'alert', 'HH$Id=' + encodeURIComponent(args.id)).HedgehogXmlApi.alert;\n\
    \        if (jsonRes) {\n            var entryContext = {\n            };\n  \
    \          md = alertToMd(jsonRes);\n            return {Type: entryTypes.note,\
    \ Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};\n     \
    \   } else {\n            md = '### no alerts found\\n';\n            return {Type:\
    \ entryTypes.note, Contents: null, ContentsFormat: formats.json, HumanReadable:\
    \ md};\n        }\n    case 'dam-get-latest-by-rule':\n        var count = args.count\
    \ || 10;\n        var timeBack = 1000 * 60 * (args.timeBack || 10);\n        var\
    \ res = sendRequest(finalUrl, 'alert', 'HH$RuleName=' + encodeURIComponent(args.ruleName)\
    \ +\n            '&HH$TimeBackPeriod='+encodeURIComponent(timeBack +'') + '&HH$pageSize='+encodeURIComponent(count)).HedgehogXmlApi;\n\
    \n        if (res && res.alert) {\n            jsonRes = res.alert;\n        \
    \    var entryContext = {};\n            md = alertsToMd(jsonRes);\n         \
    \   return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json,\
    \ HumanReadable: md};\n        } else {\n            md = '### no alerts found\\\
    n';\n            return {Type: entryTypes.note, Contents: null, ContentsFormat:\
    \ formats.json, HumanReadable: md};\n        }\n}"
  type: javascript
tests:
- No test
toversion: 4.1.9
