category: Network Security
commonfields:
  id: Netskope
  version: -1
configuration:
- defaultvalue: ''
  display: URL of Netskope Tenant (e.g. https://tenant.goskope.com)
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: Tenant API Token
  name: token
  required: true
  type: 4
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: Last60Minutes
  display: Timeframe for initial fetch
  name: firstFetch
  options:
  - Last60Minutes
  - Last24Hours
  - Last7Days
  - Last30Days
  - Last60Days
  - Last90Days
  required: false
  type: 15
- defaultvalue: '50'
  display: Maximum number of events to fetch per fetch
  name: maxFetch
  required: false
  type: 0
description: Cloud access security broker that enables to find, understand, and secure
  cloud apps.
detaileddescription: 'You can grab the API token from your Netskope tenant by navigating
  to: Settings-->Manage-->REST API'
display: Netskope
image: data:image/png;base64,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
name: Netskope
script:
  commands:
  - arguments:
    - description: filter query (e.g. user eq user1@domain.com)
      name: query
    - auto: PREDEFINED
      description: TimePeriod
      name: timeperiod
      predefined:
      - Last60Minutes
      - Last24Hours
      - Last7Days
      - Last30Days
      - Last60Days
      - Last90Days
    - description: 'Query start time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g. 31-12-1999T11:59:59Z)'
      name: starttime
    - description: 'Query end time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g. 31-12-1999T11:59:59Z)'
      name: endtime
    - auto: PREDEFINED
      description: Type of Event (e.g Application, Page, Audit)
      name: type
      predefined:
      - application
      - page
      - audit
      required: true
    - description: Limit the number of events returned (useful for pagination in combination
        with skip). Positive integer less than 5000.
      name: limit
    - description: Skip over some of the events (useful for pagination in combination
        with limit)
      name: skip
    description: Gets a list of events
    name: netskope-events
    outputs:
    - contextPath: Netskope.Events.App
      description: Name of Application
      type: string
    - contextPath: Netskope.Events.Timestamp
      description: Timestamp of event
      type: string
    - contextPath: Netskope.Events.Activity
      description: Activity of event
      type: string
    - contextPath: Netskope.Events.Object
      description: Document/object from event
      type: string
    - contextPath: Netskope.Events.hostname
      description: Hostname of device
      type: string
    - contextPath: Netskope.Events.AppCategory
      description: Netskope application category (e.g. Cloud Storage, Webmail, etc)
      type: string
    - contextPath: Netskope.Events.device_classification
      description: Device classification (e.g. managed vs unmanaged)
      type: string
    - contextPath: Netskope.Events.User
      description: User
      type: string
    - contextPath: Netskope.Events.from_user
      description: Login IDs for cloud apps
      type: string
    - contextPath: Netskope.Events.to_user
      description: Destination user IDs
      type: string
    - contextPath: Netskope.Events.SourceIP
      description: Source IP
      type: string
    - contextPath: Netskope.Events.AccessMethod
      description: Access method (e.g. client, reverse proxy, Secure Forwarder, etc)
      type: string
    - contextPath: Netskope.Events.url
      description: URL
      type: string
    - contextPath: Netskope.Events.ID
      description: Event ID
      type: string
  - arguments:
    - auto: PREDEFINED
      description: Type of alert
      name: type
      predefined:
      - anomaly
      - Compromised Credential
      - DLP
      - Legal Hold
      - malsite
      - Malware
      - policy
      - quarantine
      - Remediation
      - watchlist
      required: true
    - auto: PREDEFINED
      description: Time period (e.g. Last 60 minutes, Last 24 hours, etc.)
      name: timeperiod
      predefined:
      - Last60Minutes
      - Last24Hours
      - Last7Days
      - Last30Days
      - Last60Days
      - Last90Days
    - description: 'Query start time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g., 31-12-1999T11:59:59Z)'
      name: starttime
    - description: 'Query end time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g. 31-12-1999T11:59:59Z)'
      name: endtime
    - description: Valid event query described in the query language document
      name: query
    description: Gets a list of alerts
    name: netskope-alerts
    outputs:
    - contextPath: Netskope.Alerts.App
      description: Name of Application
      type: string
    - contextPath: Netskope.Alerts.Timestamp
      description: Timestamp of event
      type: string
    - contextPath: Netskope.Alerts.Policy
      description: Name of Policy Triggered
      type: string
    - contextPath: Netskope.Alerts.DLPFile
      description: Name of DLP File that triggered
      type: string
    - contextPath: Netskope.Alerts.Hostname
      description: Hostname
      type: string
    - contextPath: Netskope.Alerts.ID
      description: Alert ID
      type: string
  isfetch: true
  runonce: false
  script: "var SERVER_URL = params.url.replace(/[\\/]+$/, '');\nvar BASE_URL = SERVER_URL\
    \ + '/api/v1/';\nvar TOKEN = params.token;\n\nfunction sendRequest(method, api)\
    \ {\n    var requestUrl = BASE_URL + api;\n    var result = http(\n        requestUrl,\n\
    \        {\n            Method: method,\n            Headers: {\n            \
    \    'Content-Type': ['application/json'],\n                'Accept': ['application/json']\n\
    \            }\n        },\n        params.insecure,\n        params.proxy\n \
    \       );\n    if (result.StatusCode < 200 && result.StatusCode > 299) {\n  \
    \      throw 'Failed to perform request ' + path + ', request status code: ' +\
    \ result.StatusCode + ', body: ' + result.Body;\n    }\n    if (result.Body ===\
    \ '') {\n        throw 'No content received.' + requestUrl + result;\n    }\n\
    \    var body;\n    try {\n        body = JSON.parse(result.Body);\n    } catch\
    \ (ex) {\n        throw 'Error parsing reply - ' + result.Body + ' - ' + ex;\n\
    \    }\n    return body;\n}\n\nfunction normalizeTimestamp(timestamp) {\n    return\
    \ Date(timestamp);\n}\n\nfunction translateTimeperiod(timeperiod){\n    var timeperiodTranslator\
    \ = {\n        'Last60Minutes': '3600',\n        'Last24Hours': '86400',\n   \
    \     'Last7Days': '604800',\n        'Last30Days': '2592000',\n        'Last60Days':\
    \ '5184000',\n        'Last90Days': '7776000'\n    };\n    return timeperiodTranslator[timeperiod];\n\
    }\n\nfunction translateMonthName(monthName) {\n    var monthTranslator = {\n \
    \       'january': 1,\n        'february': 2,\n        'march': 3,\n        'april':\
    \ 4,\n        'may': 5,\n        'june': 6,\n        'july': 7,\n        'august':\
    \ 8,\n        'september': 9,\n        'october': 10,\n        'november': 11,\n\
    \        'december': 12\n    };\n    return monthTranslator[monthName];\n}\n\n\
    /**\n* convert string formatted time to timestamp.\n* Note: Accept 2 string formats:\
    \ \"dd-mm-yyyyTHH:MM:SSZ\" or \"Month Day, Year HH:MM:SS\".\n* @param {string}\
    \ strDate - string formatted array\n* @return {string} timestamp\n*/\nfunction\
    \ toTimestamp(strDate){\n    // accept: 31-12-1999T14:35:20Z\n    var dateTuple\
    \ = strDate.match('^(\\\\d{2})-(\\\\d{2})-(\\\\d{4})T(\\\\d{2}):(\\\\d{2}):(\\\
    \\d{2})Z$');\n    var timestamp;\n    if (dateTuple !== null) {\n        // first\
    \ element is the entire match, then the individual matches.\n        // months\
    \ in Date JS are an integer between 0 and 11.\n        timestamp = new Date(dateTuple[3],\
    \ dateTuple[2] - 1, dateTuple[1], dateTuple[4], dateTuple[5], dateTuple[6]);\n\
    \        return timestamp.getTime()/1000;\n    }\n\n    // accept: December 31,\
    \ 1999 14:35:20\n    dateTuple = strDate.toLowerCase().match('^(january|february|march|april|may|june|july|august|september|october|november|december)\
    \ (\\\\d{1,2}), (\\\\d{4}) (\\\\d{2}):(\\\\d{2}):(\\\\d{2})$');\n    if (dateTuple\
    \ !== null) {\n        timestamp = new Date(dateTuple[3], translateMonthName(dateTuple[1])\
    \ - 1, dateTuple[2], dateTuple[4], dateTuple[5], dateTuple[6]);\n        return\
    \ timestamp.getTime()/1000;\n    }\n    return strDate;\n}\n\nfunction getAlerts()\
    \ {\n    var queryArgs = {\n        token: TOKEN,\n        type: encodeURIComponent(args.type)\n\
    \    };\n    if (args.starttime && args.endtime) {\n        queryArgs.starttime\
    \ = toTimestamp(args.starttime);\n        queryArgs.endtime = toTimestamp(args.endtime);\n\
    \        if (args.timeperiod) {\n            queryArgs.timeperiod = translateTimeperiod(args.timeperiod);\n\
    \        }\n        if (args.query) {\n            queryArgs.query = encodeURIComponent(args.query);\n\
    \        }\n    } else if (args.timeperiod) {\n        queryArgs.timeperiod =\
    \ translateTimeperiod(args.timeperiod);\n        if (args.query) {\n         \
    \   queryArgs.query = encodeURIComponent(args.query);\n        }\n    } else {\n\
    \        throw 'Not given enough arguments to filter events by.';\n    }\n\n \
    \   var cmdUrl = 'alerts' + encodeToURLQuery(queryArgs);\n    logInfo('Getting/Fetching\
    \ Netskope Alerts (to be incidents) with ' + String(cmdUrl));\n    var result\
    \ = sendRequest('GET', cmdUrl);\n    return result;\n}\n\nfunction getAlertsCommand()\
    \ {\n    result = getAlerts()\n    var retArray = [];\n    result.data.forEach(function(arrayItem)\
    \ {\n        var id = arrayItem._id;\n        var app =  arrayItem.app;\n    \
    \    var timestamp =  normalizeTimestamp(arrayItem.timestamp);\n        var dlp_profile\
    \ =  arrayItem.dlp_profile;\n        var dlp_file =  arrayItem.dlp_file;\n   \
    \     var hostname =  arrayItem.hostname;\n        var policy =  arrayItem.policy;\n\
    \        retArray.push({'ID': id, 'App' : app, 'Timestamp' : timestamp, 'DLPProfile'\
    \ : dlp_profile, 'DLPFile' : dlp_file, 'Hostname' : hostname, 'Policy' : policy});\n\
    \    });\n    var ec = {\n        \"Netskope.Alerts(val.ID && val.ID === obj.ID)\"\
    \ : retArray\n    };\n    headers = ['ID', 'Timestamp', 'DLPProfile', 'DLPFile',\
    \ 'Hostname', 'Policy'];\n    return {\n        Type: entryTypes.note,\n     \
    \   ContentsFormat: formats.json,\n        Contents: result.data,\n        ReadableContensFormat:\
    \ formats.markdown,\n        HumanReadable: tableToMarkdown('Netskope Alerts',\
    \ retArray, headers),\n        EntryContext: ec\n    };\n}\n\nfunction getEvents()\
    \ {\n    var queryArgs = {\n        token: TOKEN,\n        type: encodeURIComponent(args.type)\n\
    \    };\n    if (args.starttime && args.endtime) {\n        queryArgs.starttime\
    \ = toTimestamp(args.starttime);\n        queryArgs.endtime = toTimestamp(args.endtime);\n\
    \        if (args.timeperiod) {\n            queryArgs.timeperiod = translateTimeperiod(args.timeperiod);\n\
    \        }\n        if (args.query) {\n            queryArgs.query = encodeURIComponent(args.query);\n\
    \        }\n    } else if (args.timeperiod) {\n        queryArgs.timeperiod =\
    \ translateTimeperiod(args.timeperiod);\n        if (args.query) {\n         \
    \   queryArgs.query = encodeURIComponent(args.query);\n        }\n    } else {\n\
    \        throw 'Not given enough arguments to filter events by.';\n    }\n\n \
    \   var cmdUrl = 'events' + encodeToURLQuery(queryArgs);\n    var result = sendRequest('GET',\
    \ cmdUrl);\n    var retArray = [];\n    result.data.forEach(function(arrayItem)\
    \ {\n        var id = arrayItem._id;\n        var app =  arrayItem.app;\n    \
    \    var timestamp = normalizeTimestamp(arrayItem.timestamp);\n        var activity\
    \ =  arrayItem.activity;\n        var object =  arrayItem.object;\n        var\
    \ hostname =  arrayItem.hostname;\n        var category =  arrayItem.category;\n\
    \        var device_classification =  arrayItem.device_classification;\n     \
    \   var user =  arrayItem.user;\n        var from_user =  arrayItem.from_user;\n\
    \        var to_user =  arrayItem.to_user;\n        var srcip =  arrayItem.srcip;\n\
    \        var access_method =  arrayItem.access_method;\n        var url =  arrayItem.url;\n\
    \        retArray.push({'ID': id, 'App' : app, 'Timestamp' : timestamp, 'Activity'\
    \ : activity, 'Object' : object, 'Hostname' : hostname, 'AppCategory' : category,\
    \ 'DeviceClassification' : device_classification, 'User' : user, 'FromUser' :\
    \ from_user, 'ToUser' : to_user, 'SourceIP' : srcip, 'AccessMethod' : access_method,\
    \ 'URL' : url});\n    });\n    var ec = {\n        \"Netskope.Events(val.ID &&\
    \ val.ID === obj.ID)\" : retArray\n    };\n    headers = ['ID', 'App', 'Timestamp',\
    \ 'Activity', 'Object', 'Hostname', 'AppCategory', 'DeviceClassification', 'User',\n\
    \               'FromUser', 'ToUser', 'SourceIP', 'AccessMethod', 'URL'];\n  \
    \  return {\n        Type: entryTypes.note,\n        ContentsFormat: formats.json,\n\
    \        Contents: result.data,\n        ReadableContensFormat: formats.markdown,\n\
    \        HumanReadable: tableToMarkdown('Netskope Events', retArray, headers),\n\
    \        EntryContext: ec\n    };\n}\n\nfunction now() {\n    return parseInt(new\
    \ Date().getTime()/1000);\n}\n\nfunction fetchAlerts() {\n    lastRun = getLastRun();\n\
    \    last_run = parseInt(lastRun.lastTime);\n    if (isNaN(last_run)) {\n    \
    \    last_run = now() - parseInt(translateTimeperiod(params.firstFetch));\n  \
    \  }\n\n    args = {};\n    args.type = \"\";\n    args.starttime = last_run.toString();\n\
    \    args.endtime = now().toString();\n    alerts = getAlerts().data;\n    var\
    \ incidents = [];\n    var latestIncidedentTimeString = null;\n    var latestIncidedentTimeInt\
    \ = null;\n    if (typeof alerts !== 'undefined') {\n        alerts.reverse();\
    \  // alerts are fetched in descending order, reversing to process older first\n\
    \        for (var i = 0; i < alerts.length; i++) {\n            item = alerts[i];\n\
    \            incident = {};\n            d = new Date(item.timestamp);\n     \
    \       incident.occurred = d.toISOString();\n            incident.name = item.alert_type\
    \ + \" - \" + item.alert_name;\n            incident.rawJSON = JSON.stringify(item);\n\
    \            incidents.push(incident);\n            if (latestIncidedentTimeInt\
    \ == null || parseInt(item.timestamp) > latestIncidedentTimeInt) {\n         \
    \       latestIncidedentTimeInt = parseInt(item.timestamp);\n                latestIncidedentTimeString\
    \ = item.timestamp\n            }\n            if (incidents.length >= Math.min(50,\
    \ params.maxFetch)) {\n                break;\n            }\n        }\n    }\n\
    \    var incidentsLimitReached = (incidents.length >= Math.min(50, params.maxFetch));\n\
    \    lastTime = incidentsLimitReached ? latestIncidedentTimeString : args.endtime;\n\
    \    lastRun = {'lastTime': lastTime};\n    setLastRun(lastRun);\n    logInfo('Netskope\
    \ lastRun is: ' + String(args.endtime));\n    return JSON.stringify(incidents);\n\
    }\n\nswitch (command) {\n    case 'test-module':\n        var queryArgs = {\n\
    \            token: TOKEN,\n            type: 'application',\n            timeperiod:\
    \ '3600',\n            limit: '1'\n        };\n        var cmdUrl = 'events' +\
    \ encodeToURLQuery(queryArgs);\n        result = sendRequest('GET', cmdUrl);\n\
    \        if (result.status != \"error\") {\n            return 'ok';\n       \
    \ }\n        return result;\n    case 'fetch-incidents':\n        return fetchAlerts();\n\
    \    case 'netskope-events':\n        return getEvents();\n    case 'netskope-alerts':\n\
    \        return getAlertsCommand();\n}"
  type: javascript
tests:
- Netskope Test
toversion: 4.1.9
