category: Authentication
commonfields:
  id: CyberArkAIM
  version: -1
configuration:
- defaultvalue: ''
  display: Server URL (e.g. https://192.168.0.1)
  name: server
  required: true
  type: 0
- defaultvalue: ''
  display: Port
  name: port
  required: false
  type: 0
- defaultvalue: ''
  display: AppID as configured in AIM
  name: appid
  required: true
  type: 0
- defaultvalue: ''
  display: API Username
  name: username
  required: false
  type: 0
- defaultvalue: ''
  display: API Password
  name: password
  required: false
  type: 4
- defaultvalue: 'true'
  display: Fetches credentials
  name: isFetchCredentials
  required: false
  type: 8
- defaultvalue: ''
  display: Folder to search in safe
  name: folder
  required: true
  type: 0
- defaultvalue: isFetchCredentials
  display: Safe to search in
  name: safe
  required: true
  type: 0
- defaultvalue: ''
  display: Credential names - comma-seperated list of credentials names in vault
  name: credentialNames
  required: false
  type: 12
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Query CyberArk Application Identity Manager for accounts and credentials
display: CyberArk AIM
image: data:image/png;base64,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
name: CyberArkAIM
script:
  commands:
  - arguments:
    - description: Username to query
      name: username
    - description: Address to query
      name: address
    - description: Safe to query
      name: safe
    - description: Folder to query
      name: folder
    - description: Object to query
      name: object
    - description: Defines a free query using account properties, including Safe,
        folder, and object. When this method is specified, all other search criteria
        are ignored
      name: query
    - auto: PREDEFINED
      description: Defines the query format, which can optionally use regular expressions
      name: queryFormat
      predefined:
      - Exact
      - Regexp
    - description: The reason for retrieving the password. This reason will be audited
        in the Credential Provider audit log.
      name: reason
    - description: Defines search criteria according to the Database account property
      name: database
    description: Search credentials in cyberark using arguments to narrow the search.
      Cannot return more than one result.
    name: cyber-ark-aim-query
    outputs:
    - contextPath: CyberArk.AIM.Folder
      description: Account folder
    - contextPath: CyberArk.AIM.PasswordChangeInProcess
      description: Is password change in process
    - contextPath: CyberArk.AIM.Content
      description: Account content
    - contextPath: CyberArk.AIM.CreationMethod
      description: Account creation method
    - contextPath: CyberArk.AIM.Name
      description: Account name
    - contextPath: CyberArk.AIM.PolicyID
      description: Account policy ID
    - contextPath: CyberArk.AIM.CPMDisabled
      description: Account CPM disabled
    - contextPath: CyberArk.AIM.Address
      description: Account address
    - contextPath: CyberArk.AIM.Safe
      description: Account safe
    - contextPath: CyberArk.AIM.UserName
      description: Account username
    - contextPath: CyberArk.AIM.DeviceType
      description: Account device type
  - arguments:
    - default: true
      description: When used, command will return a specific credential
      name: identifier
    description: Lists all credentials available
    name: list-credentials
  - arguments:
    - auto: PREDEFINED
      defaultValue: 'Yes'
      description: Signle the CPM that the change is effective immediately
      name: immediateChangeByCPM
      predefined:
      - 'Yes'
      - 'No'
    - default: true
      description: Account Id to reset password
      name: accountId
      required: true
    description: 'This method marks the account for an immediate password change by
      the CPM to a new random password. '
    name: reset-credentials
  - arguments:
    - default: true
      description: Keywords matching the account
      name: keywords
      required: true
    - description: Specify a safe rather then using instance specific.
      name: safe
    description: This method returns information about an account. If more than one
      account meets the search criteria, only the first account will be returned.
    name: account-details
  runonce: false
  script: "var port = params.port;\nvar base = params.server.replace(/[\\/]+$/, '')\
    \ + (port ? (':' + port) : '');\nvar accountsUrl = base + '/AIMWebService/api/Accounts';\n\
    var authUrl = base + '/PasswordVault/WebServices/auth/Cyberark/CyberArkAuthenticationService.svc/';\n\
    var credentialsUrl = base + '/PasswordVault/WebServices/PIMServices.svc/Accounts';\n\
    var insecure = params.insecure;\nvar proxy = params.proxy;\nvar appid = params.appid;\n\
    var username = params.username;\nvar password = params.password;\nvar token;\n\
    \nvar sendRequest = function(method, url, args) {\n    var res = http(\n     \
    \   url + (method === 'GET' ? encodeToURLQuery(args) : ''),\n        {\n     \
    \       Method: method,\n            Body: method !== 'GET' ? JSON.stringify(args)\
    \ : ''\n        },\n        insecure,\n        proxy,\n        false,\n      \
    \  false,\n        30000\n    );\n    if (res.StatusCode !== 400 && (res.StatusCode\
    \ < 200 || res.StatusCode >= 300)) {\n        if (res.StatusCode === 404) {\n\
    \            return undefined;\n        }\n        // if timeout, throw.\n   \
    \     if (res.StatusCode === -1) {\n            throw 'Request credentials from\
    \ CyberArk returned Timeout. Error: ' + res.Status;\n        }\n        throw\
    \ 'Failed to reach ' + url + ' , request status code: ' + res.StatusCode + ' and\
    \ Body: ' + res.Body + '.';\n    }\n    return JSON.parse(res.Body);\n}\n\nvar\
    \ sendRequestWithToken = function(method, url, args, returnPlainResponse) {\n\
    \    var headers = {};\n    headers[\"Content-Type\"] = [\"application/json\"\
    ];\n    if (!token) {\n        var data = {\n          username: username,\n \
    \         password: password,\n          useRadiusAuthentication: false,\n   \
    \       connectionNumber: 1\n        };\n        var tokenRes = http(\n      \
    \      authUrl + 'Logon',\n            {\n                Method: 'POST',\n  \
    \              Headers: headers,\n                Body: JSON.stringify(data)\n\
    \            },\n            insecure,\n            proxy\n        );\n      \
    \  if (tokenRes.StatusCode !== 200) {\n            throw 'Could not authenticate\
    \ user ' + tokenRes.Body;\n        }\n\n        var tokenResObject = JSON.parse(tokenRes.Body);\n\
    \        token = tokenResObject.CyberArkLogonResult;\n    }\n\n    headers[\"\
    Authorization\"] = [token];\n    if (args.ImmediateChangeByCPM) {\n        headers[\"\
    ImmediateChangeByCPM\"] = [args.ImmediateChangeByCPM];\n        delete args.ImmediateChangeByCPM;\n\
    \    }\n\n    var res = http(\n            url + (method === 'GET' ? encodeToURLQuery(args)\
    \ : ''),\n            {\n                Method: method,\n                Headers:\
    \ headers,\n                Body: method !== 'GET' ? JSON.stringify(args) : ''\n\
    \            },\n            insecure,\n            proxy,\n            false,\n\
    \            false,\n            30000\n    );\n    if (res.StatusCode !== 200)\
    \ {\n        throw 'Failed to receieve valid answer: ' + res.Status;\n    }\n\n\
    \    return returnPlainResponse ? res : JSON.parse(res.Body);\n};\n\nvar parseAccountsFromErrorMessage\
    \ = function(message) {\n    var credentials = [];\n    // format: Too many password\
    \ objects matching query [Folder=...;Safe=...] were found: (Safe=...;Folder=...;Object=...\
    \ and Safe=...;Folder=...;Object=...) (Diagnostic Info: 41)\n    var accounts\
    \ = message.split(\"were found: (\")[1];\n    // format: Safe=...;Folder=...;Object=...\
    \ and Safe=...;Folder=...;Object=...) (Diagnostic Info: 41)\n    accounts = accounts.split(\"\
    )\")[0];\n    // format: Safe=...;Folder=...;Object=... and Safe=...;Folder=...;Object=...\n\
    \    accounts = accounts.split(\" and \");\n    accounts.forEach(function(accountString)\
    \ {\n        var crednetialDetails = {};\n        crednetialDetails.name = accountString.split(\"\
    ;Object=\")[1];\n        credentials.push(crednetialDetails);\n    });\n    return\
    \ credentials;\n}\n\nvar resetCredentials = function(args) {\n    sendRequestWithToken('PUT',\
    \ credentialsUrl + '/' + args.accountId + '/ChangeCredentials', args, true);\n\
    \n    return {\n        Type: entryTypes.note,\n        ContentsFormat: formats.json,\n\
    \        Contents: \"Operation succeeded.\",\n        ReadableContentsFormat:\
    \ formats.markdown\n    };\n};\n\nvar getAccountDetails = function(args) {\n \
    \   var result = sendRequestWithToken('GET', credentialsUrl, args);\n    if (!result)\
    \ {\n        return 'No results found';\n    }\n\n    return {\n        Type:\
    \ entryTypes.note,\n        ContentsFormat: formats.json,\n        Contents: result,\n\
    \        EntryContext: {'CyberArk.AIM(val.Name==obj.Name).Accounts': result.accounts},\n\
    \        ReadableContentsFormat: formats.markdown,\n        HumanReadable: tableToMarkdown('Found\
    \ ' + result.Count + ' accounts matching \"' + args.Keywords + '\". Displaying\
    \ only the first:', result.accounts)\n    };\n};\n\nvar getCredentials = function(asList)\
    \ {\n    args.AppID = appid;\n    args.Folder = params.folder;\n    args.Safe\
    \ = params.safe;\n\n    var credsToFetch  = [];\n    if (args.identifier) {\n\
    \        credsToFetch.push(args.identifier);\n        delete args.identifier;\n\
    \    } else if (params.credentialNames) {\n        credsToFetch = params.credentialNames.split(',');\n\
    \    }\n\n    var credentials = [];\n    for (var i = 0; i < credsToFetch.length;\
    \ i++) {\n        args.Object = credsToFetch[i].trim();\n\n        var result\
    \ = sendRequest('GET', accountsUrl, args);\n        if (result) {\n          \
    \  var itemToAdd = asList ? result : {\n                    'user': result.UserName,\n\
    \                    'password': result.Content,\n                    'name':\
    \ result.Name\n                };\n            credentials.push(itemToAdd);\n\
    \        }\n    }\n\n    if (credentials.length === 0) {\n        // no creds\
    \ were fetched - log to server\n        logInfo('No credentials were fetched for\
    \ [' + credsToFetch.join(', ') + ']');\n    }\n\n    return asList ? credentials\
    \ : JSON.stringify(credentials);\n}\n\nvar queryCredentials = function() {\n \
    \   args.AppID = appid;\n    if (!args.folder) {\n        args.Folder = params.folder;\n\
    \    } else {\n        args.Folder = args.folder;\n    }\n    if (!args.safe)\
    \ {\n        args.Safe = params.safe;\n    } else {\n        args.Safe = args.safe;\n\
    \    }\n    var argsKeys = Object.keys(args);\n    cleanArgs = {};\n    argsKeys.forEach(function(key)\
    \ {\n        var upperKey = key.charAt(0).toUpperCase() + key.substr(1);\n   \
    \     cleanArgs[upperKey] = args[key];\n        delete args[key];\n    });\n \
    \   var result = sendRequest('GET', accountsUrl, cleanArgs);\n    var res = result;\n\
    \    var humanReadable = null;\n    // If we recieved too many (limited by CyberArk)\
    \ then return a warning.\n    if (result && result.ErrorMsg && result.ErrorMsg.indexOf(\"\
    Too many\") > -1) {\n        var accounts = parseAccountsFromErrorMessage(result.ErrorMsg);\n\
    \        res = \"Found \" + accounts.length + \" results or more, while can only\
    \ get one. Please try to narrow down the search by adding more filters.\";\n \
    \       humanReadable = res;\n    } else if (result && result.ErrorMsg) {\n  \
    \      res = \"Error: \" + result.ErrorMsg;\n        humanReadable = res;\n  \
    \  } else {\n       humanReadable = tableToMarkdown('Credentials Results', result);\n\
    \    }\n    return {\n        Type: entryTypes.note,\n        ContentsFormat:\
    \ formats.json,\n        Contents: res,\n        ReadableContentsFormat: formats.markdown,\n\
    \        HumanReadable: humanReadable\n    };\n}\n\nvar listCredentials = function()\
    \ {\n    var creds = getCredentials(true);\n\n    for (var i = 0; i < creds.length;\
    \ i++) {\n        // delete password\n        delete creds[i].Content;\n    }\n\
    \n    return {\n        Type: entryTypes.note,\n        ContentsFormat: formats.json,\n\
    \        Contents: creds,\n        EntryContext: {'CyberArk.AIM(val.Name==obj.name)':\
    \ creds},\n        ReadableContentsFormat: formats.markdown,\n        HumanReadable:\
    \ tableToMarkdown('Credentials fetched from CyberArk AIM valut:', creds)\n   \
    \ };\n}\n\nfunction testModuleAndCredentials() {\n    args.AppID = appid;\n  \
    \  args.Folder = params.folder;\n    args.Safe = params.safe;\n\n    var paramCredsString\
    \ = params.credentialNames;\n    if (!paramCredsString) {\n        sendRequest('GET',\
    \ accountsUrl, args);\n    } else {\n        var names = paramCredsString.split(',');\n\
    \        for (var i = 0; i < names.length; i++) {\n            var name = names[i].trim()\n\
    \            args.Object = name\n            // exception would be thrown if identifier\
    \ (Object) does not exists\n            var result = sendRequest('GET', accountsUrl,\
    \ args);\n            if (!result) {\n                throw 'Could not find object\
    \ for: \"' + name + '\"'\n            }\n        }\n    }\n\n    return 'ok';\n\
    }\n\nswitch (command) {\n    case 'test-module':\n        return testModuleAndCredentials();\n\
    \    case 'fetch-credentials':\n        return getCredentials();\n    case 'cyber-ark-aim-query':\n\
    \        return queryCredentials();\n    case 'reset-credentials':\n        return\
    \ resetCredentials(args);\n    case 'account-details':\n        args.Safe = args.safe\
    \ || params.safe;\n        delete args.safe;\n        args.Keywords = args.keywords;\n\
    \        delete args.keywords;\n        return getAccountDetails(args);\n    case\
    \ 'list-credentials':\n        return listCredentials();\n    default:\n     \
    \   throw 'Command \"' + command + '\" is not supported.';\n}"
  type: javascript
tests:
- No test
toversion: 4.1.9
