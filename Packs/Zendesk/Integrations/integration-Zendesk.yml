category: Case Management
commonfields:
  id: Zendesk
  version: -1
configuration:
- defaultvalue: ''
  display: Zendesk address (e.g. https://demisto.zendesk.com)
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: Username (email address)
  name: username
  required: true
  type: 0
- defaultvalue: ''
  display: API key
  name: api
  required: true
  type: 4
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: '10'
  display: Initial fetching history (in minutes)
  name: fetch_interval
  required: false
  type: 0
- defaultvalue: -status:solved -status:closed
  display: Fetch incident query
  name: fetchQuery
  required: false
  type: 0
description: IT service management
detaileddescription: Zendesk integration requires the API key and a username.
display: Zendesk
fromversion: 3.5.0
image: data:image/png;base64,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
name: Zendesk
script:
  commands:
  - arguments:
    - description: The subject of the ticket.
      name: subject
    - description: The email address of the user that opened the ticket.
      name: requester_email
    - description: The email address of the agent to assign to the ticket.
      name: assignee_email
    - description: Comment body for the ticket.
      name: comment
      required: true
    - auto: PREDEFINED
      defaultValue: 'no'
      description: Whether the comment body is private. Can be "yes" or "no". Default
        is "no".
      name: private
      predefined:
      - 'yes'
      - 'no'
    - auto: PREDEFINED
      description: Ticket type. Can be "problem", "incident", "question", or "task".
      name: type
      predefined:
      - problem
      - incident
      - question
      - task
    - auto: PREDEFINED
      description: Ticket priority. Can be "urgent", "high", "normal", or "low".
      name: priority
      predefined:
      - urgent
      - high
      - normal
      - low
    - description: An array of tags to add to the ticket.
      isArray: true
      name: tags
    - description: An ID to link Zendesk Support tickets to local records.
      name: external_id
    - description: The numeric ID of the topic from which the ticket originated.
      name: forum_topic_id
    - description: For tickets of type "incident", the numeric ID of the problem to
        which the incident is linked.
      name: problem_id
    - description: 'For tickets of type "task", the due date of the task. Date format
        is ISO 8601, for example: (yyyy-mm-dd).'
      name: due_at
    - description: The ID of a closed ticket for a follow-up ticket.
      name: via_followup_source_id
    - description: An array of numeric IDs, emails, or objects containing name and
        email properties. See Setting Collaborators. An email notification is sent
        to collaborators when the ticket is created.
      isArray: true
      name: collaborators
    - description: 'An array of the custom fields of the ticket. For example: fieldid=text,fieldid=text'
      name: custom_fields
    description: Creates a new ticket in the Zendesk.
    name: zendesk-create-ticket
    outputs:
    - contextPath: Ticket.id
      description: Ticket ID.
    - contextPath: Ticket.vendor
      description: Zendesk.
    - contextPath: Ticket.description
      description: Ticket description.
    - contextPath: Ticket.subject
      description: Ticket subject.
  - arguments:
    - description: 'Query to search for tickets. For more information about the search
        syntax, see https://developer.zendesk.com/rest_api/docs/core/search. '
      name: query
    description: 'Lists all open tickets in Zendesk. '
    name: zendesk-list-tickets
    outputs:
    - contextPath: Ticket.id
      description: Ticked ID.
    - contextPath: Ticket.description
      description: Ticket description.
    - contextPath: Ticket.subject
      description: Ticket subject.
    - contextPath: Ticket.vendor
      description: Zendesk.
  - arguments:
    - default: true
      description: Ticket ID. If not provided, the command will use the current incident
        details (for tickets that were created by the Zendesk integration).
      name: id
    description: Returns details for a Zendesk ticket.
    name: zendesk-ticket-details
    outputs:
    - contextPath: Ticket.subject
      description: Subject of the Zendesk ticket.
    - contextPath: Ticket.created_at
      description: Date and time that the Zendesk ticket was created.
    - contextPath: Ticket.description
      description: Description of the Zendesk ticket.
    - contextPath: Ticket.priority
      description: Priority of the Zendesk ticket.
    - contextPath: Ticket.status
      description: Status of the Zendesk ticket.
  - arguments:
    - description: The subject of the ticket.
      name: subject
    - description: The email address of the user that opened the ticket.
      name: requester_email
    - description: The email address of the agent to assign to the ticket.
      name: assignee_email
    - auto: PREDEFINED
      description: Ticket type. Can be "problem", "incident", "question", or "task".Allowed
        values are problem, incident, question, or task
      name: type
      predefined:
      - problem
      - incident
      - question
      - task
    - auto: PREDEFINED
      description: Ticket priority. Can be "urgent", "high", "normal", or "low".
      name: priority
      predefined:
      - urgent
      - high
      - normal
      - low
    - description: An array of tags to add to the ticket.
      isArray: true
      name: tags
    - description: An ID to link Zendesk support tickets to local records.
      name: external_id
    - description: For tickets of type "incident", the numeric ID of the problem to
        which the incident is linked.
      name: problem_id
    - description: 'For tickets of type "task", the due date of the task. Date format
        is ISO 8601, for example: (yyyy-mm-dd).'
      name: due_at
    - description: An array of numeric IDs, emails, or objects containing name and
        email properties. See Setting Collaborators. An email notification is sent
        to collaborators when the ticket is created.
      isArray: true
      name: collaborators
    - default: true
      description: Ticket ID. If not provided, the command will use the current incident
        details (for tickets that were created by the Zendesk integration).
      name: id
    - auto: PREDEFINED
      description: Ticket status. Can be "open, "pending", "hold", "solved", or "closed".
      name: status
      predefined:
      - open
      - pending
      - hold
      - solved
      - closed
    - description: 'An array of the custom fields of the ticket. For example: fieldid=text,fieldid=text'
      name: custom_fields
    description: Updates a Zendesk ticket.
    name: zendesk-update-ticket
  - arguments:
    - default: true
      description: Comment text to add to the ticket.
      name: comment
      required: true
    - auto: PREDEFINED
      defaultValue: 'no'
      description: Whether the comment body is private. Can be "yes" or "no". Default
        is "no".
      name: private
      predefined:
      - 'yes'
      - 'no'
    - description: Ticket ID. If not provided, the command will use the current incident
        details (for tickets that were created by the Zendesk integration).
      name: id
    - auto: PREDEFINED
      defaultValue: 'yes'
      description: Whether to add Demisto footer to the comment. Default is "yes".
      name: addFooter
      predefined:
      - 'yes'
      - 'no'
    description: Adds a comment to an existing Zendesk ticket.
    name: zendesk-add-comment
  - arguments: []
    description: Lists all the Zendesk agents and admins users.
    name: zendesk-list-agents
    outputs:
    - contextPath: ZendeskUsers.id
      description: ID of the Zendesk agent.
    - contextPath: ZendeskUsers.name
      description: Name of the Zendesk agent.
    - contextPath: ZendeskUsers.email
      description: Email address of the Zendesk agent.
    - contextPath: ZendeskUsers.role
      description: Role of the Zendesk agent.
    - contextPath: ZendeskUsers.timeZone
      description: 'Time zone in which Zendesk agent '
  - arguments:
    - description: Attachment id
      name: id
      required: true
    description: Returns an attachment from Zendesk.
    name: zendesk-get-attachment
  - arguments: []
    description: Clears the Zendesk integration cache.
    name: zendesk-clear-cache
  - arguments:
    - description: Full name of teh user to add.
      name: name
      required: true
    - description: Email address of the user to add.
      name: email
      required: true
    - auto: PREDEFINED
      default: true
      defaultValue: 'False'
      description: Whether to check if the specified user already exists in Zendesk.
        Can be "True" or "False". Default is "False".
      name: check_if_user_exists
      predefined:
      - 'True'
      - 'False'
    description: Adds a user (not agent or admin) to Zendesk.
    name: zendesk-add-user
  - arguments:
    - default: true
      description: ID of the article to return.
      name: articleID
      required: true
    - description: Locale. Defaults to en-us
      name: locale
    description: Returns an article from the Zendesk Help Center.
    name: zendesk-get-article
  isfetch: true
  script: "var cachedInfo = getIntegrationContext();\nif (!cachedInfo) {\n    cachedInfo\
    \ = {users: {}, customFields: {}};\n}\nif (!cachedInfo.user) {\n    cachedInfo.users\
    \ = {};\n}\nif (!cachedInfo.customFields) {\n    cachedInfo.customFields = {};\n\
    }\nif (!cachedInfo.timestamp) {\n    cachedInfo.timestamp = new Date().getTime();\n\
    } else {\n    logDebug('cachedInfo.timestamp==' + cachedInfo.timestamp + '. now==\
    \ ' + new Date().getTime());\n    if (cachedInfo.timestamp + (1000 * 3600 * 24)\
    \ < new Date().getTime()) {\n        logInfo('Clearing Zendesk cache');\n    \
    \    cachedInfo.timestamp = new Date().getTime();\n        cachedInfo.users =\
    \ {};\n        cachedInfo.customFields = {};\n    }\n}\nvar quoteMd = function(text)\
    \ {\n    var res = '';\n    text.split('\\n').forEach(function(line) {\n     \
    \   res +=  '>' + line + '\\n';\n    });\n    return res;\n};\nvar escapeMd =\
    \ function(text) {\n    return text.split('|').join('\\\\|');\n};\nvar getTicketId\
    \ = function() {\n    var ticketId = args.id;\n    if (!ticketId) {\n        labels\
    \ = dq(incidents[0],'labels');\n        labels.forEach(function(label) {\n   \
    \         if (label.type == 'TicketId') {\n                ticketId = label.value;\n\
    \            }\n        });\n    }\n    if (!ticketId) {\n        throw 'Missing\
    \ Zendesk ticket ID';\n    }\n    return ticketId;\n};\nvar getAttachmentId =\
    \ function() {\n    return (args.id.indexOf(':') > -1) ? args.id.split(':')[0]\
    \ : args.id;\n};\nvar loadCustomFields = function() {\n    resCusFields = sendRequest('GET',\
    \ 'ticket_fields.json');\n    var dicFields = {};\n    var arrUsers = [];\n  \
    \  for (var i = 0; i < resCusFields.ticket_fields.length; i++) {\n        if (resCusFields.ticket_fields[i].active)\
    \ {\n            dicFields['id_' + resCusFields.ticket_fields[i].id] = resCusFields.ticket_fields[i].title;\n\
    \            dicFields['name_' + resCusFields.ticket_fields[i].title] = resCusFields.ticket_fields[i].id;\n\
    \        }\n    }\n    cachedInfo.customFields = dicFields;\n    setIntegrationContext(cachedInfo);\n\
    };\nvar getUserDetails = function(id) {\n    if (!cachedInfo.users || !cachedInfo.users[id])\
    \ {\n        var res = sendRequest('GET', 'users/' + id + '.json');\n        cachedInfo.users[id]\
    \ = res.user;\n        setIntegrationContext(cachedInfo);\n    }\n    if (cachedInfo.users[id])\
    \ {\n        return cachedInfo.users[id];\n    } else {\n        return null;\n\
    \    }\n};\nvar getOrganizationDetails = function(id) {\n    var res = sendRequest('GET',\
    \ 'organizations/' + id + '.json');\n    return res.organization;\n};\nvar getUserName\
    \ = function(id) {\n    var user = getUserDetails(id);\n    if (user) {\n    \
    \    return cachedInfo.users[id].name + ' (' + cachedInfo.users[id].email + ')';\n\
    \    } else {\n        return 'N/A';\n    }\n};\nvar getCustomFieldName = function(id)\
    \ {\n    if (!cachedInfo.customFields || !cachedInfo.customFields[id]) {\n   \
    \     loadCustomFields();\n    }\n    return cachedInfo.customFields['id_' + id];\n\
    };\nvar getCustomFieldId = function(name) {\n    if (!cachedInfo.customFields\
    \ || !cachedInfo.customFields[name]) {\n        loadCustomFields();\n    }\n \
    \   return cachedInfo.customFields['name_' + name];\n};\nvar sendRequest = function(method,\
    \ url, body, attr) {\n    var requestUrl = params.url + \"/api/v2/\" + url + encodeToURLQuery(attr);\n\
    \    var res;\n    var headers = {\n        'Content-Type': ['application/json']\n\
    \    };\n    res = http(\n        requestUrl,\n        {\n            Method:\
    \ method,\n            Headers: headers,\n            Username: params.username\
    \ + '/token',\n            Password: params.api,\n            Body: body\n   \
    \     },\n        params.insecure,\n        params.proxy\n        );\n    if (res.StatusCode\
    \ < 200 || res.StatusCode >= 300) {\n        throw 'Request Failed.\\nStatus code:\
    \ ' + res.StatusCode + '.\\nBody: ' + JSON.stringify(res.Body) + '.';\n    }\n\
    \    try {\n        return JSON.parse(res.Body);\n    } catch (ex) {\n       \
    \ throw 'Error in parsing reply - ' + res.Body + ' - ' + ex;\n    }\n};\nvar createTicket\
    \ = function() {\n    var ec = {Ticket: []};\n    var md = '## Zendesk tickets\\\
    n';\n    var isPublic = (args.private === 'no');\n    var body = {\n         \
    \   ticket: {\n                comment: {\n                    body: args.comment,\n\
    \                    'public': isPublic\n                }\n            }\n  \
    \      };\n    if (args.requester_email) {\n        var reqRequester = sendRequest('GET',\
    \ 'users/search.json', '', {query: args.requester_email});\n        if (reqRequester.users.length\
    \ > 0) {\n            body.ticket.requester_id = reqRequester.users[0].id;\n \
    \       } else {\n            throw 'There is no such requester email';\n    \
    \    }\n    }\n    if (args.assignee_email) {\n        var reqAssignee = sendRequest('GET',\
    \ 'users/search.json', '', {query: args.assignee_email});\n        if (reqAssignee.users.length\
    \ > 0) {\n            body.ticket.assignee_id = reqAssignee.users[0].id;\n   \
    \     } else {\n            throw 'There is no such assignee email';\n       \
    \ }\n    }\n    if (args.custom_fields) {\n        var arrCust = args.custom_fields.split(',');\n\
    \        var dicCustStr = {};\n        for (var i = 0; i < arrCust.length; i++)\
    \ {\n            var tmpKey = arrCust[i].split('=');\n            dicCustStr[tmpKey[0]]\
    \ = tmpKey[1];\n        }\n        var arrRes = [];\n        for (var strKey in\
    \ dicCustStr) {\n            arrRes.push({\n                id: getCustomFieldId(strKey),\n\
    \                value: dicCustStr[strKey]\n            });\n        }\n     \
    \   body.ticket.custom_fields = arrRes;\n    }\n    var ticket = {};\n    for\
    \ (var key in args) {\n        if (key !== 'comment' &&\n            key !== 'private'\
    \ &&\n            key !== 'requester_email' &&\n            key !== 'assignee_email'\
    \ &&\n            key !== 'custom_fields') {\n            body.ticket[key] = args[key];\n\
    \            ticket[key] = args[key];\n        }\n    }\n    res = sendRequest('POST',\
    \ 'tickets.json', JSON.stringify(body));\n    md += 'The ticket has been successfully\
    \ created with id ' + res.ticket.id + '.\\n';\n    ticket.id = res.ticket.id;\n\
    \    ticket.vendor = 'Zendesk';\n    ticket.description = args.body;\n    ticket.subject\
    \ = args.subject;\n    ec.Ticket.push(ticket);\n    return ( {ContentsFormat:\
    \ formats.json, Type: entryTypes.note, Contents: res, HumanReadable: md, EntryContext:\
    \ ec} );\n};\nvar listTickets = function() {\n    var searchQ;\n    if (!args.query)\
    \ {\n        searchQ = 'type:ticket -status:solved -status:closed';\n    } else\
    \ {\n        searchQ = 'type:ticket ' + args.query;\n    }\n    var att = {query:\
    \ searchQ, sort_by: 'created_at', sort_order: 'desc'};\n    res = sendRequest('GET',\
    \ 'search.json', '', att);\n    var ec = {Ticket: []};\n    var md = '## Zendesk\
    \ tickets\\n';\n    md += 'Id|Created|Subject|Status\\n';\n    md += '-|-|-|-|-\\\
    n';\n    for (var i = 0; i <  res.results.length; i++) {\n        ec.Ticket.push({\n\
    \            id: res.results[i].id,\n            description: res.results[i].description,\n\
    \            subject: res.results[i].subject,\n            vendor: 'Zendesk'\n\
    \        });\n        md += res.results[i].id + '|' + res.results[i].created_at\
    \ + '|' + escapeMd(res.results[i].subject) + '|' + res.results[i].status + '\\\
    n';\n    }\n    return ( {ContentsFormat: formats.json, Type: entryTypes.note,\
    \ Contents: res, HumanReadable: md, EntryContext: ec} );\n};\nvar updateTicket\
    \ = function() {\n    var ticketId = getTicketId();\n    var md = '## Zendesk\
    \ tickets\\n';\n    var ec = {};\n    var body = {ticket: {}};\n    if (args.requester_email)\
    \ {\n        var reqRequester = sendRequest('GET', 'users/search.json', '', {query:\
    \ args.requester_email});\n        if (reqRequester.users.length > 0) {\n    \
    \        body.ticket.requester_id = reqRequester.users[0].id;\n        } else\
    \ {\n            throw 'There is no such requester email';\n        }\n    }\n\
    \    if (args.assignee_email) {\n        var reqAssignee = sendRequest('GET',\
    \ 'users/search.json', '', {query: args.assignee_email});\n        if (reqAssignee.users.length\
    \ > 0) {\n            body.ticket.assignee_id = reqAssignee.users[0].id;\n   \
    \     } else {\n            throw 'There is no such assignee email';\n       \
    \ }\n    }\n    if (args.custom_fields) {\n        var arrCust = args.custom_fields.split(',');\n\
    \        var dicCustStr = {};\n        for (var i = 0; i < arrCust.length; i++)\
    \ {\n            var tmpKey = arrCust[i].split('=');\n            dicCustStr[tmpKey[0]]\
    \ = tmpKey[1];\n        }\n        var arrRes = [];\n        for (strKey in dicCustStr)\
    \ {\n            arrRes.push({\n                id: getCustomFieldId(strKey),\n\
    \                value: dicCustStr[strKey]\n            })\n        }\n      \
    \  body.ticket.custom_fields = arrRes;\n    }\n    for (var key in args) {\n \
    \       if (key !== 'id' &&\n            key !== 'requester_email' &&\n      \
    \      key !== 'assignee_email' &&\n            key !== 'custom_fields') {\n \
    \           body.ticket[key] = args[key];\n            ec['Ticket(val.id == '\
    \ + ticketId + ').' + key] = args[key];\n        }\n    }\n    res = sendRequest('PUT',\
    \ 'tickets/' + ticketId + '.json', JSON.stringify(body));\n    md += 'Ticket number\
    \ ' + ticketId + ' has been updated successfully.\\n';\n    return ( {'ContentsFormat':\
    \ formats.json, 'Type': entryTypes.note, 'Contents': res, \"HumanReadable\": md}\
    \ );\n};\nvar addComment = function() {\n    var ticketId = getTicketId();\n \
    \   var md = '## Zendesk tickets\\n';\n    var isPublic = (args.private === 'no')\
    \ ? true : false;\n    var comment = args.comment;\n    if (args.addFooter ==\
    \ 'yes') {\n        comment += '\\n\\n---------\\nPosted using Demisto-Zendesk\
    \ integration';\n    }\n    var body = {\n            ticket: {\n            \
    \    comment: {\n                    body: comment.split('\\\\n').join('\\n'),\n\
    \                    'public': isPublic\n                }\n            }\n  \
    \      };\n    res = sendRequest('PUT', 'tickets/' + ticketId + '.json', JSON.stringify(body));\n\
    \    md += 'Comment added successfully.\\n';\n    return ( {'ContentsFormat':\
    \ formats.json, 'Type': entryTypes.note, 'Contents': res, \"HumanReadable\": md}\
    \ );\n};\nvar addUser = function() {\n    var check_if_user_exists = (args.check_if_user_exists\
    \ == 'True');\n    var requests_suffix = check_if_user_exists ? 'users.json' :\
    \ 'users/create_or_update.json';\n    var body = {\n            user: {\n    \
    \            name: args.name,\n                email: args.email\n           \
    \ }\n    };\n    res = sendRequest('POST', requests_suffix, JSON.stringify(body));\n\
    \    md = 'Zendesk user added successfuly - ' + args.name + ' (' + args.email\
    \ + ')\\n';\n    return ( {'ContentsFormat': formats.json, 'Type': entryTypes.note,\
    \ 'Contents': res, \"HumanReadable\": md} );\n};\nvar addMinutes = function(date,\
    \ minutes) {\n        return new Date(date.getTime() + minutes*60000);\n};\nvar\
    \ getNowTime = function(minutesOffset) {\n        var time = new Date();\n   \
    \     time = addMinutes(time,time.getTimezoneOffset());\n        time = (minutesOffset)\
    \ ? addMinutes(time,minutesOffset) : time;\n        var month = \"0\" + (time.getMonth()+1);\n\
    \        var day = \"0\" + time.getDate();\n        var hours = \"0\" + time.getHours();\n\
    \        var minutes = \"0\" + time.getMinutes();\n        var seconds = \"0\"\
    \ + time.getSeconds();\n        var dateOld = time.getFullYear()+'-'+month.substr(-2)+'-'+day.substr(-2);\n\
    \        var timeOld = hours.substr(-2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);\n\
    \        sertime = dateOld + \"T\" + timeOld + 'Z';\n        return sertime;\n\
    };\nvar getTicketDetails = function() {\n    var ticketId = getTicketId();\n \
    \   var resDetails = sendRequest('GET', 'tickets/' + ticketId + '.json');\n  \
    \  var md = '### Zendesk ticket #' + resDetails.ticket.id + \" - \" + resDetails.ticket.subject\
    \ + \"\\n\";\n    var ec = {}\n    var usersEc = {}\n    var org = {};\n    var\
    \ newContext = {};\n    md += 'Requester: __' + getUserName(resDetails.ticket.requester_id)\
    \ + '__\\n';\n    usersEc[resDetails.ticket.requester_id]=getUserName(resDetails.ticket.requester_id);\n\
    \    if (resDetails.ticket.organization_id) {\n        org = getOrganizationDetails(resDetails.ticket.organization_id);\n\
    \        var tags = (org.tags && org.tags.length > 0) ? ' (' + org.tags.join(',\
    \ ') + ')' : '';\n        md += 'Organization: __' + org.name + '__' + tags +'\\\
    n';\n    }\n    md += 'Created time: __' + resDetails.ticket.created_at + '__\\\
    n';\n    md += 'Priority: __' + resDetails.ticket.priority + '__\\n';\n    md\
    \ += 'Status: __' + resDetails.ticket.status + '__\\n';\n    if (resDetails.ticket.assignee_id)\
    \ {\n        md += 'Assignee: __' + getUserName(resDetails.ticket.assignee_id)\
    \ + '__\\n';\n        usersEc[resDetails.ticket.assignee_id]=getUserName(resDetails.ticket.assignee_id);\n\
    \    }\n    if (resDetails.ticket.recipient) {\n        md += 'Recipients: __'\
    \ + resDetails.ticket.recipient + '__\\n';\n    }\n    md += \"#### Description\\\
    n\";\n    md += quoteMd(resDetails.ticket.description) + \"\\n\";\n    var fieldsMd\
    \ = '';\n    var fieldsEc = {};\n    for (var i = 0; i < resDetails.ticket.custom_fields.length;\
    \ i++) {\n        if (resDetails.ticket.custom_fields[i].value) {\n          \
    \  fieldsMd += \"- __\" + getCustomFieldName(resDetails.ticket.custom_fields[i].id)\
    \ + \"__: \" + resDetails.ticket.custom_fields[i].value + \"\\n\";\n         \
    \   fieldsEc[resDetails.ticket.custom_fields[i].id] = getCustomFieldName(resDetails.ticket.custom_fields[i].id)\n\
    \        }\n    }\n    if (fieldsMd) {\n        md += \"#### Custom fields\\n\"\
    ;\n        md += fieldsMd;\n    }\n    newContext.id = resDetails.ticket.id;\n\
    \    newContext.subject = resDetails.ticket.subject;\n    newContext.created_at\
    \ = resDetails.ticket.created_at;\n    newContext.description = resDetails.ticket.description;\n\
    \    newContext.priority = resDetails.ticket.priority;\n    newContext.status\
    \ = resDetails.ticket.status;\n    newContext.attachments = [];\n    resComments\
    \ = sendRequest('GET', 'tickets/' + ticketId + '/comments.json');\n    if (resComments.comments[0].attachments.length>0)\
    \ {\n        md += '#### Attachments\\n';\n        resComments.comments[0].attachments.forEach(function(attachment)\
    \ {\n            md += '- ' +  attachment.id.toString() + ': ' + attachment.file_name\
    \ + '\\n';\n            newContext.attachments.push({id: attachment.id.toString(),\
    \ filename: attachment.file_name});\n        });\n    }\n    // starting at 1,\
    \ as the first comment is actually the ticket description\n    for (var i = resComments.comments.length\
    \ - 1; i > 0; i--) {\n        var userName = getUserName(resComments.comments[i].author_id)\n\
    \        if (resComments.comments[i].public) {\n            md += '##### Public\
    \ comment #' + (i+1) + ' ' + resComments.comments[i].created_at + ' by ' + userName\
    \ + '\\n';\n        } else {\n            md += '##### Private comment #' + (i+1)\
    \ + ' ' + resComments.comments[i].created_at + ' by ' + userName + '\\n';\n  \
    \      }\n        md += quoteMd(resComments.comments[i].body) + '\\n\\n';\n  \
    \      if (resComments.comments[i].attachments.length > 0) {\n            md +=\
    \ '- Attachments\\n';\n            resComments.comments[i].attachments.forEach(function(attachment)\
    \ {\n                md += '   - ' +  attachment.id.toString() + ': ' + attachment.file_name\
    \ + '\\n';\n                newContext.attachments.push({id: attachment.id, filename:\
    \ attachment.file_name});\n            });\n        }\n    }\n    context = dq(invContext,\
    \ 'Ticket(val.id == ' + ticketId + ').id');\n    if (context) {\n        ec['Ticket(val.id\
    \ == ' + ticketId + ')'] = newContext;\n    } else {\n        ec.Ticket = newContext;\n\
    \    }\n    var res = {\n        TicketDetails: resDetails,\n        TicketComments:\
    \ resComments,\n        Users: usersEc,\n        Organization: org,\n        CustomFields:\
    \ fieldsEc\n    }\n    return({ContentsFormat: formats.json, Type: entryTypes.note,\
    \ Contents: res, HumanReadable: md, EntryContext: ec})\n};\nvar getArticle = function()\
    \ {\n    var locale = args.locale || 'en-us';\n    var url = 'help_center/' +\
    \ locale + '/articles/' + args.articleID + '.json';\n    res = sendRequest('GET',\
    \ url);\n    return ( {ContentsFormat: formats.html, Type: entryTypes.note, Contents:\
    \ res.article.body} );\n}\nvar getAttachment = function() {\n    var attachmentId\
    \ = getAttachmentId();\n    var res = sendRequest('GET', 'attachments/' + attachmentId\
    \ + '.json');\n    var attachBin = http(res.attachment.content_url,{\n       \
    \         Method: 'GET',\n                Username: params.username + '/token',\n\
    \                Password: params.api,\n                SaveToFile: true\n   \
    \         },\n            params.insecure,\n            params.proxy);\n    return\
    \ ({Type: 3, FileID: attachBin.Path, File: res.attachment.file_name, Contents:\
    \ res.attachment.file_name});\n};\nvar listAgents = function() {\n    res = sendRequest('GET',\
    \ 'users.json?role[]=agent&role[]=admin');\n    var md = '## Zendesk user details\\\
    n';\n    var ec = {ZendeskUsers: []};\n    md += 'Id|Name|Email|Role|Time Zone\\\
    n';\n    md += '---|---|---|---|---\\n';\n    for (var i = 0; i < res.users.length;\
    \ i++) {\n        md += res.users[i].id + '|';\n        md += res.users[i].name\
    \ + '|';\n        md += res.users[i].email + '|';\n        md += res.users[i].role\
    \ + '|';\n        md += res.users[i].time_zone + '\\n';\n        ec.ZendeskUsers.push({\n\
    \            id: res.users[i].id,\n            name: res.users[i].name,\n    \
    \        email: res.users[i].email,\n            role: res.users[i].role,\n  \
    \          timeZone: res.users[i].time_zone\n        });\n    }\n    return (\
    \ {ContentsFormat: formats.json, Type: entryTypes.note, Contents: res, HumanReadable:\
    \ md, EntryContext: ec} );\n};\nvar fetchIncidents = function() {\n    var now\
    \ = getLastRun();\n    var sertime;\n    var incidents = [];\n    var labels =\
    \ [];\n    if (!params.fetch_interval) {\n        params.fetch_interval = 10;\n\
    \    }\n    if (!now.time) {\n        sertime = getNowTime((-1) * parseInt(params.fetch_interval));\n\
    \    } else {\n        sertime = now.time;\n    }\n    var att = {query: 'type:ticket\
    \ created>' + sertime + ' ' + params.fetchQuery};\n    res = sendRequest('GET',\
    \ 'search.json', '', att);\n    if (res.results.length > 0) {\n        for (var\
    \ i = 0; i < res.results.length; i++) {\n            var resComments = sendRequest('GET',\
    \ 'tickets/' + res.results[i].id + '/comments.json');\n            resComments.comments[0].attachments.forEach(function(attachment)\
    \ {\n                labels.push({type: 'TicketAttachment', value: attachment.id.toString()\
    \ + ':' + attachment.file_name});\n            });\n            var ticketId =\
    \ res.results[i].id + '';\n            labels.push({type: 'TicketId', value: ticketId.toString()});\n\
    \            labels.push({type: 'TicketSubject', value: res.results[i].subject});\n\
    \            labels.push({type: 'TicketCreated', value: res.results[i].created_at});\n\
    \            incidents.push({\n                name: parseInt(res.results[i].id)\
    \ + ' - ' + res.results[i].subject,\n                details: res.results[i]['description'],\n\
    \                labels: labels,\n                rawJSON: JSON.stringify(res.results[i]),\n\
    \                severity: parseInt(res.results[i].priority)\n            });\n\
    \            labels = [];\n        }\n        setLastRun({'time': res.results[0].created_at});\n\
    \    }\n    return JSON.stringify(incidents);\n}\nswitch (command) {\n    // This\
    \ is the call made when pressing the integration test button.\n    case 'test-module':\n\
    \        var res = sendRequest('GET', 'users/me.json');\n        if (res.user.name\
    \ !== 'Anonymous user' &&\n            res.user.id) {\n            return 'ok';\n\
    \        }\n        return JSON.stringify(res);\n    case 'zendesk-create-ticket':\n\
    \        return createTicket();\n    case 'zendesk-list-tickets':\n        return\
    \ listTickets();\n    case 'zendesk-update-ticket':\n        return updateTicket();\n\
    \    case 'zendesk-add-comment':\n        return addComment();\n    case 'zendesk-ticket-details':\n\
    \        return getTicketDetails();\n    case 'zendesk-list-agents':\n       \
    \ return listAgents();\n    case 'zendesk-get-attachment':\n        return getAttachment();\n\
    \    case 'zendesk-get-article':\n        return getArticle();\n    case 'zendesk-clear-cache':\n\
    \        setIntegrationContext({});\n        return 'Cache cleared';\n    case\
    \ 'zendesk-add-user':\n        return addUser();\n    case 'fetch-incidents':\n\
    \        return fetchIncidents();\n    default:\n        throw 'Zendesk: Unknown\
    \ command';\n}\n"
  type: javascript
tests:
- No test - tested manually Zendesk_test playbook
toversion: 4.1.9
