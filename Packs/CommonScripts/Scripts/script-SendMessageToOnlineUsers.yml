args:
- auto: PREDEFINED
  defaultValue: Email
  description: Medium to send message over (Slack, Mattermost, Email).
  name: medium
  predefined:
  - Slack
  - Mattermost
  - Email
  - All
- default: true
  description: Message to send
  name: message
  required: true
comment: Send message to Demisto online users over Email, Slack, Mattermost or all.
commonfields:
  id: SendMessageToOnlineUsers
  version: -1
enabled: true
name: SendMessageToOnlineUsers
runonce: false
script: "var commandAvailable = function(command) {\n    var ret = false;\n    var\
  \ allModules = getModulesForCommand(command);\n    if (allModules) {\n        var\
  \ instanceKeys = Object.keys(allModules);\n        instanceKeys.forEach(function\
  \ (key) {\n            if (allModules[key].state === 'active') {\n             \
  \   ret = true;\n            }\n        });\n    }\n    return ret;\n};\nvar medium\
  \ = (args.medium) ? args.medium.toLowerCase() : 'email';\nvar slackEnabled = commandAvailable('slack-send');\n\
  var mattermostEnabled = commandAvailable('mattermost-send');\nvar emailEnabled =\
  \ commandAvailable('send-mail');\n\nif (!slackEnabled && !emailEnabled && !mattermostEnabled)\
  \ {\n    throw 'No available medium to send message';\n}\nif (medium === 'email'\
  \ && !emailEnabled) {\n  throw 'Email integration not available';\n}\nif (medium\
  \ === 'slack' && !slackEnabled) {\n  throw 'Slack integration not available';\n\
  }\nif (medium === 'mattermost' && !mattermostEnabled) {\n  throw 'Mattermost integration\
  \ not available';\n}\n\nvar res = executeCommand(\"getUsers\", {online: true});\n\
  if (isError(res[0])) {\n    return res[0];\n}\nvar users = dq(res[0].Contents,'email');\n\
  \nvar entries = [];\nvar sent = [];\nusers.forEach(function(user) {\n    if ((medium\
  \ === 'all' && emailEnabled) || medium === 'email') {\n        res = executeCommand(\"\
  send-mail\", {to: user, subject: 'Notification from Demisto server', body: args.message});\n\
  \        if (isError(res[0])) {\n            entries.push(res[0]);\n        } else\
  \ {\n            sent.push(user);\n        }\n    }\n    if ((medium === 'all' &&\
  \ slackEnabled) || medium === 'slack') {\n        res = executeCommand(\"slack-send\"\
  , {to: user, message: args.message});\n        if (isError(res[0])) {\n        \
  \    entries.push(res[0]);\n        } else {\n            sent.push(user);\n   \
  \     }\n    }\n    if ((medium === 'all' && mattermostEnabled) || medium === 'mattermost')\
  \ {\n        res = executeCommand(\"mattermost-send\", {to: user, message: args.message});\n\
  \        if (isError(res[0])) {\n            entries.push(res[0]);\n        } else\
  \ {\n            sent.push(user);\n        }\n    }\n});\n\nif (sent.length > 0)\
  \ {\n    entries.push('Successfully sent ' + medium + ' message to ' + sent.join(','));\n\
  }\n\nreturn entries;"
scripttarget: 0
tags: []
tests:
- No test
toversion: 4.1.9
type: javascript
