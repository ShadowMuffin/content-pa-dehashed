category: Data Enrichment & Threat Intelligence
commonfields:
  id: iDefense
  version: -1
configuration:
- defaultvalue: https://api.intelgraph.idefense.com/
  display: URL
  name: url
  required: true
  type: 0
- defaultvalue: ''
  display: API Token
  name: api_token
  required: true
  type: 4
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ''
  display: Use system proxy settings
  name: useproxy
  required: false
  type: 8
description: Accenture Security
display: iDefense
image: data:image/png;base64,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
name: iDefense
script:
  commands:
  - arguments:
    - default: true
      description: IP to check
      name: ip
      required: true
    description: Check IP reputation
    name: ip
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      description: Domain to check
      name: domain
      required: true
    description: Check domain reputation
    name: domain
    outputs:
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      description: The URL to check (must start with "http://").
      name: url
      required: true
    description: Check URL reputation
    name: url
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      defaultValue: '300'
      description: Maximum amount of results
      name: max_result
    description: Get threats from iDefense database. Returns all records of ip/url/domain
    name: idefense-general
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      description: Unique User ID
      name: uuid
      required: true
    description: Get specific indicator reputation
    name: uuid
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  runonce: false
  script: "// handle '/' at the end of the url\nvar base_url = params.url.slice(0,\
    \ params.url.length - params.url.match('/*$')[0].length) + '/rest/';\n\nfunction\
    \ sendRequest(method, url_suffix, headers, body) {\n    headers = headers || {};\n\
    \    body = body || {};\n\n    // add default headers\n    if (!(\"Accept\" in\
    \ headers)) {\n        headers[\"Accept\"] = ['application/json'];\n    }\n  \
    \  if (!(\"Content-Type\" in headers)) {\n        headers['Content-Type'] = ['application/json'];\n\
    \    }\n    headers['Auth-Token'] = [params.api_token];\n\n    var res = http(\n\
    \        base_url + url_suffix,\n        {\n            Method: method,\n    \
    \        Headers: headers,\n            Body: JSON.stringify(body),\n        },\n\
    \        params.insecure,\n        params.useproxy\n    );\n\n    if (res.StatusCode\
    \ < 200 || res.StatusCode >= 300) {\n        throw 'Request Failed.\\nStatus code:\
    \ ' + res.StatusCode + '.\\nBody: ' + JSON.stringify(res) + '.';\n    }\n\n  \
    \  return res.Body.length !== 0 ? JSON.parse(res.Body) : {};\n}\n\nfunction calculate_dbot_score(severity)\
    \ {\n    // Calculate score based on severity\n    // Dbot Score   | severity\n\
    \    //  0           | 0\n    //  1           | 1,2\n    //  2           | 3,4\n\
    \    //  3           | 5,6,7\n    var dbot_score = 0;\n    if (severity > 4) {\n\
    \        dbot_score = 3;\n    } else if (severity > 2) {\n        dbot_score =\
    \ 2;\n    } else if (severity > 0) {\n        dbot_score = 1;\n    } else {\n\
    \        dbot_score = 0;\n    }\n\n    return dbot_score;\n}\n\nfunction get_full_data(cmd_url,\
    \ query, result_threshold) {\n    result_threshold = result_threshold || 300;\n\
    \    query = query || {};\n\n    var results = [];\n    var res;\n\n    query.page\
    \ = 1;\n    do {\n        res = sendRequest('GET', cmd_url + encodeToURLQuery(query));\n\
    \        if (res.total_size === 0) {\n            break;\n        }\n        results\
    \ = results.concat(res.results);\n        ++query.page;\n    } while ((res.more)\
    \ && (results.length < result_threshold));\n\n    return results;\n}\n\nfunction\
    \ check_threats(type, value, uniq_field, results) {\n    if (!results) {\n   \
    \     var cmd_url = 'threatindicator/v0/' + type.toLowerCase();\n        var query\
    \ = {'key.values' : value};\n        results = get_full_data(cmd_url, query);\n\
    \n        if (results.length === 0) {\n            return {results:[], md : [],\
    \ context: {}};\n        }\n    }\n\n    var dbot_context = [];\n    var result_context\
    \ = [];\n    var md = [];\n    for (var i in results) {\n        var r = results[i];\n\
    \        dbot_score = calculate_dbot_score(r.severity);\n\n        md.push({\n\
    \            Name : r.key,\n            'Dbot Reputation' : scoreToReputation(dbot_score),\n\
    \            confidence : r.confidence,\n            'Threat Types' : r.threat_types\n\
    \        });\n\n        dbot_context.push({\n            Indicator : r.key,\n\
    \            Type : type.toLowerCase(),\n            Vendor : 'iDefense',\n  \
    \          Score : dbot_score\n        });\n\n        if (dbot_score >= 2) {\n\
    \            var r_context = {\n                Malicious : {\n              \
    \      Vendor : 'iDefense',\n                    Description : 'last seen as '\
    \ + r.last_seen_as\n                }\n            };\n            r_context[uniq_field]\
    \ = r.key;\n            result_context.push(r_context);\n        }\n    }\n\n\
    \    var context_type = type + '(val.' + uniq_field + ' && val.' + uniq_field\
    \ + ' == obj.' + uniq_field + ')';\n    var context = {};\n    if (result_context.length\
    \ > 0) {\n        context[context_type] = result_context;\n    }\n\n    return\
    \ {\n        results : results,\n        md : md,\n        context : context,\n\
    \        scores : dbot_context\n\n    };\n}\nfunction sort_threats(results) {\n\
    \    var domains = [], urls = [], ips = [], others = [];\n\n    for (var i in\
    \ results) {\n        switch (results[i].type) {\n        case 'domain':\n   \
    \         domains.push(results[i]);\n            break;\n        case 'ip':\n\
    \            ips.push(results[i]);\n            break;\n        case 'url':\n\
    \            urls.push(results[i]);\n            break;\n        default:\n  \
    \          others.push(results[i]);\n        }\n    }\n\n    var domain_threats\
    \ = check_threats('Domain', undefined, 'Name', domains),\n        ip_threats =\
    \ check_threats('IP', undefined, 'Address', ips),\n        url_threats = check_threats('URL',\
    \ undefined, 'Data', urls);\n\n    var merged_md = domain_threats.md.concat(ip_threats.md).concat(url_threats.md);\n\
    \    var merged_scores = domain_threats.scores.concat(ip_threats.scores).concat(url_threats.scores);\n\
    \n    return {\n        Type : entryTypes.note,\n        Contents : results,\n\
    \        ContentsFormat : formats.json,\n        HumanReadable : tableToMarkdown('iDefense\
    \ Reputations', merged_md),\n        EntryContext : mergeForeignObjects([domain_threats.context,\
    \ ip_threats.context, url_threats.context, {DBotScore : merged_scores}])\n   \
    \ };\n\n}\n\nfunction get_threats(max_results) {\n    var cmd_url = 'threatindicator/v0/';\n\
    \    var results = get_full_data(cmd_url, {}, max_results);\n\n    return sort_threats(results);\n\
    }\n\nfunction get_domain(domain) {\n    var threats_info = check_threats('Domain',\
    \ domain, 'Name');\n    if (threats_info.results.length === 0) {\n        return\
    \ 'No result was found.';\n    }\n\n    return {\n        Type : entryTypes.note,\n\
    \        Contents : threats_info.results,\n        ContentsFormat : formats.json,\n\
    \        HumanReadable : tableToMarkdown('iDefense Domain Reputation', threats_info.md),\n\
    \        EntryContext : mergeForeignObjects([threats_info.context, {DBotScore\
    \ : threats_info.scores}])\n    };\n}\n\nfunction get_ip(ip) {\n    if (!isValidIP(ip))\
    \ {\n        return {Type: entryTypes.error, Contents: 'IP - ' + ip + ' is not\
    \ valid IP', ContentsFormat: formats.text};\n    }\n\n    var threats_info = check_threats('IP',\
    \ ip, 'Address');\n    if (threats_info.results.length === 0) {\n        return\
    \ 'No result was found.';\n    }\n\n    return {\n        Type : entryTypes.note,\n\
    \        Contents : threats_info.results,\n        ContentsFormat : formats.json,\n\
    \        HumanReadable : tableToMarkdown('iDefense IP Reputation', threats_info.md),\n\
    \        EntryContext : mergeForeignObjects([threats_info.context, {DBotScore\
    \ : threats_info.scores}])\n\n    };\n}\n\nfunction get_url(url) {\n    var threats_info\
    \ = check_threats('URL', url, 'Data');\n    if (threats_info.results.length ===\
    \ 0) {\n        return 'No result was found.';\n    }\n\n    return {\n      \
    \  Type : entryTypes.note,\n        Contents : threats_info.results,\n       \
    \ ContentsFormat : formats.json,\n        HumanReadable : tableToMarkdown('iDefense\
    \ URL Reputation', threats_info.md),\n        EntryContext : mergeForeignObjects([threats_info.context,\
    \ {DBotScore : threats_info.scores}])\n\n    };\n}\n\nfunction get_uuid(uuid)\
    \ {\n    var cmd_url = 'threatindicator/v0/' + uuid;\n    var res = sendRequest('GET',\
    \ cmd_url);\n\n    return sort_threats([res]);\n}\n\n// The command input arg\
    \ holds the command sent from the user.\nlogDebug('entering with command: ' +\
    \ command);\nswitch (command) {\n    case 'idefense-general':\n        // still\
    \ having issues with this command.\n        return get_threats(args.max_result);\n\
    \    case 'domain':\n        return get_domain(args.domain);\n    case 'ip':\n\
    \        return get_ip(args.ip);\n    case 'url':\n        return get_url(args.url);\n\
    \    case 'uuid':\n        // still having issues with this command.\n       \
    \ return get_uuid(args.uuid);\n    // This is the call made when pressing the\
    \ integration test button.\n    case 'test-module':\n        //check api_token\
    \ is valid\n        get_threats(1);\n        return 'ok';\n    default:\n    \
    \    break;\n}"
  type: javascript
toversion: 4.1.9
