category: Analytics & SIEM
commonfields:
  id: ArcSight Logger
  version: -1
configuration:
- defaultvalue: ''
  display: Server URL (e.g. https://192.168.0.1)*
  name: url
  required: true
  type: 0
- defaultvalue: '9000'
  display: Port
  name: port
  required: true
  type: 0
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: ''
  display: Events query
  name: eventsQuery
  required: false
  type: 0
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ''
  display: Credentials
  name: credentials
  required: false
  type: 9
description: ArcSight events logger
detaileddescription: "To use the integration, start a search session using as-search\
  \ command, both session id and search session id will be returned from the command.\
  \ \nUse these arguments to preform further filter on the search (e.g. as-drilldown)\
  \ or to request desired data (e.g. as-events). Eventually use as-close to close\
  \ the search session and clean data from the server.  \n\nDate/time format for as-search\
  \ command\nUse the following compliant date/time format in as-search parameters:\
  \ \nyyyy-MM-dd'T'HH:mm:ss.SSSXXX\nFor example, May 26 2014 at 21:49:46 PM could\
  \ have a format like one of the following:\nFormat in PDT: 2014-05-26T21:49:46.000-07:00\n\
  Format in UTC: 2014-05-26T21:49:46.000Z"
display: ArcSight Logger
image: data:image/png;base64,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
name: ArcSight Logger
script:
  commands:
  - arguments:
    - auto: PREDEFINED
      description: Indicates that the search should try to discover fields in the
        events found.
      name: discover_fields
      predefined:
      - 'true'
      - 'false'
    - description: 'The date and time string for the start time in the search time
        range. If startTime is provided, endTime must be present as well. Format:
        - InPDT:2014-05-26T21:49:46.000-07:00 - InUTC:2014-05-26T21:49:46.000Z '
      name: startTime
    - description: 'The date and time string for the end time in the search time range.
        If endTime is provided, startTime must be present as well. See Integration
        tips for correct date/time format. Format: - InPDT:2014-05-26T21:49:46.000-07:00
        - InUTC:2014-05-26T21:49:46.000Z '
      name: endTime
    - description: Comma separated list of fields. To be used to calculate summary
        when field_summary is true.
      name: summary_fields
    - auto: PREDEFINED
      description: Indicates to use the field summary.
      name: field_summary
      predefined:
      - 'true'
      - 'false'
    - auto: PREDEFINED
      description: Indicates the search is local only, and does not include peers.
        The default value for this parameter is 'true'.
      name: local_search
      predefined:
      - 'true'
      - 'false'
    - description: The search query string to filter/process the events.
      name: query
    - defaultValue: '120000'
      description: The number of milliseconds to keep the search after processing
        has stopped. Default timeout is 10 minutes.
      name: timeout
    - description: 'The number of days from from current time . Use to limit the search
        time range. '
      name: lastDays
    - description: The offset from the first even
      name: offset
    - defaultValue: '100'
      description: The length or number of events to retrieve. Maximum number is 10000.
        Default is 100.
      name: length
    - auto: PREDEFINED
      description: The sort direction based on event time. forward/backward (default
        is forward).
      name: dir
      predefined:
      - forward
      - backward
    - description: comma separated list of fields in the order to show. If not specified,
        all fields will be used
      name: fields
    description: Start a new search, wait until the search status is complete and
      then return the events. This command combine 3 commands - as-search, as-status,
      as-events
    name: as-search-events
  - arguments:
    - description: The Search Session ID returned from as-search command
      name: searchSessionId
      required: true
    - description: The Session ID returned from as-search command
      name: sessionId
      required: true
    description: Returns the latest status of the specified search.
    name: as-status
    outputs:
    - contextPath: ArcSightLogger.Status.Status
      description: "The search status. Can be any of starting, running, complete,\
        \ or error. If the specified search has not started yet, the status will be\
        \ \u201Cstarting\"."
    - contextPath: ArcSightLogger.Status.ResultType
      description: Indicates the type of the search results
    - contextPath: ArcSightLogger.Status.Hit
      description: The number of events found
    - contextPath: ArcSightLogger.Status.Scanned
      description: The number of events scanned.
    - contextPath: ArcSightLogger.Status.Elapsed
      description: The elapsed time of this search
    - contextPath: ArcSightLogger.Status.Message
      description: The message for the search. This will be used when there is an
        error in the local/peer search.
    - contextPath: ArcSightLogger.Status.SearchSessionId
      description: The search session id.
  - arguments:
    - description: The Search Session ID returned from as-search command
      name: searchSessionId
      required: true
    - description: The Session ID returned from as-search command
      name: sessionId
      required: true
    - description: The date and time string for the start time in the search time
        range. If startTime is provided, endTime needs to be present as well. See
        Integration tips for correct date/time format.
      name: startTime
    - description: The date and time string for the end time in the search time range.
        If endTime is provided, startTime needs to be present as well. See Integration
        tips for correct date/time format.
      name: endTime
    - description: 'The number of days from from current time . Use to limit the search
        time range. '
      name: lastDays
    description: Narrows-down the search results to the specified time range
    name: as-drilldown
  - arguments:
    - description: The Search Session ID returned from as-search command
      name: searchSessionId
      required: true
    - description: The Session ID returned from as-search command
      name: sessionId
      required: true
    - auto: PREDEFINED
      description: The sort direction based on event time. forward/backward (default
        is forward).
      name: dir
      predefined:
      - forward
      - backward
    - description: comma separated list of fields in the order to show. If not specified,
        all fields will be used
      name: fields
    - defaultValue: '100'
      description: The length or number of events to retrieve. Maximum number is 10000.
        Default is 100.
      name: length
    - description: The offset from the first even
      name: offset
    description: Returns the list of events found in the specified search.
    name: as-events
  - arguments:
    - description: The Session ID returned from as-search command
      name: sessionId
      required: true
    - description: The Search Session ID returned from as-search command
      name: searchSessionId
      required: true
    description: Stops the execution of the search and clears the search session data
      from the server.
    name: as-close
  - arguments:
    - description: The Session ID returned from as-search command
      name: sessionId
      required: true
    - description: The Search Session ID returned from as-search command
      name: searchSessionId
      required: true
    description: Stops the search operation but keeps the search session so that the
      search results can be narrowed down later
    name: as-stop
  - arguments:
    - auto: PREDEFINED
      description: Indicates that the search should try to discover fields in the
        events found.
      name: discover_fields
      predefined:
      - 'true'
      - 'false'
    - description: 'The date and time string for the start time in the search time
        range. If startTime is provided, endTime must be present as well. Format:
        - InPDT:2014-05-26T21:49:46.000-07:00 - InUTC:2014-05-26T21:49:46.000Z '
      name: startTime
    - description: 'The date and time string for the end time in the search time range.
        If endTime is provided, startTime must be present as well. See Integration
        tips for correct date/time format. Format: - InPDT:2014-05-26T21:49:46.000-07:00
        - InUTC:2014-05-26T21:49:46.000Z '
      name: endTime
    - description: Comma separated list of fields. To be used to calculate summary
        when field_summary is true.
      name: summary_fields
    - auto: PREDEFINED
      description: Indicates to use the field summary.
      name: field_summary
      predefined:
      - 'true'
      - 'false'
    - auto: PREDEFINED
      description: Indicates the search is local only, and does not include peers.
        The default value for this parameter is 'true'.
      name: local_search
      predefined:
      - 'true'
      - 'false'
    - description: The search query string to filter/process the events.
      name: query
    - defaultValue: '120000'
      description: The number of milliseconds to keep the search after processing
        has stopped. Default timeout is 10 minutes.
      name: timeout
    - description: 'The number of days from from current time . Use to limit the search
        time range. '
      name: lastDays
    description: In opposite to as-search-events, as-search-events waits until the
      search query is complete and returns the events, as-search initiates new logger
      search query, and returns sessionId and searchSessionId which should be used
      in other commands like as-status, as-stop, as-events, etc.
    name: as-search
  isfetch: true
  runonce: false
  script: "var serverURL = params.url;\nif (serverURL.slice(-1) === '/') {\n    serverURL\
    \ = serverURL.slice(0,-1);\n}\nvar SERVER_URL = serverURL + ':' + params.port\
    \ + '/';\nvar DAY_IN_MILLIS = 24*60*60*1000;\n\nfunction login(username, password)\
    \ {\n    var fullUrl = SERVER_URL + 'core-service/rest/LoginService/login';\n\n\
    \    var bodyObj = {\n        login: username,\n        password: password\n \
    \   };\n    var bodyString = encodeToURLQuery(bodyObj).substring(1);\n\n    var\
    \ req = {\n        Method: 'POST',\n        Headers: {\n            'Content-Type':\
    \ ['application/x-www-form-urlencoded']\n        },\n        Body: bodyString\n\
    \    };\n\n    var res = http(fullUrl, req, params.insecure, params.proxy);\n\
    \    if (res.StatusCode !== 200) {\n        throw 'Login failed. StatusCode: '\
    \ + res.StatusCode + (res.Body !== '' ? '. Error: ' + res.Body : '');\n    }\n\
    \n    var resBody = parseXML(res.Body);\n    if (!resBody.loginResponse.return)\
    \ {\n        throw 'Login to ArcSight Logger has failed - Session id is missing\
    \ from response';\n    }\n\n    var userSessionId = resBody.loginResponse.return;\n\
    \    return userSessionId;\n}\n\nfunction logout(userSessionId) {\n    if (!userSessionId)\
    \ {\n        throw 'Unable to preform logout from ArcSight Logger. Seesion id\
    \ is missing';\n    }\n    var fullUrl = SERVER_URL + 'core-service/rest/LoginService/logout';\n\
    \n    var bodyObj = {\n        authToken: userSessionId\n    };\n    var bodyString\
    \ = encodeToURLQuery(bodyObj).substring(1);\n\n    var req = {\n        Method:\
    \ 'POST',\n        Headers: {\n            'Content-Type': ['application/x-www-form-urlencoded']\n\
    \        },\n        Body: bodyString\n    };\n\n    var res = http(fullUrl, req,\
    \ params.insecure, params.proxy);\n    if (res.StatusCode !== 204) {\n       \
    \ throw 'Logout failed. StatusCode: ' + res.StatusCode + (res.Body !== '' ? '.\
    \ Error: ' + res.Body : '');\n    }\n}\n\nfunction getSearchEvents(userSessionId)\
    \ {\n    var events = getSearchEventsRequest(\n        userSessionId,\n      \
    \  args.query,\n        args.timeout,\n        args.startTime,\n        args.endTime,\n\
    \        args.discover_fields,\n        args.summary_fields,\n        args.field_summary,\n\
    \        args.local_search,\n        args.lastDays,\n        args.offset,\n  \
    \      args.dir,\n        args.length,\n        args.fields);\n\n    var entry\
    \ = {\n        Type: entryTypes.note,\n        Contents: events,\n        ContentsFormat:\
    \ formats.json,\n        ReadableContentsFormat: formats.markdown\n    };\n  \
    \  var title = 'ArcSight Logger - Events';\n    var context = events;\n    entry.HumanReadable\
    \ = tableToMarkdown(title, events);\n    entry.EntryContext = {};\n    entry.EntryContext['ArcSightLogger.Events(val.rowId\
    \ === obj.rowId)'] = context;\n    return entry;\n}\n\nfunction getSearchEventsRequest(userSessionId,\
    \ query, timeout, startTime,\n    endTime, discoverFields, summaryFields, fieldSummary,\
    \ localSearch, lastDays,\n    offset, dir, length, fields) {\n    // start new\
    \ search\n    var searchSessionId = startSearchSessionRequest(\n        userSessionId,\n\
    \        query,\n        timeout,\n        startTime,\n        endTime,\n    \
    \    discoverFields,\n        summaryFields,\n        fieldSummary,\n        localSearch,\n\
    \        lastDays);\n\n    // wait until the search is complete so we could collect\
    \ the events\n    var statusResult;\n    var requiredEvents = Infinity;\n    if(length){\n\
    \        requiredEvents = offset ? parseInt(length) + parseInt(offset) : parseInt\
    \ (length);\n    }\n    do {\n        wait(1);\n        statusResult = getSearchStatusRequest(userSessionId,\
    \ searchSessionId);\n        if (statusResult.status === 'error') {\n        \
    \    throw 'Invalid query.\\nSearch status: ' + JSON.stringify(statusResult, null\
    \ ,2);\n        }\n    } while(statusResult.status !== 'complete' && requiredEvents\
    \ > statusResult.hit);\n    // get the results\n    var events;\n    if (statusResult.result_type\
    \ === 'chart') {\n        events = getChartRequest(userSessionId, searchSessionId);\n\
    \    } else {\n        events = getEventsRequest(userSessionId, searchSessionId,\
    \ offset, dir, length, fields);\n    }\n    // close the session\n    closeSessionRequest(userSessionId,\
    \ searchSessionId);\n\n    logout(userSessionId);\n    return events;\n}\n\nfunction\
    \ startSearchSession(userSessionId) {\n    var searchSessionId = startSearchSessionRequest(\n\
    \        userSessionId,\n        args.query,\n        args.timeout,\n        args.startTime,\n\
    \        args.endTime,\n        args.discover_fields,\n        args.summary_fields,\n\
    \        args.field_summary,\n        args.local_search,\n        args.lastDays);\n\
    \n    var entry = {\n        Type: entryTypes.note,\n        Contents: {\n   \
    \         searchSessionId: searchSessionId,\n            sessionId : userSessionId\n\
    \        },\n        ContentsFormat: formats.json,\n        ReadableContentsFormat:\
    \ formats.markdown\n    };\n    var title = \"ArcSight Logger - Start Search Session\"\
    ;\n    var context = {\n        'SearchSessionId': searchSessionId,\n        'SessionId'\
    \ : userSessionId\n    };\n    entry.HumanReadable = tableToMarkdown(title, context);\n\
    \    entry.EntryContext = {};\n    entry.EntryContext['ArcSightLogger.Search']\
    \ = context;\n    return entry;\n}\n\nfunction startSearchSessionRequest(userSessionId,\
    \ query, timeout, startTime, endTime, discoverFields, summaryFields, fieldSummary,\
    \ localSearch, lastDays) {\n    var searchSessionId = generateSearchSessionId();\n\
    \    var bodyArgs = {\n        search_session_id: searchSessionId,\n        user_session_id:\
    \ userSessionId\n    };\n    if (query) {\n        bodyArgs.query = query;\n \
    \   }\n    if (timeout) {\n        bodyArgs.timeout = parseInt(timeout);\n   \
    \ }\n    if (lastDays) {\n        if (isNaN(lastDays)) {\n            throw 'LastDays\
    \ must be a number';\n        }\n        var ld = parseInt(lastDays);\n      \
    \  var now = new Date();\n        bodyArgs.end_time = now.toISOString();\n   \
    \     now.setTime(now.getTime() - ld * DAY_IN_MILLIS)\n        bodyArgs.start_time\
    \ = now.toISOString();\n    } else if (startTime && endTime) {\n        bodyArgs.end_time\
    \ = endTime;\n        bodyArgs.start_time = startTime;\n    }\n    if (discoverFields)\
    \ {\n        bodyArgs.discover_fields = parseBool(discoverFields);\n    }\n  \
    \  if (summaryFields) {\n        bodyArgs.summary_fields = parseArray(summaryFields);\n\
    \    }\n    if (fieldSummary) {\n        bodyArgs.field_summary = fieldSummary;\n\
    \    }\n    if (localSearch) {\n        bodyArgs.local_search = parseBool(localSearch);\n\
    \    }\n\n    var resBody = httpPost('server/search', null, bodyArgs);\n\n   \
    \ return searchSessionId;\n}\n\nfunction closeSession() {\n    closeSessionRequest(args.sessionId,\
    \ args.searchSessionId);\n    return {\n        Type: entryTypes.note,\n     \
    \   ContentsFormat: formats.text,\n        Contents: 'Session closed successfully'\n\
    \    };\n}\n\nfunction closeSessionRequest(userSessionId, searchSessionId) {\n\
    \    var bodyArgs = {\n        search_session_id: parseInt(searchSessionId),\n\
    \        user_session_id: userSessionId\n    };\n    httpPost('server/search/close',\
    \ null, bodyArgs);\n}\n\nfunction getSearchStatus() {\n    var searchStatus =\
    \ getSearchStatusRequest(args.sessionId, args.searchSessionId);\n    var contextKey\
    \ = 'ArcSightLogger.Status(val.SearchSessionId === obj.SearchSessionId)';\n  \
    \  var entry = createEntry(searchStatus, {\n        data: [\n            {to:\
    \ 'Status', from: 'status'},\n            {to: 'ResultType', from: 'result_type'},\n\
    \            {to: 'Hit', from: 'hit'},\n            {to: 'Scanned', from: 'scanned'},\n\
    \            {to: 'Elapsed', from: 'elapsed'},\n            {to: 'Message', from:\
    \ 'message'}\n        ],\n        title: 'ArcSight Logger - Search Status',\n\
    \        contextPath: contextKey\n    });\n    entry.EntryContext[contextKey]['SearchSessionId']\
    \ = args.searchSessionId;\n    return entry;\n}\n\nfunction getSearchStatusRequest(userSessionId,\
    \ searchSessionId) {\n    var bodyArgs = {\n        search_session_id: parseInt(searchSessionId),\n\
    \        user_session_id: userSessionId\n    };\n\n    var resBody = httpPost('server/search/status',\
    \ null, bodyArgs);\n    return resBody;\n}\n\nfunction getEvents() {\n    var\
    \ statusResult = getSearchStatusRequest(\n        args.sessionId,\n        args.searchSessionId);\n\
    \    var events;\n    if (statusResult.result_type === 'chart'){\n        events\
    \ = getChartRequest(\n            args.sessionId,\n            args.searchSessionId);\n\
    \    } else {\n       events = getEventsRequest(\n            args.sessionId,\n\
    \            args.searchSessionId,\n            args.offset,\n            args.dir,\n\
    \            args.length,\n            args.fields);\n    }\n    var entry = {\n\
    \        Type: entryTypes.note,\n        Contents: events,\n        ContentsFormat:\
    \ formats.json,\n        ReadableContentsFormat: formats.markdown\n    };\n  \
    \  var title = 'ArcSight Logger - Events';\n    var context = events;\n    entry.HumanReadable\
    \ = tableToMarkdown(title, events);\n    entry.EntryContext = {};\n    entry.EntryContext['ArcSightLogger.Events(val.rowId\
    \ === obj.rowId)'] = context;\n    return entry;\n}\n\nfunction getEventsRequest(userSessionId,\
    \ searchSessionId, offset, dir, length, fields) {\n    var bodyArgs = {\n    \
    \    search_session_id: parseInt(searchSessionId),\n        user_session_id: userSessionId\n\
    \    };\n    if (offset) {\n        bodyArgs.offset = parseInt(offset);\n    }\n\
    \    if (dir) {\n        bodyArgs.dir = dir;\n    }\n    if (length) {\n     \
    \   if (isNaN(length)) {\n            throw 'Length must be a number';\n     \
    \   }\n        bodyArgs.length = parseInt(length);\n    }\n    if (fields) {\n\
    \        bodyArgs.fields = fields.split(\",\");\n    }\n    var resBody = httpPost('server/search/events',\
    \ null, bodyArgs);\n    var events = xmlObjectToJSON(resBody);\n    return events;\n\
    }\n\nfunction getChartRequest(userSessionId, searchSessionId) {\n    var bodyArgs\
    \ = {\n        search_session_id: parseInt(searchSessionId),\n        user_session_id:\
    \ userSessionId\n    };\n    bodyArgs.offset = 0;\n    bodyArgs.length = 100;\n\
    \    var resBody = httpPost('/server/search/chart_data', null, bodyArgs);\n  \
    \  var events = xmlObjectToJSON(resBody);\n    return events;\n}\n\nfunction drilldown()\
    \ {\n    var result = drilldownRequest(args.sessionId, args.searchSessionId, args.startTime,\
    \ args.endTime, args.lastDays);\n    var entry = {\n        Type: entryTypes.note,\n\
    \        Contents: result,\n        ContentsFormat: formats.json,\n        ReadableContentsFormat:\
    \ formats.text,\n        HumanReadable: 'Success drilldown request'\n    };\n\
    \    return entry;\n}\n\nfunction drilldownRequest(userSessionId, searchSessionId,\
    \ startTime, endTime, lastDays) {\n    var bodyArgs = {\n        search_session_id:\
    \ parseInt(searchSessionId),\n        user_session_id: userSessionId\n    };\n\
    \    if (lastDays) {\n        if (isNaN(lastDays)) {\n            throw 'LastDays\
    \ must be a number';\n        }\n        var ld = parseInt(lastDays);\n      \
    \  var now = new Date();\n        bodyArgs.end_time = now.toISOString();\n   \
    \     now.setTime(now.getTime() - ld * DAY_IN_MILLIS)\n        bodyArgs.start_time\
    \ = now.toISOString();\n    } else if (startTime && endTime) {\n        bodyArgs.end_time\
    \ = endTime;\n        bodyArgs.start_time = startTime;\n    } else {\n       \
    \ throw 'Make sure lastDays is provided, or both startTime and endTime are provided'\n\
    \    }\n    var resBody = httpPost('server/search/drilldown', null, bodyArgs);\n\
    \    return resBody;\n}\n\nfunction stopSearch() {\n    stopSearchRequest(args.sessionId,\
    \ args.searchSessionId);\n    return {\n        Type: entryTypes.note,\n     \
    \   ContentsFormat: formats.text,\n        Contents: 'Search stopped successfully'\n\
    \    };\n}\n\nfunction stopSearchRequest(userSessionId, searchSessionId) {\n \
    \   var bodyArgs = {\n        search_session_id: parseInt(searchSessionId),\n\
    \        user_session_id: userSessionId\n    };\n\n    httpPost('server/search/stop',\
    \ null, bodyArgs);\n}\n\nfunction fetchIncidents() {\n    var userSessionId =\
    \ login(params.credentials.identifier, params.credentials.password);\n    var\
    \ lastRun = getLastRun();\n\n    var n = new Date();\n    var endTime = n.toISOString();\n\
    \    var startTime;\n    var query;\n    if (lastRun && lastRun.time && lastRun.time\
    \ !== '') {\n        startTime = lastRun.time;\n    } else {\n        n.setTime(n.getTime()\
    \ - 1 * DAY_IN_MILLIS);\n        startTime = n.toISOString();\n    }\n    if (params.eventsQuery){\n\
    \        query = params.eventsQuery;\n    }\n    var fields = null;\n    var events\
    \ = getSearchEventsRequest(userSessionId, query, 120000, startTime,\n        endTime,\
    \ null, null, null, false, null,\n        null, null, 100, fields);\n\n    var\
    \ incidents = [];\n    for (var i = 0; i < events.length; i++) {\n        var\
    \ incident = incidentFromEvent(events[i]);\n        incidents.push(incident);\n\
    \    }\n\n    setLastRun({ time: endTime });\n    return JSON.stringify(incidents);\n\
    }\n\nswitch(command) {\n    case 'test-module':\n        var userSessionId = login(params.credentials.identifier,\
    \ params.credentials.password);\n        logout(userSessionId);\n        return\
    \ 'ok';\n    case 'fetch-incidents':\n        return fetchIncidents();\n    case\
    \ 'as-search-events':\n        var userSessionId = login(params.credentials.identifier,\
    \ params.credentials.password);\n        return getSearchEvents(userSessionId);\n\
    \    case 'as-search':\n        var userSessionId = login(params.credentials.identifier,\
    \ params.credentials.password);\n        var result = startSearchSession(userSessionId);\n\
    \        return result;\n    case 'as-status':\n        var result = getSearchStatus();\n\
    \        return result;\n    case 'as-events':\n        return getEvents();\n\
    \    case 'as-close':\n        var result = closeSession();\n        logout(args.sessionId);\n\
    \        return result;\n    case 'as-stop':\n        return stopSearch();\n \
    \   case 'as-drilldown':\n        return drilldown();\n    default:\n        throw\
    \ 'Command ' + command + ' not exists';\n}\n\nfunction httpPost(path, queryObject,\
    \ body) {\n    var fullUrl = SERVER_URL + path;\n    if (queryObject) {\n    \
    \    fullUrl += encodeToURLQuery(queryObject)\n    }\n\n    var req = {\n    \
    \    Method: 'POST',\n        Headers: {\n            'Content-Type' : ['application/json;\
    \ charset=UTF-8'],\n            'Accept': ['appliction/json']\n        },\n  \
    \      Body: JSON.stringify(body)\n    }\n    var res = http(fullUrl, req, params.insecure,\
    \ params.proxy);\n\n    if (res.StatusCode < 200 || res.StatusCode >= 300) {\n\
    \        try {\n            var resBody = JSON.parse(res.Body);\n        } catch(e)\
    \ {\n            throw 'Request to ' + fullUrl + ' failed. StatusCode: ' + res.StatusCode\
    \ + (res.Body !== '' ? '. Error: ' + res.Body : '');\n        }\n        var errTbl\
    \ = resBody.errors;\n        var errMessage = '';\n        if (errTbl) {\n   \
    \         errTbl.forEach(function(err) {\n                if(err.message) {\n\
    \                    errMessage =  errMessage === '' ?  err.message : errMessage\
    \ + ', ' + err.message;\n                }\n            });\n        }\n     \
    \   throw 'Request to ' + fullUrl + ' failed. StatusCode: ' + res.StatusCode +\
    \ '. Error: ' + errMessage;\n    }\n    try {\n        return JSON.parse(res.Body);\n\
    \    } catch(err){\n        return res.Body;\n    }\n}\n\nfunction parseXML(httpResponseBody)\
    \ {\n    var body = httpResponseBody.replace(/&#x.*?;/g, \"\");\n    var parsed\
    \ = JSON.parse(x2j(body));\n    return parsed;\n}\n\nfunction parseBool(val) {\n\
    \    return val === 'true' ? true : false;\n}\n\nfunction generateSearchSessionId()\
    \ {\n    var sessID = new Date().getTime();\n    return sessID;\n}\n\nfunction\
    \ parseArray(commaSepList) {\n    return commaSepList.split(',');\n}\nfunction\
    \ xmlObjectToJSON(xmlObject) {\n    var context = [];\n    if (xmlObject && xmlObject.fields\
    \ && xmlObject.results) {\n        var keys = [];\n        var fields = xmlObject.fields;\n\
    \        var entries = xmlObject.results;\n        var isDateField = [];\n   \
    \     fields.forEach(function(field){\n            if(field.name){\n         \
    \       keys.push(field.name.replace(/\\s/g, '').replace(/^\\_/,''));\n      \
    \          isDateField.push(field.type == 'date');\n            }\n        });\n\
    \        entries.forEach(function(entry){\n            if (entry.length == keys.length){\n\
    \                var newEntry = {};\n                for (var i = 0; i<  entry.length;\
    \ i++){\n                    if (isDateField[i] && !isNaN(entry[i])) {\n     \
    \                   var dateEntry = new Date(0);\n                        dateEntry.setUTCSeconds(parseInt(entry[i])\
    \ / 1000);\n                        entry[i] = dateEntry.toISOString();\n    \
    \                }\n                    newEntry[keys[i]] = entry[i];\n      \
    \          }\n                context.push(newEntry);\n            }\n       \
    \ });\n    }\n    return context;\n}\n\nfunction incidentFromEvent(event){\n \
    \   var incident = {}\n    //incident.labels = Object.keys(event);\n    incident.rawJSON\
    \ = JSON.stringify(event);\n    var name = 'ArcSight Logger Incident';\n    name\
    \ = event.rowId ? name + ' ' + event.rowId : name;\n    incident.name = name;\n\
    \    return incident;\n}"
  type: javascript
toversion: 4.1.9
