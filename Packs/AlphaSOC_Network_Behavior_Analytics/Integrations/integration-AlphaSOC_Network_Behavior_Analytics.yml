category: Analytics & SIEM
commonfields:
  id: AlphaSOC Network Behavior Analytics
  version: -1
configuration:
- defaultvalue: https://api.alphasoc.net
  display: AlphaSOC Analytics Engine URL
  name: server
  required: true
  type: 0
- defaultvalue: ''
  display: AlphaSOC API Key
  name: APIKey
  required: true
  type: 4
- defaultvalue: '3'
  display: Ignore events below severity
  name: severity
  required: true
  type: 0
- defaultvalue: 'true'
  display: Include policy violations
  name: policy
  required: false
  type: 8
- defaultvalue: ''
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ''
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
description: Retrieve alerts from the AlphaSOC Analytics Engine
detaileddescription: 'Not using the AlphaSOC Analytics Engine?

  Review the deployment options at [https://www.alphasoc.com](https://www.alphasoc.com)'
display: AlphaSOC Network Behavior Analytics
image: data:image/png;base64,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
name: AlphaSOC Network Behavior Analytics
script:
  isfetch: true
  runonce: false
  script: "var API_PATH_ALERTS = '/v1/alerts';\n\nvar SERVER = params.server.replace(/[\\\
    /]+$/, '');\nvar API_KEY = params.APIKey;\n\nvar INSECURE = params.insecure;\n\
    var PROXY = params.proxy;\n\nvar INCLUDE_POLICY = params.policy;\nvar SEVERITY\
    \ = params.severity;\n\nfunction sendRequest(requestUrl) {\n    logInfo('Sending\
    \ HTTP request to: ' + requestUrl);\n\n    var response = http(\n        requestUrl,\n\
    \        {\n            Method: 'GET',\n            Headers: {\n             \
    \   Authorization: ['Basic ' + btoa(API_KEY + ':')],\n                Accept:\
    \ ['application/json']\n            }\n        },\n        INSECURE,\n       \
    \ PROXY\n    );\n\n    var errorString = validateRequestResponse(requestUrl, response);\n\
    \    if (errorString) {\n        throw errorString;\n    }\n\n    try {\n    \
    \    return JSON.parse(response.Body);\n    } catch (err) {\n        throw 'Failed\
    \ to parse JSON response: ' + response.Body;\n    }\n};\n\nfunction validateRequestResponse(requestUrl,\
    \ response) {\n    if (!response) {\n        return 'Error: Unexpected HTTP response\\\
    n\\nRequest URL: ' + requestUrl;\n    } else if (response.StatusCode < 200 ||\
    \ response.StatusCode >= 300) {\n        var errorString = '';\n\n        if (response.StatusCode\
    \ === 401 || response.StatusCode === 403) {\n            errorString = 'Error:\
    \ Invalid API key\\n';\n        } else if (response.StatusCode === 429) {\n  \
    \          errorString = 'Error: Too many requests\\n';\n        }\n\n       \
    \ try {\n            var body = JSON.parse(response.Body);\n            if (body\
    \ && body.message) {\n                errorString += '\\nMessage: ' + JSON.stringify(body.message);\n\
    \            }\n        } catch (err) {\n            errorString += '\\nCould\
    \ not parse response body';\n        }\n\n        errorString += '\\nRequest URL:\
    \ ' + requestUrl + '\\nStatus code: ' + response.StatusCode;\n        return errorString;\n\
    \    }\n\n    return null;\n}\n\nfunction createAlertsURL(follow) {\n    return\
    \ SERVER + API_PATH_ALERTS + '?follow=' + follow + '&threats=all';\n}\n\nfunction\
    \ parseFollow() {\n    var lastRun = getLastRun();\n    return lastRun && lastRun.follow\
    \ ? lastRun.follow : '0';\n}\n\nfunction saveFollow(follow) {\n    if (follow)\
    \ {\n        setLastRun({ follow: follow });\n    }\n}\n\nfunction testGetAlerts()\
    \ {\n    var response = sendRequest(createAlertsURL('0'));\n    return response\
    \ && response.alerts ? true : false;\n}\n\nfunction getAlerts(follow) {\n    var\
    \ response = sendRequest(createAlertsURL(follow));\n\n    return {\n        follow:\
    \ response.follow,\n        content: response.alerts,\n        threats: response.threats\n\
    \    }\n}\n\nfunction appendIncidentsFromAlert(incidents, alert, threats) {\n\
    \    if (!threats || !alert || !alert.threats) {\n        logInfo('Invalid alert\
    \ format or empty threats definition');\n        return;\n    }\n\n    var occurredTs\
    \ = getOccurredTs(alert);\n    for (var i = 0; i < alert.threats.length; i++)\
    \ {\n        var threatId = alert.threats[i];\n\n        var threat = threats[threatId];\n\
    \        if (!threat) {\n            logInfo('Error: Invalid alert content. Definition\
    \ for threat \"' + threatId + '\" not found');\n            continue;\n      \
    \  }\n\n        if (inScope(threat.severity, threat.policy)) {\n            alert.policy\
    \ = threat.policy === true ? true : false;\n\n            incidents.push({\n \
    \               'name': threat.title,\n                'occurred': occurredTs,\n\
    \                'severity': convertSeverity(threat.severity),\n             \
    \   'labels': getLabels(alert),\n                'rawJSON': JSON.stringify(alert)\n\
    \            });\n        }\n    }\n}\n\nfunction getOccurredTs(alert) {\n   \
    \ try {\n        return alert.event.ts;\n    } catch (exc) {\n        return null;\n\
    \    }\n}\n\nfunction getLabels(alert) {\n    var labels = [];\n    if (!alert)\
    \ {\n        return labels;\n    }\n\n    if (alert.eventType) {\n        labels.push(createLabelEntry('eventType',\
    \ alert.eventType));\n    }\n\n    if (alert.policy !== undefined && alert.policy\
    \ !== null) {\n        labels.push(createLabelEntry('policy', alert.policy));\n\
    \    }\n\n    if (alert.event) {\n        var eventKeys = Object.keys(alert.event);\n\
    \        for (var i = 0; i < eventKeys.length; i++) {\n            var eventKey\
    \ = eventKeys[i];\n            if (eventKey !== 'ts') {\n                labels.push(createLabelEntry(eventKey,\
    \ alert.event[eventKey]));\n            }\n        }\n    }\n\n    if (alert.wisdom)\
    \ {\n        var wisdomKeys = Object.keys(alert.wisdom);\n        for (var i =\
    \ 0; i < wisdomKeys.length; i++) {\n            var wisdomKey = wisdomKeys[i];\n\
    \            labels.push(createLabelEntry('wisdom.' + wisdomKey, alert.wisdom[wisdomKey]));\n\
    \        }\n    }\n\n    return labels;\n}\n\nfunction createLabelEntry(key, value)\
    \ {\n    return { 'type': key, 'value': String(value) };\n}\n\nfunction inScope(severity,\
    \ policy) {\n    var severityThereshold = getSeverityThereshold();\n    if (!severity\
    \ || severity < severityThereshold) {\n        return false;\n    }\n\n    if\
    \ (policy === true && !INCLUDE_POLICY) {\n        return false;\n    }\n\n   \
    \ return true;\n}\n\nfunction convertSeverity(severity) {\n    var demistoSeverity\
    \ = 0;\n\n    try {\n        demistoSeverity = severity === 1 ? .5 : severity\
    \ - 1;\n    } catch (exc) {\n        demistoSeverity = 0;\n    }\n\n    return\
    \ demistoSeverity < 0 || demistoSeverity > 4 ? 0 : demistoSeverity;\n}\n\nfunction\
    \ getSeverityThereshold() {\n    try {\n        var severity = parseInt(SEVERITY);\n\
    \    } catch (exc) {\n        var severity = NaN;\n    }\n\n    if (isNaN(severity)\
    \ || severity > 5) {\n        throw 'Error: Invalid severity parameter. Please\
    \ provide a number in range 0-5.';\n    }\n\n    return severity < 0 ? 0 : severity;\n\
    }\n\nswitch (command) {\n    case 'test-module':\n        try {\n            getSeverityThereshold();\n\
    \            return testGetAlerts() === true ? 'ok' : 'not ok';\n        } catch\
    \ (exc) {\n            return String(exc);\n        }\n    case 'fetch-incidents':\n\
    \        var follow = parseFollow();\n        var alerts = getAlerts(follow);\n\
    \n        var incidents = [];\n        if (alerts && alerts.content) {\n     \
    \       for (var i = 0; i < alerts.content.length; i++) {\n                appendIncidentsFromAlert(incidents,\
    \ alerts.content[i], alerts.threats);\n            }\n        }\n\n        saveFollow(alerts.follow);\n\
    \        return JSON.stringify(incidents);\n}\n"
  type: javascript
tests:
- No tests
toversion: 4.1.9
